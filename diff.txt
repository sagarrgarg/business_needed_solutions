diff --git a/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json b/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
index 7176925..bdbb05d 100644
--- a/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
+++ b/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
@@ -2,7 +2,7 @@
  "absolute_value": 0,
  "align_labels_right": 0,
  "creation": "2025-04-23 16:48:38.390423",
- "css": ".print-format {\n    margin-top:37mm;\n    margin-left: 2mm;\n    margin-right: 2mm;\n    /*height: 100% !important;*/\n    /*margin-bottom:5mm;*/\n}\n\n.print-heading{\n    border-bottom:1px solid #000;\n    margin-bottom:-5mm;\n    color:#000;\n    font-weight:bold;\n}\n\nh6{\n    font-weight: bold;\n    margin-top:0px;\n    margin-bottom:0px;\n}\n\n.no-border td {\n  border: none;\n  padding: 2px 4px;\n}\n\n.invoice-copy {\n  display: block;\n  font-size: 0.45rem;\n  margin-top: 3px;\n  margin-bottom: 6px;\n}\n\n\n.einv-det .col-xs-8.text-right .row.data-field {\n  /*margin-bottom: 4mm;*/\n  vertical-align: middle !important;\n  margin-left:0;\n  margin-right:0;\n  margin-top: 4mm;\n  margin-bottom:4mm;\n}\n\n.qrcode {\n  width: 50mm;\n  /*display: block;*/\n}\n\n.party-details-table {\n    /*table-layout: fixed;*/\n    width: 100%;\n    margin-bottom:auto;\n    padding-bottom:0;\n}\n.party-details-table td {\n    vertical-align: top;\n    /*padding: 8px;*/\n}\n\n.item-det{\n    margin:0;\n}\ntable{\n    margin:0 !important;\n}\n\n.item-det td,.item-det th{\n    text-align:center;\n    font-size:0.8em;\n    padding:0.2em !important;\n    vertical-align: middle !important;\n}\n\n.item-det .even td{\n    background-color: #f1f1f1;\n\n}\n.item-det .odd td {\n    background-color: #ffffff;\n}\n\n.item-det .item-det-item-name{\n    text-align:justify;\n    font-size:1em;\n    padding-left: 1mm !important;\n}\n\n.final-tax-total-table {\n  page-break-inside: avoid;\n  /*position: -webkit-sticky;*/\n  /*position: fixed;*/\n  margin-top:2mm;\n  /*bottom:0;*/\n  width:100%;\n}\n\n.no-preview-available {\n    color: grey;\n    font-size: 14px;\n}\n\n.page-footer-1 {\n    content: counter(page);\n    border-top:2px solid black;\n    margin-top: -35mm !important;\n    margin-bottom: -5mm !important;\n}\n\n#ewaybill-page-layout {\n    font-size: 12px;\n    width: 100%;\n    margin: 0;\n}\n\n#ewaybill-page-layout table{\n    font-size: 10px;\n    line-height:1.1;\n    width: 100%;\n    margin: 0;\n}\n\n.print-format table td img.barcode,\n.print-format table td img.qr-code {\n    /*margin-top: 5px;*/\n    width: 100px !important;\n    image-rendering: -webkit-optimize-contrast;\n}\n\n\n.watermark {\n  position: fixed;\n  top: 150mm;             /* push to vertical middle */\n  left: 0;            /* push slightly left */\n  width: 100%;\n  text-align: center;\n  font-size: 90px;\n  color: #000000;\n  opacity: 0.04;        /* light watermark */\n  -webkit-transform: rotate(-45deg);\n  -ms-transform: rotate(-45deg);\n  transform: rotate(-45deg);\n  z-index: 1000;\n}",
+ "css": ".print-format {\n    margin-top:37mm;\n    margin-left: 2mm;\n    margin-right: 2mm;\n    /*height: 100% !important;*/\n    /*margin-bottom:5mm;*/\n}\n\n.print-heading{\n    border-bottom:1px solid #000;\n    margin-bottom:-5mm;\n    color:#000;\n    font-weight:bold;\n}\n\nh6{\n    font-weight: bold;\n    margin-top:0px;\n    margin-bottom:0px;\n}\n\n.no-border td {\n  border: none;\n  padding: 2px 4px;\n}\n\n.invoice-copy {\n  display: block;\n  font-size: 0.45rem;\n  margin-top: 3px;\n  margin-bottom: 6px;\n}\n\n\n.einv-det .col-xs-8.text-right .row.data-field {\n  /*margin-bottom: 4mm;*/\n  vertical-align: middle !important;\n  margin-left:0;\n  margin-right:0;\n  margin-top: 4mm;\n  margin-bottom:4mm;\n}\n\n.qrcode {\n  width: 50mm;\n  /*display: block;*/\n}\n\n.party-details-table {\n    /*table-layout: fixed;*/\n    width: 100%;\n    margin-bottom:auto;\n    padding-bottom:0;\n}\n.party-details-table td {\n    vertical-align: top;\n    /*padding: 8px;*/\n}\n\n.item-det{\n    margin:0;\n}\ntable{\n    margin:0 !important;\n}\n\n.item-det td,.item-det th{\n    text-align:center;\n    font-size:0.8em;\n    padding:0.2em !important;\n    vertical-align: middle !important;\n}\n\n.item-det .even td{\n    background-color: #f1f1f1;\n\n}\n.item-det .odd td {\n    background-color: #ffffff;\n}\n\n.item-det .item-det-item-name{\n    text-align:justify;\n    font-size:1em;\n    padding-left: 1mm !important;\n    width:325px;\n    font-size:0.85em;\n}\n\n.final-tax-total-table {\n  page-break-inside: avoid;\n  /*position: -webkit-sticky;*/\n  /*position: fixed;*/\n  margin-top:2mm;\n  /*bottom:0;*/\n  width:100%;\n}\n\n.no-preview-available {\n    color: grey;\n    font-size: 14px;\n}\n\n.page-footer-1 {\n    content: counter(page);\n    border-top:2px solid black;\n    margin-top: -35mm !important;\n    margin-bottom: -5mm !important;\n}\n\n#ewaybill-page-layout {\n    font-size: 12px;\n    width: 100%;\n    margin: 0;\n}\n\n#ewaybill-page-layout table{\n    font-size: 10px;\n    line-height:1.1;\n    width: 100%;\n    margin: 0;\n}\n\n.print-format table td img.barcode,\n.print-format table td img.qr-code {\n    /*margin-top: 5px;*/\n    width: 100px !important;\n    image-rendering: -webkit-optimize-contrast;\n}\n\n\n.watermark {\n  position: fixed;\n  top: 150mm;             /* push to vertical middle */\n  left: 0;            /* push slightly left */\n  width: 100%;\n  text-align: center;\n  font-size: 90px;\n  color: #000000;\n  opacity: 0.04;        /* light watermark */\n  -webkit-transform: rotate(-45deg);\n  -ms-transform: rotate(-45deg);\n  transform: rotate(-45deg);\n  z-index: 1000;\n}",
  "custom_format": 1,
  "default_print_language": "en",
  "disabled": 0,
@@ -10,20 +10,20 @@
  "docstatus": 0,
  "doctype": "Print Format",
  "font_size": 14,
- "html": "{%- from \"templates/print_formats/standard_macros.html\" import add_header, render_field, print_value -%}\n\n{% set e_invoice_log = None %}\n{% if doc.irn %}\n{% set e_invoice_log = frappe.db.get_value(\n        \"e-Invoice Log\", doc.irn, (\"invoice_data\", \"signed_qr_code\"), as_dict=True\n    ) %}\n{% set invoice_data = e_invoice_log and e_invoice_log.invoice_data and _dict(json.loads(e_invoice_log.invoice_data)) or None %}\n{% endif %}\n\n{% macro format_address(address) %}\n{% if address %}\n<p>\n    {{ address.address_line1 }}\n    {% if address.address_line2 %}\n    {{ address.address_line2 }}<br>\n    {% endif %}\n    {{ address.city }}, {{ address.state }}, {{ address.country }}: {{ address.pincode }}<br>\n</p>\n{% endif %}\n{% endmacro %}\n\n{% set bns_settings = frappe.get_doc(\"BNS Settings\") %}\n{% set base_currency = frappe.db.get_value(\"Company\", doc.company, \"default_currency\") %}\n\n{% set copy_map = {\n    \"1\": \"Original for Recipient\",\n    \"2\": \"Duplicate for Transporter\",\n    \"3\": \"Duplicate for Supplier\",\n    \"4\": \"Triplicate for Supplier\"\n} %}\n\n{% set invoice_copy_param = frappe.form_dict.get(\"invoice_copy\") or \"1\" %}\n{% set invoice_copy_text = copy_map.get(invoice_copy_param, \"Original for Recipient\") %}\n\n\n<!--<div class=\"watermark text-center\">MEVABITE</div>-->\n\n<!--<div class=\"page\">-->\n\n\n<div id=\"header-html\">\n    <div class=\"watermark\">{{ invoice_copy_text }}</div>\n    <div class=\"row print-heading\" style=\"line-height:1.1;padding:10px\">\n        <div class=\"col-xs-3 column-break\">\n            {% set company_logo = frappe.db.get_value(\"Company\", doc.company, \"logo_for_printing\") %}\n            {% if company_logo %}\n            <div>\n                <img height=\"125px\" width=\"150px\" src=\"{{ company_logo }}\">\n            </div>\n            {% endif %}\n        </div>\n        <div class=\"col-xs-6 column-break text-center\">\n            <h3 style=\"margin-bottom:0;\"><b>{{ doc.company }}</b></h3>\n            {% if frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\") %}\n                <div style=\"font-size:0.85em;\">Previously Known As: {{frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\")}}</div>\n            {% endif %}\n            <div style=\"font-size:0.85rem\">\n                {% set seller_address = frappe.db.get_value(\"Address\", doc.company_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                    {{ format_address(seller_address) }}\n                    {% if doc.company_gstin %}\n                    GST: {{ doc.company_gstin }}<br>\n                    {% endif %}\n                    <p>PAN: {{ frappe.db.get_value(\"Company\", doc.company, \"pan\") }}</p>\n                \n            </div>\n        </div>\n        <div class=\"col-xs-3 column-break text-right\">\n            <h2 style=\"margin-top:5mm;\"><b>\n                    {% if doc.status == \"Cancelled\" and doc.is_return %}\n                        Cancelled Credit Note\n                    {% elif doc.status == \"Cancelled\" %}\n                        Cancelled Invoice\n                    {% elif doc.status == \"Draft\" and doc.is_return %}\n                        Draft Credit Note\n                    {% elif doc.status == \"Draft\" %}\n                        Draft Invoice\n                    {% elif doc.is_return %}\n                        Credit Note\n                    {% elif doc.irn %}\n                        e-Invoice\n                    {% else %}\n                        Tax Invoice\n                    {% endif %}\n                </b>\n            </h2>\n            <div class=\"invoice-meta\">\n              <table class=\"table-condensed no-border\" style=\"width:100%; font-size:0.9em; text-align:left;\">\n                <tr>\n                  <td><b>Invoice Date:</b></td>\n                  <td>{{ frappe.utils.formatdate(doc.posting_date) }}</td>\n                </tr>\n                <tr>\n                  <td><b>Invoice No:</b></td>\n                  <td><b>{{ doc.name }}</b></td>\n                </tr>\n              </table>\n            </div>\n        </div>\n    </div>\n</div>\n\n{% if doc.irn %}\n<div class=\"einv-det\">\n    <!--<div class=\"col-xs-2 column-break text-left\"></div>-->\n    <div class=\"col-xs-4 column-break text-left\">\n        {% if e_invoice_log and e_invoice_log.signed_qr_code %}\n        <img class=\"qrcode\" src=\"data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}\">\n        {% endif %}\n    </div>\n    <div class=\"col-xs-8 column-break text-right\">\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>IRN</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.irn }}</u></div>\n        </div>\n        {% if invoice_data and invoice_data.AckNo %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. No.</label></div>\n            <div class=\"col-xs-8 value\">{{ invoice_data.AckNo }}</div>\n        </div>\n        {% endif %}\n        {% if invoice_data and invoice_data.AckDt %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. Date</label></div>\n            <div class=\"col-xs-8 value\">{{ frappe.utils.format_datetime(invoice_data.AckDt, \"dd/MM/yyyy hh:mm:ss\") }}</div>\n        </div>\n        {% endif %}\n        {% if doc.ewaybill %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>e-Waybill No.</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.ewaybill }}</u></div>\n        </div>\n        {% endif %}\n    </div>\n    <!--<div class=\"col-xs-1 column-break text-right\">-->\n    </div>\n{% endif %}\n\n<table class=\"table table-bordered party-details-table\">\n    <tbody>\n        <tr>\n            <td colspan=3 rowspan=4 style=\"width:45%;\">\n                {% set contact_person = frappe.db.get_value(\n            \"Contact\", doc.contact_person, (\"mobile_no\"), as_dict=True\n        ) %}\n                <h6><b><u>Buyer Details</u></b></h6>\n                <p><b>{{ doc.customer_name }}</b></p>\n                {% set customer_address = frappe.db.get_value(\"Address\", doc.customer_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(customer_address) }}\n\n                {% if doc.billing_address_gstin %}\n                GST: <u>{{ doc.billing_address_gstin }}</u><br>\n                {% endif %}\n                {% set customer_pan = frappe.db.get_value(\"Customer\", doc.customer_name, \"pan\")%}\n                {% if customer_pan %}\n                PAN: {{ customer_pan }}<br>\n                {% endif %}\n                {% if contact_person.mobile_no %}\n                Phone No: {{ contact_person.mobile_no }}\n                {% endif %}\n                {% if doc.shipping_address %}\n                <br>\n                <h6><b><u>Shipping Details</u></b></h6>\n                {% set shipping_address = frappe.db.get_value(\"Address\", doc.shipping_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(shipping_address) }}\n                {% if shipping_address.gstin %}\n                GST: <u>{{ shipping_address.gstin }}</u><br>\n                {% endif %}\n                {% endif %}\n                {% if doc.dispatch_address %}\n                <h6><b><u>Dispatch Details</u></b></h6>\n                <p><b>{{ frappe.db.get_value(\"Address\", doc.dispatch_address_name, \"address_title\") }}</b></p>\n                <!--<p>{{doc.dispatch_address}}</p>-->\n                {% set dispatch_address = frappe.db.get_value(\"Address\", doc.dispatch_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                {{ format_address(dispatch_address) }}\n                {% endif %}\n            </td>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Transporter:</h6>\n                {% if doc.transporter_name %}\n                {{ doc.transporter_name }} <br>\n                {{ doc.gst_transporter_id }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Vehicle No:</h6>\n                {% if doc.vehicle_no %}\n                {{ doc.vehicle_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Builty No:</h6>\n                {% if doc.custom_builty_no %}\n                {{ doc.custom_builty_no }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1>\n                <h6>Place Of Supply</h6>\n                {{ doc.place_of_supply }}\n            </td>\n            {% if not doc.irn and doc.ewaybill %}\n            <td colspan=1>\n                <h6>e-Waybill No.</h6>\n                <u>{{ doc.ewaybill }}</u>\n            </td>            \n            {% endif %}\n            <td colspan=1>\n                <h6>Buyer's PO No:</h6>\n                {% if doc.po_no %}\n                {{ doc.po_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>PO Date:</h6>\n                {% if doc.po_date %}\n                {{ doc.po_date }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% if doc.incoterm or doc.named_place  %}\n        <tr>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Incoterm:</h6>\n                {% if doc.incoterm %}\n                {{ doc.incoterm }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=2>\n                <h6>Named Place:</h6>\n                {% if doc.named_place %}\n                {{ doc.named_place }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% endif %}\n        <tr>\n            <td colspan=1>\n                \n                <h6>Destination:</h6>\n                {% if doc.custom_destination %}\n                {{doc.custom_destination}}\n                {% else %}<br>{% endif %}\n            </td>\n            <td rowspan=2 colspan=\"{{ 3 if (not doc.irn and doc.ewaybill) else 2 }}\">\n                <h6>Terms of Delivery:</h6>\n                {% if doc.custom_terms_of_delivery %}\n                {{ doc.custom_terms_of_delivery }}\n                {% elif doc.custom_terms_of_delivery_new %}\n                {{ doc.custom_terms_of_delivery_new }}\n                {% else %}<br><br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1 rowspan=1>\n                <h6>Doc No:</h6>\n                {% if doc.custom_doc_no %}\n                {{doc.custom_doc_no}}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n\n<table class=\"table table-bordered item-det\">\n<thead>\n    <tr>\n        <th colspan=\"2\">#</th>\n        <th colspan=\"24\">Item</th>\n        <th colspan=\"7\">HSN/SAC</th>\n        <th colspan=\"7\">Qty</th>\n        {% if bns_settings.rate_excl_tax %}\n        <th colspan=\"9\">Rate(Exc Tax)</th>\n        {% endif %}\n        {% if doc.is_print_gst_rate_per_row %}\n        <th colspan=\"4\">GST</th>\n        {% endif %}\n        {% if bns_settings.rate_incl_tax %}\n        <th colspan=\"9\">Rate(Inc Tax)</th>\n        {% endif %}\n        {% if bns_settings.discount_type == \"Triple Compounded\" %}\n        <th colspan=\"4\">D1</th>\n        <th colspan=\"4\">D2</th>\n        <th colspan=\"4\">D3</th>\n        {% else %}\n        <th colspan=\"4\">Disc</th>\n        {% endif %}\n        {% if bns_settings.is_item_amount_tax_incl %}\n        <th colspan=\"11\">Amount(Incl)</th>\n        {% else %}\n        <th colspan=\"11\">Amount(Excl)</th>\n        {% endif %}\n    </tr>\n</thead>\n\n    <tbody>\n        {% for item in doc.items %}\n        <tr class=\"no-break {{ 'odd' if loop.index is odd else 'even' }}\">\n            <td colspan=\"2\">{{ loop.index }}</td>\n            <td colspan=\"24\" class=\"item-det-item-name\">\n                <b>{% if bns_settings.show_item_code or doc.bns_show_item_code %}{{ item.item_code }}:{% endif %}{{ item.item_name }}</b><br>\n                {% if item.barcode and (doc.bns_show_item_barcode or bns_settings.bns_show_item_barcode) %}\n                <p style=\"font-size:0.75em;\">\n                    EAN: {{ item.barcode }}\n                </p>\n                {% endif %}\n            </td>\n            <td colspan=\"7\">{{ item.gst_hsn_code }}</td>\n            <td colspan=\"7\">\n                <b>\n                    <span>{{ item.qty }} {{ item.uom }}</span>\n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <small style=\"font-size:0.7em;\">{{ (item.conversion_factor * item.qty / print_uom_conversion ) | int }} {{ print_uom }} </small>\n                                \n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <br>\n                                <small style=\"font-size:0.6em;\">{{ item.total_weight }} Kg</small>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <br>\n                                <small style=\"font-size:0.7em;\">{{ item.total_weight / 1000 }} Kg</small>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% if doc.taxes[0].included_in_print_rate == 1 %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set inclusive_rate = item.base_price_list_rate %}\n                {% set exclusive_rate = inclusive_rate*100/(100+gst_rate) %}\n            \n            {% else %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set exclusive_rate = item.base_price_list_rate %}\n                {% set inclusive_rate = exclusive_rate*(100+gst_rate)/100 %}\n            \n            {% endif %}\n            \n            {% if bns_settings.rate_excl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {% if doc.is_print_gst_rate_per_row %}\n                <td colspan=\"4\">{{ gst_rate | round(0) | int }}%</td>\n            {% endif %}\n            \n            {% if bns_settings.rate_incl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {# --- Step 1: Calculate / Fix discount_percentage if needed --- #}\n            {% if item.discount_percentage == 0 and item.base_price_list_rate and item.base_rate and item.base_price_list_rate != item.base_rate %}\n                {% set manual_discount = ((item.base_price_list_rate - item.base_rate) * 100) / item.base_price_list_rate %}\n                {% set item_discount = \"{:.2f}\".format(manual_discount|float) %}\n            {% else %}\n                {% set item_discount = item.discount_percentage %}\n            {% endif %}\n            \n            {# --- Step 2: Render depending on discount_type --- #}\n            {% if bns_settings.discount_type != \"Single\" %}\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if (item.custom_d1_ == 0.0 and not item_discount) else (item.custom_d1_ if item.custom_d1_ != 0.0 else item_discount) ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d2_ == 0.0 else item.custom_d2_ ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d3_ == 0.0 else item.custom_d3_ ~ '%' }}\n                </td>\n            {% else %}\n                <td colspan=\"4\">{{ item_discount }}%</td>\n            {% endif %}\n            \n            \n            {% if bns_settings.is_item_amount_tax_incl %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount*(1+(gst_rate/100))), currency=base_currency) }}</b></td>\n            {% else %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount), currency=base_currency) }}</b></td>\n            {% endif %}\n        </tr>\n        {% endfor %}\n    </tbody>\n</table>\n\n<div class=\"final-tax-total-table\">\n    <table class=\"table table-bordered\">\n        <tbody>\n            <tr>\n                <td rowspan=1 colspan=5 style=\"vertical-align:top !important; width:45%;\" class=\"text-center\"><b>Bank Details</b></td>\n                <td class=\"text-right\" colspan=2><b>Total Taxable Value</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(doc.base_net_total), currency=base_currency) }}\n                </td>\n            </tr>\n    \n            {# --- calculate extra rows count --- #}\n            {% set taxes_count = doc.taxes | length %}\n            {% set extra_rows = taxes_count %}\n            {% if doc.discount_amount %}\n                {% set extra_rows = extra_rows + 1 %}\n            {% endif %}\n            {# +1 for Grand Total, +1 for Amount in words #}\n            {% set total_rows = extra_rows + 2 %}\n    \n            <tr>\n                <td class=\"text-center\" rowspan={{ total_rows+1 }} colspan=5 style=\"vertical-align:top !important;\">\n                    {% set bank_account = frappe.db.get_value(\"Bank Account\", {\"company\": doc.company, \"is_default\": 1}, [\"account_name\",\"bank\", \"bank_account_no\", \"branch_code\",\"iban\"], as_dict=True) %}\n                    {% if bank_account.account_name %}\n                    Account Name: <b><i>{{ bank_account.account_name }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank %}\n                    Bank Name: <b><i>{{ bank_account.bank }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank_account_no %}\n                    Account Number: <b><i>{{ bank_account.bank_account_no }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.branch_code %}\n                    Branch Code (IFSC): <b><i>{{ bank_account.branch_code }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.iban %}\n                    IBAN: <b><i>{{ bank_account.iban }}</i></b><br>\n                    {% endif %}\n                </td>\n            </tr>\n    \n            {# --- loop through Sales Taxes & Charges rows --- #}\n            {% for tax_row in doc.taxes %}\n            <tr>\n                <td class=\"text-right\" colspan=2 style=\"font-size:0.8em;\">\n                    <b>{{ tax_row.description or tax_row.account_head }}</b>\n                </td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(tax_row.base_tax_amount), currency=base_currency) }}\n                </td>\n            </tr>\n            {% endfor %}\n    \n            {% if doc.discount_amount %}\n            <tr>\n                <td class=\"text-right\" colspan=2>Additional Discount</td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_discount_amount, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            {% endif %}\n    \n            <tr>\n                <td class=\"text-right\" colspan=2><b>Grand Total</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_rounded_total, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            <tr>\n                <td colspan=4>\n                    <b>Amount (in words): </b><span style=\"font-size:0.85em\">{{ doc.base_in_words }}</span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n    \n    {{ doc.gst_breakup_table }}\n    {% if doc.is_print_gst_table %}\n    \n    {% set gst_summary = {} %}\n    {% set gst_flags = {\"uses_igst\": false, \"uses_cgst_sgst\": false} %}\n        \n        {% for item in doc.items %}\n            {% set gst_rate = (frappe.db.get_value(\"Item Tax Template\", {\"name\": item.item_tax_template}, \"gst_rate\") or 0) | float %}\n            {% set key = gst_rate|string %}\n        \n            {% if item.igst_amount %}\n                {% set _ = gst_flags.update({\"uses_igst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"igst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"igst_amount\": gst_summary[key].igst_amount + item.igst_amount\n                }) %}\n            {% elif item.cgst_amount and item.sgst_amount %}\n                {% set _ = gst_flags.update({\"uses_cgst_sgst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"cgst_amount\": 0,\n                        \"sgst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"cgst_amount\": gst_summary[key].cgst_amount + item.cgst_amount,\n                    \"sgst_amount\": gst_summary[key].sgst_amount + item.sgst_amount\n                }) %}\n            {% endif %}\n        {% endfor %}\n        \n        <h4>GST Summary</h4>\n        <table class=\"table table-bordered table-hover\" style=\"text-align: center;\">\n            <thead>\n                <tr>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">GST RATE</th>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">Taxable Value</th>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">CGST</th>\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">SGST/UTGST</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">IGST</th>\n                    {% endif %}\n                </tr>\n                <tr>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% endif %}\n                </tr>\n            </thead>\n            <tbody>\n                {% for row in gst_summary.values() %}\n                    <tr>\n                        <td>{{ row.gst_rate }}%</td>\n                        <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.taxable_value), currency=doc.currency) }}</td>\n        \n                        {% if gst_flags.uses_cgst_sgst %}\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.cgst_amount), currency=doc.currency) }}</td>\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.sgst_amount), currency=doc.currency) }}</td>\n                        {% elif gst_flags.uses_igst %}\n                            <td>{{ row.gst_rate }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.igst_amount), currency=doc.currency) }}</td>\n                        {% endif %}\n                    </tr>\n                {% endfor %}\n            </tbody>\n        </table>\n    \n    \n    {% endif %}\n    \n    \n    <table class=\"table table-bordered\" style=\" table-layout: fixed; border-collapse: collapse; width:100%; text-align:center; font-size:12px;\">\n        <tr rowspan=1>\n            <td rowspan=1 colspan=4>\n                <b>{% if doc.is_print_payment_terms==1%} Payment Terms {% endif %}</b>\n            </td>\n            <td colspan=4>\n                <b>Pre Authenticated By: {{doc.company}}</b>\n            </td>\n        </tr>\n        <tr>\n            <td colspan=4 rowspan=3>\n            {% if doc.payment_schedule and doc.is_print_payment_terms==1 %}\n            <table class=\"payment_terms_table\" style=\"width: 100%; border-collapse: collapse;\">\n                <thead>\n                    <tr>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Due Date</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Invoice Portion</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Payment Amount</b></th>\n    \n                    </tr>\n                </thead>\n                <tbody>\n                    {% for row in doc.payment_schedule %}\n                    <tr>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.due_date }}</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.invoice_portion }}%</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ frappe.utils.fmt_money(row.payment_amount, currency=\"INR\") }}</td>\n                    </tr>\n                    {% endfor %}\n                </tbody>\n            </table>\n            {% endif %}\n            </td>\n            <td colspan=4>\n                Issuing Signatory\n            </td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left\">\n                Name:\n            </td>\n            <td colspan=3></td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left;\">\n                Designation:\n            </td>\n            <td colspan=3></td>\n        </tr>\n    </table>\n\n</div>\n\n{% if doc.ewaybill %}\n    {% set e_waybill_data = frappe.db.get_value(\"e-Waybill Log\", {\"reference_name\": doc.name, \"reference_doctype\": \"Sales Invoice\"}, \"data\") %}\n    <div class=\"page-break\"></div>\n    {% set data = _dict(json.loads(e_waybill_data)) %}\n    {%- set irn = doc.irn -%}\n\n    {% if data.supplyType == \"O\" %}\n    {% set generated_by = data.fromTrdName %}\n    {% else %}\n    {% set generated_by = data.toTrdName %}\n    {% endif %}\n\n    <div id=\"ewaybill-page-layout\">\n        <table class=\"table borderless\" style=\"border:0\">\n            <tbody>\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <h3 class=\"title\">e-Waybill</h1>\n                    </td>\n                </tr>\n\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img src=\"data:image/png;base64,{{ get_e_waybill_qr_code(data.ewbNo,data.userGstin, data.ewayBillDate) }}\" class=\"qr-code\" />\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n\n        <table class=\"table borderless\">\n            <tbody>\n                <tr>\n                    <td>\n                        <span>e-Waybill No:</span>\n                    </td>\n                    <td>\n                        <span class=\"e-waybill-number\">\n                            <strong>{{ add_spacing(data.ewbNo, 4) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>e-Waybill Date:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \"\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Generated By:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>\n                                {{ add_spacing(data.userGstin, 5) }} - {{ generated_by }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid From:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \" \") }}\n                                {{ \" [\" }}{{ data.actualDist }}{{ \"Kms]\" }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid Until:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.validUpto[:10] }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if irn %}\n                <tr>\n                    <td>\n                        <span>IRN:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ irn }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - A</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Supplier</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.fromGstin, 5) }}-{{ data.fromTrdName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Dispatch</td>\n                    <td>\n                        <span>\n                            <strong>{{ data.fromPlace }},\n                                {{ get_state(data.actFromStateCode) }} -\n                                {{ data.fromPincode }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Recipient</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.toGstin, 5) }}-{{ data.toTrdName }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Delivery</td>\n                    <td>\n                        <span><strong>\n                                {{ data.toPlace }},\n                                {{ get_state(data.actToStateCode) }} -{{ data.toPincode }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document No.</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docNo }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document Date</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docDate }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Transaction Type:</span>\n                    </td>\n                    <td>\n                        <span><strong>{{ get_transport_type(data.transactionType) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Value of Goods</td>\n                    <td>\n                        <span class=\"classfont\">\n                            <strong>\n                                {{ frappe.utils.fmt_money(data.totInvValue, currency=\"INR\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>HSN Code</td>\n                    <td>\n                        <span class=\"form-control1\" onkeydown=\"expandtext(this);\">\n                            <strong>{{ data.itemList[0].hsnCode }}\n                                {%if data.itemList[0].productDesc%}\n                                {{ \" - \" ~data.itemList[0].productDesc }}\n                                {%endif%}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Reason for Transportation</td>\n                    <td>\n                        <span>\n                            <strong>{{ get_supply_type(data.supplyType) }} - {{ get_sub_supply_type(data.subSupplyType) }} </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Transporter</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.transporterId, 5) }}-\n                                {{ data.transporterName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if data.VehiclListDetails|length > 0 %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - B</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div>\n                            <table cellspacing=\"0\" cellpadding=\"3\" rules=\"all\" class=\"table table-responsive vehicle-info\" border=\"1\">\n                                <tbody>\n                                    <tr>\n                                        <th scope=\"col\">Mode</th>\n                                        <th scope=\"col\">\n                                            Vehicle / Trans <br />\n                                            Doc No &amp; Dt.\n                                        </th>\n                                        <th scope=\"col\">From</th>\n                                        <th scope=\"col\">Entered Date</th>\n                                        <th scope=\"col\">Entered By</th>\n                                        <th scope=\"col\">\n                                            Cdata No. <br />\n                                            (If any)\n                                        </th>\n                                        <th scope=\"col\">\n                                            Multi Veh.Info <br />\n                                            (If any)\n                                        </th>\n                                    </tr>\n                                    {% for detail in data.VehiclListDetails %}\n                                    <tr>\n                                        <td>\n                                            {{ get_transport_mode(detail.transMode) }}\n                                        </td>\n                                        <td>\n                                            {{ detail.vehicleNo }} /\n                                            {{ detail.transDocNo }} Dt:\n                                            {{ detail.transDocDate }}\n                                        </td>\n                                        <td>{{ detail.fromPlace }}</td>\n                                        <td>\n                                            {{ detail.enteredDate |\n                                                replace(\":00 \", \" \") }}\n                                        </td>\n                                        <td>{{ detail.userGSTINTransin }}</td>\n                                        <td>-</td>\n                                        <td>-</td>\n                                    </tr>\n                                    {% endfor%}\n                                </tbody>\n                            </table>\n                        </div>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img class=\"barcode\" src=\"data:image/png;base64,{{ get_ewaybill_barcode(data.ewbNo) }}\">\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    {% endif %}\n\n\n\n\n\n<div id=\"footer-html\">\n    <div class=\"text-center small page-footer-1\">\n        {{ _(\"Page {0} of {1}\").format('<span class=\"page\"></span>', '<span class=\"topage\"></span>') }}<br>This is a computer generated document and does not require a signature.\n    </div>\n</div>\n",
+ "html": "{%- from \"templates/print_formats/standard_macros.html\" import add_header, render_field, print_value -%}\n\n{% set e_invoice_log = None %}\n{% if doc.irn %}\n{% set e_invoice_log = frappe.db.get_value(\n        \"e-Invoice Log\", doc.irn, (\"invoice_data\", \"signed_qr_code\"), as_dict=True\n    ) %}\n{% set invoice_data = e_invoice_log and e_invoice_log.invoice_data and _dict(json.loads(e_invoice_log.invoice_data)) or None %}\n{% endif %}\n\n{% macro format_address(address) %}\n{% if address %}\n<p>\n    {{ address.address_line1 }}\n    {% if address.address_line2 %}\n    {{ address.address_line2 }}<br>\n    {% endif %}\n    {{ address.city }}, {{ address.state }}, {{ address.country }}: {{ address.pincode }}<br>\n</p>\n{% endif %}\n{% endmacro %}\n\n{% set bns_settings = frappe.get_doc(\"BNS Settings\") %}\n{% set base_currency = frappe.db.get_value(\"Company\", doc.company, \"default_currency\") %}\n\n\n{% set company_cin = frappe.db.get_value(\"Company\", doc.company, \"bns_company_cin\") %}\n{% set msme_no = frappe.db.get_value(\"Company\", doc.company, \"bns_msme_no\") %}\n{% set msme_type = frappe.db.get_value(\"Company\", doc.company, \"bns_msme_type\") %}\n\n{% set copy_map = {\n    \"1\": \"Original for Recipient\",\n    \"2\": \"Duplicate for Transporter\",\n    \"3\": \"Duplicate for Supplier\",\n    \"4\": \"Triplicate for Supplier\"\n} %}\n\n{% set invoice_copy_param = frappe.form_dict.get(\"invoice_copy\") or \"1\" %}\n{% set invoice_copy_text = copy_map.get(invoice_copy_param, \"Original for Recipient\") %}\n\n\n<!--<div class=\"watermark text-center\">MEVABITE</div>-->\n\n<!--<div class=\"page\">-->\n\n\n<div id=\"header-html\">\n    <div class=\"watermark\">{{ invoice_copy_text }}</div>\n    <div class=\"row print-heading\" style=\"line-height:1.1;padding:10px\">\n        <div class=\"col-xs-3 column-break\">\n            {% set company_logo = frappe.db.get_value(\"Company\", doc.company, \"logo_for_printing\") %}\n            {% if company_logo %}\n            <div>\n                <img height=\"125px\" width=\"150px\" src=\"{{ company_logo }}\">\n            </div>\n            {% endif %}\n        </div>\n        <div class=\"col-xs-6 column-break text-center\">\n            <h3 style=\"margin-bottom:0;\"><b>{{ doc.company }}</b></h3>\n            {% if frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\") %}\n                <div style=\"font-size:0.85em;\">Previously Known As: {{frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\")}}</div>\n            {% endif %}\n            <div style=\"font-size:0.85rem\">\n                {% set seller_address = frappe.db.get_value(\"Address\", doc.company_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                    {{ format_address(seller_address) }}\n                    {% if company_cin %}\n                    <span style=\"font-size:0.8em;\">CIN: {{ company_cin }}</span><br>\n                    {% endif %}\n                    {% if doc.company_gstin %}\n                    <span style=\"font-size:0.8em;\"><b>GST:</b> {{ doc.company_gstin }}</span> | \n                    {% endif %}\n                    <span style=\"font-size:0.8em;\">PAN: {{ frappe.db.get_value(\"Company\", doc.company, \"pan\") }}</span><br>\n                    {% if msme_no %}\n                    <span style=\"font-size:0.76em;\">MSME No.: {{ doc.msme_no }}</span> | \n                    {% endif %}\n                    {% if msme_type %}\n                    <span style=\"font-size:0.76em;\">MSME Type: {{ doc.msme_type }}</span>\n                    {% endif %}\n                \n            </div>\n        </div>\n        <div class=\"col-xs-3 column-break text-right\">\n            <h2 style=\"margin-top:5mm;\"><b>\n                    {% if doc.status == \"Cancelled\" and doc.is_return %}\n                        Cancelled Credit Note\n                    {% elif doc.status == \"Cancelled\" %}\n                        Cancelled Invoice\n                    {% elif doc.status == \"Draft\" and doc.is_return %}\n                        Draft Credit Note\n                    {% elif doc.status == \"Draft\" %}\n                        Draft Invoice\n                    {% elif doc.is_return %}\n                        Credit Note\n                    {% elif doc.irn %}\n                        e-Invoice\n                    {% else %}\n                        Tax Invoice\n                    {% endif %}\n                </b>\n            </h2>\n            <div class=\"invoice-meta\">\n              <table class=\"table-condensed no-border\" style=\"width:100%; font-size:0.9em; text-align:left;\">\n                <tr>\n                  <td><b>Invoice Date:</b></td>\n                  <td>{{ frappe.utils.formatdate(doc.posting_date) }}</td>\n                </tr>\n                <tr>\n                  <td><b>Invoice No:</b></td>\n                  <td><b>{{ doc.name }}</b></td>\n                </tr>\n              </table>\n            </div>\n        </div>\n    </div>\n</div>\n\n{% if doc.irn %}\n<div class=\"einv-det\">\n    <!--<div class=\"col-xs-2 column-break text-left\"></div>-->\n    <div class=\"col-xs-4 column-break text-left\">\n        {% if e_invoice_log and e_invoice_log.signed_qr_code %}\n        <img class=\"qrcode\" src=\"data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}\">\n        {% endif %}\n    </div>\n    <div class=\"col-xs-8 column-break text-right\">\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>IRN</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.irn }}</u></div>\n        </div>\n        {% if invoice_data and invoice_data.AckNo %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. No.</label></div>\n            <div class=\"col-xs-8 value\">{{ invoice_data.AckNo }}</div>\n        </div>\n        {% endif %}\n        {% if invoice_data and invoice_data.AckDt %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. Date</label></div>\n            <div class=\"col-xs-8 value\">{{ frappe.utils.format_datetime(invoice_data.AckDt, \"dd/MM/yyyy hh:mm:ss\") }}</div>\n        </div>\n        {% endif %}\n        {% if doc.ewaybill %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>e-Waybill No.</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.ewaybill }}</u></div>\n        </div>\n        {% endif %}\n    </div>\n    <!--<div class=\"col-xs-1 column-break text-right\">-->\n    </div>\n{% endif %}\n\n<table class=\"table table-bordered party-details-table\">\n    <tbody>\n        <tr>\n            <td colspan=3 rowspan=4 style=\"width:45%;\">\n                {% set contact_person = frappe.db.get_value(\n            \"Contact\", doc.contact_person, (\"mobile_no\"), as_dict=True\n        ) %}\n                <h6><b><u>Buyer Details</u></b></h6>\n                <p><b>{{ doc.customer_name }}</b></p>\n                {% set customer_address = frappe.db.get_value(\"Address\", doc.customer_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(customer_address) }}\n\n                {% if doc.billing_address_gstin %}\n                GST: <u>{{ doc.billing_address_gstin }}</u><br>\n                {% endif %}\n                {% set customer_pan = frappe.db.get_value(\"Customer\", doc.customer_name, \"pan\")%}\n                {% if customer_pan %}\n                PAN: {{ customer_pan }}<br>\n                {% endif %}\n                {% if contact_person.mobile_no %}\n                Phone No: {{ contact_person.mobile_no }}\n                {% endif %}\n                {% if doc.shipping_address %}\n                <br>\n                <h6><b><u>Shipping Details</u></b></h6>\n                {% set shipping_address = frappe.db.get_value(\"Address\", doc.shipping_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(shipping_address) }}\n                {% if shipping_address.gstin %}\n                GST: <u>{{ shipping_address.gstin }}</u><br>\n                {% endif %}\n                {% endif %}\n                {% if doc.dispatch_address %}\n                <h6><b><u>Dispatch Details</u></b></h6>\n                <p><b>{{ frappe.db.get_value(\"Address\", doc.dispatch_address_name, \"address_title\") }}</b></p>\n                <!--<p>{{doc.dispatch_address}}</p>-->\n                {% set dispatch_address = frappe.db.get_value(\"Address\", doc.dispatch_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                {{ format_address(dispatch_address) }}\n                {% endif %}\n            </td>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Transporter:</h6>\n                {% if doc.transporter_name %}\n                {{ doc.transporter_name }} <br>\n                {{ doc.gst_transporter_id }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Vehicle No:</h6>\n                {% if doc.vehicle_no %}\n                {{ doc.vehicle_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Builty No:</h6>\n                {% if doc.custom_builty_no %}\n                {{ doc.custom_builty_no }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1>\n                <h6>Place Of Supply</h6>\n                {{ doc.place_of_supply }}\n            </td>\n            {% if not doc.irn and doc.ewaybill %}\n            <td colspan=1>\n                <h6>e-Waybill No.</h6>\n                <u>{{ doc.ewaybill }}</u>\n            </td>            \n            {% endif %}\n            <td colspan=1>\n                <h6>Buyer's PO No:</h6>\n                {% if doc.po_no %}\n                {{ doc.po_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>PO Date:</h6>\n                {% if doc.po_date %}\n                {{ doc.po_date }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% if doc.incoterm or doc.named_place  %}\n        <tr>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Incoterm:</h6>\n                {% if doc.incoterm %}\n                {{ doc.incoterm }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=2>\n                <h6>Named Place:</h6>\n                {% if doc.named_place %}\n                {{ doc.named_place }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% endif %}\n        <tr>\n            <td colspan=1>\n                \n                <h6>Destination:</h6>\n                {% if doc.custom_destination %}\n                {{doc.custom_destination}}\n                {% else %}<br>{% endif %}\n            </td>\n            <td rowspan=2 colspan=\"{{ 3 if (not doc.irn and doc.ewaybill) else 2 }}\">\n                <h6>Terms of Delivery:</h6>\n                {% if doc.custom_terms_of_delivery %}\n                {{ doc.custom_terms_of_delivery }}\n                {% elif doc.custom_terms_of_delivery_new %}\n                {{ doc.custom_terms_of_delivery_new }}\n                {% else %}<br><br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1 rowspan=1>\n                <h6>Doc No:</h6>\n                {% if doc.custom_doc_no %}\n                {{doc.custom_doc_no}}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n\n<table class=\"table table-bordered item-det\">\n<thead>\n    <tr>\n        <th colspan=\"2\">#</th>\n        <th>Item</th>\n        <th colspan=\"7\">Qty</th>\n        {% if bns_settings.rate_excl_tax %}\n        <th colspan=\"9\">Rate(Exc Tax)</th>\n        {% endif %}\n        {% if doc.is_print_gst_rate_per_row %}\n        <th colspan=\"4\">GST</th>\n        {% endif %}\n        {% if bns_settings.rate_incl_tax %}\n        <th colspan=\"9\">Rate(Inc Tax)</th>\n        {% endif %}\n        {% if bns_settings.discount_type == \"Triple Compounded\" %}\n        <th colspan=\"4\">D1</th>\n        <th colspan=\"4\">D2</th>\n        <th colspan=\"4\">D3</th>\n        {% else %}\n        <th colspan=\"4\">Disc</th>\n        {% endif %}\n        {% if bns_settings.is_item_amount_tax_incl %}\n        <th colspan=\"11\">Amount(Incl)</th>\n        {% else %}\n        <th colspan=\"11\">Amount(Excl)</th>\n        {% endif %}\n    </tr>\n</thead>\n\n    <tbody>\n        {% for item in doc.items %}\n        <tr class=\"no-break {{ 'odd' if loop.index is odd else 'even' }}\">\n            <td colspan=\"2\">{{ loop.index }}</td>\n            <td class=\"item-det-item-name\">\n                <b>{% if bns_settings.show_item_code or doc.bns_show_item_code %}{{ item.item_code }}:{% endif %}{{ item.item_name }}</b><br>\n                <p style=\"font-size:0.8em;margin:0;\"><i>\n                {% if item.gst_hsn_code %}\n                    <b>HSN/SAC: </b>{{item.gst_hsn_code}}\n                {% endif %}\n                {% if item.barcode and (doc.bns_show_item_barcode or bns_settings.bns_show_item_barcode) %}\n                    | <b>EAN:</b> {{ item.barcode }}\n                {% endif %}\n                </i>\n                </p>\n            </td>\n            <td colspan=\"7\">\n                <b>\n                    <span>{{ item.qty }} {{ item.uom }}</span>\n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <small style=\"font-size:0.9em;\">{{ (item.conversion_factor * item.qty / print_uom_conversion ) | int }} {{ print_uom }} </small>\n                                \n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <br>\n                                <small style=\"font-size:0.75em;\">{{ item.total_weight }} Kg</small>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <br>\n                                <small style=\"font-size:0.85em;\">{{ item.total_weight / 1000 }} Kg</small>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% if doc.taxes[0].included_in_print_rate == 1 %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set inclusive_rate = item.base_price_list_rate %}\n                {% set exclusive_rate = inclusive_rate*100/(100+gst_rate) %}\n            \n            {% else %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set exclusive_rate = item.base_price_list_rate %}\n                {% set inclusive_rate = exclusive_rate*(100+gst_rate)/100 %}\n            \n            {% endif %}\n            \n            {% if bns_settings.rate_excl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.95em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.85em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.85em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {% if doc.is_print_gst_rate_per_row %}\n                <td colspan=\"4\">{{ gst_rate | round(0) | int }}%</td>\n            {% endif %}\n            \n            {% if bns_settings.rate_incl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {# --- Step 1: Calculate / Fix discount_percentage if needed --- #}\n            {% if item.discount_percentage == 0 and item.base_price_list_rate and item.base_rate and item.base_price_list_rate != item.base_rate %}\n                {% set manual_discount = ((item.base_price_list_rate - item.base_rate) * 100) / item.base_price_list_rate %}\n                {% set item_discount = \"{:.2f}\".format(manual_discount|float) %}\n            {% else %}\n                {% set item_discount = item.discount_percentage %}\n            {% endif %}\n            \n            {# --- Step 2: Render depending on discount_type --- #}\n            {% if bns_settings.discount_type != \"Single\" %}\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if (item.custom_d1_ == 0.0 and not item_discount) else (item.custom_d1_ if item.custom_d1_ != 0.0 else item_discount) ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d2_ == 0.0 else item.custom_d2_ ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d3_ == 0.0 else item.custom_d3_ ~ '%' }}\n                </td>\n            {% else %}\n                <td colspan=\"4\">{{ item_discount }}%</td>\n            {% endif %}\n            \n            \n            {% if bns_settings.is_item_amount_tax_incl %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount*(1+(gst_rate/100))), currency=base_currency) }}</b></td>\n            {% else %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount), currency=base_currency) }}</b></td>\n            {% endif %}\n        </tr>\n        {% endfor %}\n    </tbody>\n</table>\n\n<div class=\"final-tax-total-table\">\n    <table class=\"table table-bordered\">\n        <tbody>\n            <tr>\n                <td rowspan=1 colspan=5 style=\"vertical-align:top !important; width:45%;\" class=\"text-center\"><b>Bank Details</b></td>\n                <td class=\"text-right\" colspan=2><b>Total Taxable Value</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(doc.base_net_total), currency=base_currency) }}\n                </td>\n            </tr>\n    \n            {# --- calculate extra rows count --- #}\n            {% set taxes_count = doc.taxes | length %}\n            {% set extra_rows = taxes_count %}\n            {% if doc.discount_amount %}\n                {% set extra_rows = extra_rows + 1 %}\n            {% endif %}\n            {# +1 for Grand Total, +1 for Amount in words #}\n            {% set total_rows = extra_rows + 2 %}\n    \n            <tr>\n                <td class=\"text-center\" rowspan={{ total_rows+1 }} colspan=5 style=\"vertical-align:top !important;\">\n                    {% set bank_account = frappe.db.get_value(\"Bank Account\", {\"company\": doc.company, \"is_default\": 1}, [\"account_name\",\"bank\", \"bank_account_no\", \"branch_code\",\"iban\"], as_dict=True) %}\n                    {% if bank_account.account_name %}\n                    Account Name: <b><i>{{ bank_account.account_name }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank %}\n                    Bank Name: <b><i>{{ bank_account.bank }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank_account_no %}\n                    Account Number: <b><i>{{ bank_account.bank_account_no }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.branch_code %}\n                    Branch Code (IFSC): <b><i>{{ bank_account.branch_code }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.iban %}\n                    IBAN: <b><i>{{ bank_account.iban }}</i></b><br>\n                    {% endif %}\n                </td>\n            </tr>\n    \n            {# --- loop through Sales Taxes & Charges rows --- #}\n            {% for tax_row in doc.taxes %}\n            <tr>\n                <td class=\"text-right\" colspan=2 style=\"font-size:0.8em;\">\n                    <b>{{ tax_row.description or tax_row.account_head }}</b>\n                </td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(tax_row.base_tax_amount), currency=base_currency) }}\n                </td>\n            </tr>\n            {% endfor %}\n    \n            {% if doc.discount_amount %}\n            <tr>\n                <td class=\"text-right\" colspan=2>Additional Discount</td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_discount_amount, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            {% endif %}\n    \n            {% set total_to_show = doc.base_rounded_total\n            if doc.base_rounded_total and doc.base_rounded_total != 0\n            else doc.base_grand_total\n            %}\n    \n            <tr>\n                <td class=\"text-right\" colspan=2><b>Grand Total</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(total_to_show, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            <tr>\n                <td colspan=4>\n                    <b>Amount (in words): </b><span style=\"font-size:0.85em\">{{ doc.base_in_words }}</span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n    \n    {{ doc.gst_breakup_table }}\n    {% if doc.is_print_gst_table %}\n    \n    {% set gst_summary = {} %}\n    {% set gst_flags = {\"uses_igst\": false, \"uses_cgst_sgst\": false} %}\n        \n        {% for item in doc.items %}\n            {% set gst_rate = (frappe.db.get_value(\"Item Tax Template\", {\"name\": item.item_tax_template}, \"gst_rate\") or 0) | float %}\n            {% set key = gst_rate|string %}\n        \n            {% if item.igst_amount %}\n                {% set _ = gst_flags.update({\"uses_igst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"igst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"igst_amount\": gst_summary[key].igst_amount + item.igst_amount\n                }) %}\n            {% elif item.cgst_amount and item.sgst_amount %}\n                {% set _ = gst_flags.update({\"uses_cgst_sgst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"cgst_amount\": 0,\n                        \"sgst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"cgst_amount\": gst_summary[key].cgst_amount + item.cgst_amount,\n                    \"sgst_amount\": gst_summary[key].sgst_amount + item.sgst_amount\n                }) %}\n            {% endif %}\n        {% endfor %}\n        \n        <h4>GST Summary</h4>\n        <table class=\"table table-bordered table-hover\" style=\"text-align: center;\">\n            <thead>\n                <tr>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">GST RATE</th>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">Taxable Value</th>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">CGST</th>\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">SGST/UTGST</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">IGST</th>\n                    {% endif %}\n                </tr>\n                <tr>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% endif %}\n                </tr>\n            </thead>\n            <tbody>\n                {% for row in gst_summary.values() %}\n                    <tr>\n                        <td>{{ row.gst_rate }}%</td>\n                        <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.taxable_value), currency=doc.currency) }}</td>\n        \n                        {% if gst_flags.uses_cgst_sgst %}\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.cgst_amount), currency=doc.currency) }}</td>\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.sgst_amount), currency=doc.currency) }}</td>\n                        {% elif gst_flags.uses_igst %}\n                            <td>{{ row.gst_rate }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.igst_amount), currency=doc.currency) }}</td>\n                        {% endif %}\n                    </tr>\n                {% endfor %}\n            </tbody>\n        </table>\n    \n    \n    {% endif %}\n    \n\n    \n    <table class=\"table table-bordered\" style=\" table-layout: fixed; border-collapse: collapse; width:100%; text-align:center; font-size:12px;\">\n        <tr rowspan=1>\n            <td rowspan=1 colspan=4>\n                <b>{% if doc.is_print_payment_terms==1%} Payment Terms {% endif %}</b>\n            </td>\n            <td colspan=4>\n                <b>Pre Authenticated By: {{doc.company}}</b>\n            </td>\n        </tr>\n        <tr>\n            <td colspan=4 rowspan=3>\n            {% if doc.payment_schedule and doc.is_print_payment_terms==1 %}\n            <table class=\"payment_terms_table\" style=\"width: 100%; border-collapse: collapse;\">\n                <thead>\n                    <tr>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Due Date</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Invoice Portion</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Payment Amount</b></th>\n    \n                    </tr>\n                </thead>\n                <tbody>\n                    {% for row in doc.payment_schedule %}\n                    <tr>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.due_date }}</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.invoice_portion }}%</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ frappe.utils.fmt_money(row.payment_amount, currency=\"INR\") }}</td>\n                    </tr>\n                    {% endfor %}\n                </tbody>\n            </table>\n            {% endif %}\n            </td>\n            <td colspan=4>\n                Issuing Signatory\n            </td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left\">\n                Name:\n            </td>\n            <td colspan=3></td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left;\">\n                Designation:\n            </td>\n            <td colspan=3></td>\n        </tr>\n    </table>\n    {% if doc.terms %}\n    <p style=\"margin:0px;border: 1px solid black;page-break-inside: avoid;\">\n        <h6 style=\"margin:0px;\">Terms & Conditions:</h6>\n        {{ doc.terms }}\n    </p>\n    {% endif %}\n\n</div>\n\n\n{% if doc.ewaybill %}\n    {% set e_waybill_data = frappe.db.get_value(\"e-Waybill Log\", {\"reference_name\": doc.name, \"reference_doctype\": \"Sales Invoice\"}, \"data\") %}\n    <div class=\"page-break\"></div>\n    {% set data = _dict(json.loads(e_waybill_data)) %}\n    {%- set irn = doc.irn -%}\n\n    {% if data.supplyType == \"O\" %}\n    {% set generated_by = data.fromTrdName %}\n    {% else %}\n    {% set generated_by = data.toTrdName %}\n    {% endif %}\n\n    <div id=\"ewaybill-page-layout\">\n        <table class=\"table borderless\" style=\"border:0\">\n            <tbody>\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <h3 class=\"title\">e-Waybill</h1>\n                    </td>\n                </tr>\n\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img src=\"data:image/png;base64,{{ get_e_waybill_qr_code(data.ewbNo,data.userGstin, data.ewayBillDate) }}\" class=\"qr-code\" />\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n\n        <table class=\"table borderless\">\n            <tbody>\n                <tr>\n                    <td>\n                        <span>e-Waybill No:</span>\n                    </td>\n                    <td>\n                        <span class=\"e-waybill-number\">\n                            <strong>{{ add_spacing(data.ewbNo, 4) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>e-Waybill Date:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \"\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Generated By:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>\n                                {{ add_spacing(data.userGstin, 5) }} - {{ generated_by }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid From:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \" \") }}\n                                {{ \" [\" }}{{ data.actualDist }}{{ \"Kms]\" }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid Until:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.validUpto[:10] }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if irn %}\n                <tr>\n                    <td>\n                        <span>IRN:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ irn }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - A</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Supplier</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.fromGstin, 5) }}-{{ data.fromTrdName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Dispatch</td>\n                    <td>\n                        <span>\n                            <strong>{{ data.fromPlace }},\n                                {{ get_state(data.actFromStateCode) }} -\n                                {{ data.fromPincode }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Recipient</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.toGstin, 5) }}-{{ data.toTrdName }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Delivery</td>\n                    <td>\n                        <span><strong>\n                                {{ data.toPlace }},\n                                {{ get_state(data.actToStateCode) }} -{{ data.toPincode }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document No.</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docNo }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document Date</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docDate }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Transaction Type:</span>\n                    </td>\n                    <td>\n                        <span><strong>{{ get_transport_type(data.transactionType) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Value of Goods</td>\n                    <td>\n                        <span class=\"classfont\">\n                            <strong>\n                                {{ frappe.utils.fmt_money(data.totInvValue, currency=\"INR\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>HSN Code</td>\n                    <td>\n                        <span class=\"form-control1\" onkeydown=\"expandtext(this);\">\n                            <strong>{{ data.itemList[0].hsnCode }}\n                                {%if data.itemList[0].productDesc%}\n                                {{ \" - \" ~data.itemList[0].productDesc }}\n                                {%endif%}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Reason for Transportation</td>\n                    <td>\n                        <span>\n                            <strong>{{ get_supply_type(data.supplyType) }} - {{ get_sub_supply_type(data.subSupplyType) }} </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Transporter</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.transporterId, 5) }}-\n                                {{ data.transporterName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if data.VehiclListDetails|length > 0 %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - B</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div>\n                            <table cellspacing=\"0\" cellpadding=\"3\" rules=\"all\" class=\"table table-responsive vehicle-info\" border=\"1\">\n                                <tbody>\n                                    <tr>\n                                        <th scope=\"col\">Mode</th>\n                                        <th scope=\"col\">\n                                            Vehicle / Trans <br />\n                                            Doc No &amp; Dt.\n                                        </th>\n                                        <th scope=\"col\">From</th>\n                                        <th scope=\"col\">Entered Date</th>\n                                        <th scope=\"col\">Entered By</th>\n                                        <th scope=\"col\">\n                                            Cdata No. <br />\n                                            (If any)\n                                        </th>\n                                        <th scope=\"col\">\n                                            Multi Veh.Info <br />\n                                            (If any)\n                                        </th>\n                                    </tr>\n                                    {% for detail in data.VehiclListDetails %}\n                                    <tr>\n                                        <td>\n                                            {{ get_transport_mode(detail.transMode) }}\n                                        </td>\n                                        <td>\n                                            {{ detail.vehicleNo }} /\n                                            {{ detail.transDocNo }} Dt:\n                                            {{ detail.transDocDate }}\n                                        </td>\n                                        <td>{{ detail.fromPlace }}</td>\n                                        <td>\n                                            {{ detail.enteredDate |\n                                                replace(\":00 \", \" \") }}\n                                        </td>\n                                        <td>{{ detail.userGSTINTransin }}</td>\n                                        <td>-</td>\n                                        <td>-</td>\n                                    </tr>\n                                    {% endfor%}\n                                </tbody>\n                            </table>\n                        </div>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img class=\"barcode\" src=\"data:image/png;base64,{{ get_ewaybill_barcode(data.ewbNo) }}\">\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    {% endif %}\n\n\n\n\n\n<div id=\"footer-html\">\n    <div class=\"text-center small page-footer-1\">\n        {{ _(\"Page {0} of {1}\").format('<span class=\"page\"></span>', '<span class=\"topage\"></span>') }}<br>This is a computer generated document and does not require a signature.\n    </div>\n</div>\n",
  "idx": 0,
  "line_breaks": 0,
  "margin_bottom": 0.0,
  "margin_left": 0.0,
  "margin_right": 0.0,
  "margin_top": 0.0,
- "modified": "2025-10-08 23:05:57.160865",
+ "modified": "2026-01-11 22:13:23.243507",
  "modified_by": "Administrator",
  "module": "Business Needed Solutions",
  "name": "BNS SI Dynamic V2",
  "owner": "sagarratangarg@rbcolour.com",
  "page_number": "Bottom Center",
- "pdf_generator": "PrintX",
+ "print_designer": 0,
  "print_format_builder": 0,
  "print_format_builder_beta": 0,
  "print_format_for": "DocType",
diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
index 78ab0ee..db2730d 100644
--- a/business_needed_solutions/fixtures/custom_field.json
+++ b/business_needed_solutions/fixtures/custom_field.json
@@ -56,6 +56,63 @@
   "unique": 0,
   "width": null
  },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": "0",
+  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock') && frappe.db.get_single_value('BNS Settings', 'enable_per_warehouse_negative_stock_disallow')",
+  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings. This feature must be enabled in BNS Settings first.",
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Warehouse",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "bns_disallow_negative_stock",
+  "fieldtype": "Check",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "is_rejected_warehouse",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "Disallow Negative Stock",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2025-01-27 10:00:00",
+  "module": "Business Needed Solutions",
+  "name": "Warehouse-bns_disallow_negative_stock",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": null,
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 0,
+  "unique": 0,
+  "width": null
+ },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 0,
@@ -170,6 +227,177 @@
   "unique": 0,
   "width": null
  },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": null,
+  "depends_on": null,
+  "description": null,
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Company",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "bns_company_cin",
+  "fieldtype": "Data",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "tax_id",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "Corporate Identification Number",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2026-01-11 21:30:40.727439",
+  "module": "Business Needed Solutions",
+  "name": "Company-custom_corporate_identification_number",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": null,
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 1,
+  "unique": 0,
+  "width": null
+ },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": null,
+  "depends_on": null,
+  "description": null,
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Company",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "bns_msme_no",
+  "fieldtype": "Data",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "bns_company_cin",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "MSME No.",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2026-01-11 21:30:46.253006",
+  "module": "Business Needed Solutions",
+  "name": "Company-custom_msme_no",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": null,
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 1,
+  "unique": 0,
+  "width": null
+ },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": null,
+  "depends_on": null,
+  "description": null,
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Company",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "bns_msme_type",
+  "fieldtype": "Select",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "bns_msme_no",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "MSME Type",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2026-01-11 21:30:50.211451",
+  "module": "Business Needed Solutions",
+  "name": "Company-custom_msme_type",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": "\nMicro\nSmall\nMedium",
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 1,
+  "unique": 0,
+  "width": null
+ },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 0,
@@ -410,12 +638,12 @@
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Quotation Item",
+  "dt": "Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d1_",
-  "fieldtype": "Percent",
-  "hidden": 1,
+  "fieldname": "custom_print_uom",
+  "fieldtype": "Link",
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
@@ -425,22 +653,22 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "column_break_18",
+  "insert_after": "uoms",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D1",
+  "label": "Print UOM",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.484320",
+  "modified": "2025-04-02 02:46:14.810317",
   "module": "Business Needed Solutions",
-  "name": "Quotation Item-custom_d1_",
+  "name": "Item-custom_print_uom",
   "no_copy": 0,
   "non_negative": 0,
-  "options": null,
+  "options": "UOM",
   "permlevel": 0,
   "placeholder": null,
-  "precision": null,
+  "precision": "",
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
@@ -461,43 +689,43 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Quotation Item",
+  "dt": "Sales Invoice Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d2_",
+  "fieldname": "custom_d1_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "custom_d1_",
+  "insert_after": "column_break_19",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D2",
+  "label": "D1",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.484669",
+  "modified": "2026-01-11 20:55:05.960361",
   "module": "Business Needed Solutions",
-  "name": "Quotation Item-custom_d2",
+  "name": "Sales Invoice Item-custom_d1_",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
   "placeholder": null,
-  "precision": null,
+  "precision": "",
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
@@ -518,17 +746,17 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Item",
+  "dt": "Sales Invoice Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_print_uom",
-  "fieldtype": "Link",
+  "fieldname": "custom_d2_",
+  "fieldtype": "Percent",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -536,22 +764,22 @@
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "uoms",
+  "insert_after": "custom_d1_",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Print UOM",
+  "label": "D2",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-04-02 02:46:14.810317",
+  "modified": "2026-01-11 20:55:05.960665",
   "module": "Business Needed Solutions",
-  "name": "Item-custom_print_uom",
+  "name": "Sales Invoice Item-custom_d2",
   "no_copy": 0,
   "non_negative": 0,
-  "options": "UOM",
+  "options": null,
   "permlevel": 0,
   "placeholder": null,
   "precision": "",
@@ -559,7 +787,7 @@
   "print_hide_if_no_value": 0,
   "print_width": null,
   "read_only": 0,
-  "read_only_depends_on": null,
+  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0;",
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
@@ -575,7 +803,7 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
@@ -584,28 +812,28 @@
   "dt": "Quotation Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d3_",
+  "fieldname": "custom_d1_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "custom_d2_",
+  "insert_after": "column_break_18",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D3",
+  "label": "D1",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.485011",
+  "modified": "2026-01-11 20:55:06.306865",
   "module": "Business Needed Solutions",
-  "name": "Quotation Item-custom_d3",
+  "name": "Quotation Item-custom_d1_",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -632,48 +860,48 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Delivery Note Item",
+  "dt": "Sales Invoice Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d1_",
+  "fieldname": "custom_d3_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "column_break_19",
+  "insert_after": "custom_d2_",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D1",
+  "label": "D3",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.392341",
+  "modified": "2026-01-11 20:55:05.960924",
   "module": "Business Needed Solutions",
-  "name": "Delivery Note Item-custom_d1_",
+  "name": "Sales Invoice Item-custom_d3",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
   "placeholder": null,
-  "precision": null,
+  "precision": "",
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
   "read_only": 0,
-  "read_only_depends_on": null,
+  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0 || !doc.custom_d2_ || doc.custom_d2_ == 0;",
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
@@ -689,25 +917,25 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Delivery Note Item",
+  "dt": "Quotation Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_d2_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "custom_d1_",
@@ -717,9 +945,9 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.392686",
+  "modified": "2026-01-11 20:55:06.307214",
   "module": "Business Needed Solutions",
-  "name": "Delivery Note Item-custom_d2",
+  "name": "Quotation Item-custom_d2",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -746,25 +974,25 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Invoice Item",
+  "dt": "Delivery Note Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_d1_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "column_break_19",
@@ -774,15 +1002,15 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.137033",
+  "modified": "2026-01-11 20:55:06.217487",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice Item-custom_d1_",
+  "name": "Delivery Note Item-custom_d1_",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
   "placeholder": null,
-  "precision": "",
+  "precision": null,
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
@@ -803,37 +1031,37 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Delivery Note Item",
+  "dt": "Sales Order Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d3_",
+  "fieldname": "custom_d1_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "custom_d2_",
+  "insert_after": "column_break_19",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D3",
+  "label": "D1",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.393016",
+  "modified": "2026-01-11 20:55:06.089754",
   "module": "Business Needed Solutions",
-  "name": "Delivery Note Item-custom_d3",
+  "name": "Sales Order Item-custom_d1_",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -860,37 +1088,37 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Order Item",
+  "dt": "Quotation Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_d1_",
+  "fieldname": "custom_d3_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "column_break_19",
+  "insert_after": "custom_d2_",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "D1",
+  "label": "D3",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.261215",
+  "modified": "2026-01-11 20:55:06.307551",
   "module": "Business Needed Solutions",
-  "name": "Sales Order Item-custom_d1_",
+  "name": "Quotation Item-custom_d3",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -917,25 +1145,25 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Invoice Item",
+  "dt": "Delivery Note Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_d2_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "custom_d1_",
@@ -945,20 +1173,20 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.137413",
+  "modified": "2026-01-11 20:55:06.217833",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice Item-custom_d2",
+  "name": "Delivery Note Item-custom_d2",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
   "placeholder": null,
-  "precision": "",
+  "precision": null,
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
   "read_only": 0,
-  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0;",
+  "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
@@ -974,7 +1202,7 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
@@ -985,14 +1213,14 @@
   "fetch_if_empty": 0,
   "fieldname": "custom_d2_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "custom_d1_",
@@ -1002,7 +1230,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.261576",
+  "modified": "2026-01-11 20:55:06.090111",
   "module": "Business Needed Solutions",
   "name": "Sales Order Item-custom_d2",
   "no_copy": 0,
@@ -1031,25 +1259,25 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Invoice Item",
+  "dt": "Delivery Note Item",
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_d3_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "custom_d2_",
@@ -1059,20 +1287,20 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.137744",
+  "modified": "2026-01-11 20:55:06.218165",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice Item-custom_d3",
+  "name": "Delivery Note Item-custom_d3",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
   "placeholder": null,
-  "precision": "",
+  "precision": null,
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
   "read_only": 0,
-  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0 || !doc.custom_d2_ || doc.custom_d2_ == 0;",
+  "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
@@ -1088,7 +1316,7 @@
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
-  "columns": 0,
+  "columns": 1,
   "default": null,
   "depends_on": null,
   "description": null,
@@ -1099,14 +1327,14 @@
   "fetch_if_empty": 0,
   "fieldname": "custom_d3_",
   "fieldtype": "Percent",
-  "hidden": 1,
+  "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
   "hide_seconds": 0,
   "ignore_user_permissions": 0,
   "ignore_xss_filter": 0,
   "in_global_search": 0,
-  "in_list_view": 0,
+  "in_list_view": 1,
   "in_preview": 0,
   "in_standard_filter": 0,
   "insert_after": "custom_d2_",
@@ -1116,7 +1344,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-09-22 15:32:50.261916",
+  "modified": "2026-01-11 20:55:06.090439",
   "module": "Business Needed Solutions",
   "name": "Sales Order Item-custom_d3",
   "no_copy": 0,
@@ -1709,63 +1937,6 @@
   "unique": 0,
   "width": null
  },
- {
-  "allow_in_quick_entry": 0,
-  "allow_on_submit": 1,
-  "bold": 0,
-  "collapsible": 0,
-  "collapsible_depends_on": null,
-  "columns": 0,
-  "default": "0",
-  "depends_on": null,
-  "description": null,
-  "docstatus": 0,
-  "doctype": "Custom Field",
-  "dt": "Sales Invoice",
-  "fetch_from": null,
-  "fetch_if_empty": 0,
-  "fieldname": "bns_show_item_barcode",
-  "fieldtype": "Check",
-  "hidden": 0,
-  "hide_border": 0,
-  "hide_days": 0,
-  "hide_seconds": 0,
-  "ignore_user_permissions": 0,
-  "ignore_xss_filter": 0,
-  "in_global_search": 0,
-  "in_list_view": 0,
-  "in_preview": 0,
-  "in_standard_filter": 0,
-  "insert_after": "bns_show_item_code",
-  "is_system_generated": 0,
-  "is_virtual": 0,
-  "label": "Show Item Barcode",
-  "length": 0,
-  "link_filters": null,
-  "mandatory_depends_on": null,
-  "modified": "2025-09-22 02:59:24.552417",
-  "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_show_item_barcode",
-  "no_copy": 0,
-  "non_negative": 0,
-  "options": null,
-  "permlevel": 0,
-  "placeholder": "",
-  "precision": "",
-  "print_hide": 0,
-  "print_hide_if_no_value": 0,
-  "print_width": null,
-  "read_only": 0,
-  "read_only_depends_on": null,
-  "report_hide": 0,
-  "reqd": 0,
-  "search_index": 0,
-  "show_dashboard": 0,
-  "sort_options": 0,
-  "translatable": 0,
-  "unique": 0,
-  "width": null
- },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 1,
@@ -1882,12 +2053,12 @@
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 0,
+  "allow_on_submit": 1,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
   "columns": 0,
-  "default": null,
+  "default": "0",
   "depends_on": null,
   "description": null,
   "docstatus": 0,
@@ -1895,8 +2066,8 @@
   "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_builty_no",
-  "fieldtype": "Data",
+  "fieldname": "bns_show_item_barcode",
+  "fieldtype": "Check",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -1907,21 +2078,21 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "distance",
+  "insert_after": "bns_show_item_code",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Builty No",
+  "label": "Show Item Barcode",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-03-09 03:12:51.185637",
+  "modified": "2025-09-22 02:59:24.552417",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_builty_no",
+  "name": "Sales Invoice-custom_show_item_barcode",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
   "permlevel": 0,
-  "placeholder": null,
+  "placeholder": "",
   "precision": "",
   "print_hide": 0,
   "print_hide_if_no_value": 0,
@@ -1933,13 +2104,13 @@
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 1,
+  "translatable": 0,
   "unique": 0,
   "width": null
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 1,
+  "allow_on_submit": 0,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
@@ -1949,11 +2120,11 @@
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Invoice",
+  "dt": "Purchase Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_destination",
-  "fieldtype": "Data",
+  "fieldname": "is_bns_internal_supplier",
+  "fieldtype": "Check",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -1964,16 +2135,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "custom_builty_no",
+  "insert_after": "is_internal_supplier",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Destination",
+  "label": "Is BNS Internal Supplier",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-03-09 03:12:29.557539",
+  "modified": "2025-11-24 12:00:00",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_destination",
+  "name": "Purchase Invoice-is_bns_internal_supplier",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -1983,20 +2154,20 @@
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
-  "read_only": 0,
+  "read_only": 1,
   "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 1,
+  "translatable": 0,
   "unique": 0,
   "width": null
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 1,
+  "allow_on_submit": 0,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
@@ -2009,7 +2180,7 @@
   "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_doc_no",
+  "fieldname": "custom_builty_no",
   "fieldtype": "Data",
   "hidden": 0,
   "hide_border": 0,
@@ -2021,16 +2192,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "custom_destination",
+  "insert_after": "distance",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Doc No",
+  "label": "Builty No",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-03-09 03:12:23.951908",
+  "modified": "2025-03-09 03:12:51.185637",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_doc_no",
+  "name": "Sales Invoice-custom_builty_no",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2053,7 +2224,7 @@
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 1,
+  "allow_on_submit": 0,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
@@ -2063,11 +2234,11 @@
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Sales Invoice",
+  "dt": "Purchase Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "custom_terms_of_delivery",
-  "fieldtype": "Text Editor",
+  "fieldname": "bns_inter_company_reference",
+  "fieldtype": "Data",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -2078,16 +2249,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "transporter_col_break",
+  "insert_after": "is_bns_internal_supplier",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Terms of Delivery",
+  "label": "BNS Inter Company Reference",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-03-09 03:12:58.632863",
+  "modified": "2025-11-24 12:00:00",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_terms_of_delivery",
+  "name": "Purchase Invoice-bns_inter_company_reference",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2097,14 +2268,14 @@
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
-  "read_only": 0,
+  "read_only": 1,
   "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 1,
+  "translatable": 0,
   "unique": 0,
   "width": null
  },
@@ -2123,8 +2294,8 @@
   "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "is_bns_internal_check",
-  "fieldtype": "Check",
+  "fieldname": "custom_destination",
+  "fieldtype": "Data",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -2135,16 +2306,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "is_internal_customer",
+  "insert_after": "custom_builty_no",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Is BNS Internal Check",
+  "label": "Destination",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-04-27 17:36:28.324931",
+  "modified": "2025-03-09 03:12:29.557539",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-custom_internal_check_done",
+  "name": "Sales Invoice-custom_destination",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2161,13 +2332,13 @@
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 0,
+  "translatable": 1,
   "unique": 0,
   "width": null
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 0,
+  "allow_on_submit": 1,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
@@ -2178,10 +2349,10 @@
   "docstatus": 0,
   "doctype": "Custom Field",
   "dt": "Sales Invoice",
-  "fetch_from": "customer.is_bns_internal_customer",
+  "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "is_bns_internal_customer",
-  "fieldtype": "Check",
+  "fieldname": "custom_doc_no",
+  "fieldtype": "Data",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -2192,16 +2363,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "represents_company",
+  "insert_after": "custom_destination",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Is BNS Internal Customer",
+  "label": "Doc No",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-11-24 12:00:00",
+  "modified": "2025-03-09 03:12:23.951908",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-is_bns_internal_customer",
+  "name": "Sales Invoice-custom_doc_no",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2211,20 +2382,20 @@
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
-  "read_only": 1,
+  "read_only": 0,
   "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 0,
+  "translatable": 1,
   "unique": 0,
   "width": null
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 0,
+  "allow_on_submit": 1,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
@@ -2237,8 +2408,8 @@
   "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "bns_inter_company_reference",
-  "fieldtype": "Data",
+  "fieldname": "custom_terms_of_delivery",
+  "fieldtype": "Text Editor",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -2249,16 +2420,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "is_bns_internal_customer",
+  "insert_after": "transporter_col_break",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "BNS Inter Company Reference",
+  "label": "Terms of Delivery",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-11-24 12:00:00",
+  "modified": "2025-03-09 03:12:58.632863",
   "module": "Business Needed Solutions",
-  "name": "Sales Invoice-bns_inter_company_reference",
+  "name": "Sales Invoice-custom_terms_of_delivery",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2268,14 +2439,14 @@
   "print_hide": 0,
   "print_hide_if_no_value": 0,
   "print_width": null,
-  "read_only": 1,
+  "read_only": 0,
   "read_only_depends_on": null,
   "report_hide": 0,
   "reqd": 0,
   "search_index": 0,
   "show_dashboard": 0,
   "sort_options": 0,
-  "translatable": 0,
+  "translatable": 1,
   "unique": 0,
   "width": null
  },
@@ -2291,10 +2462,10 @@
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Purchase Invoice",
-  "fetch_from": null,
+  "dt": "Sales Invoice",
+  "fetch_from": "customer.is_bns_internal_customer",
   "fetch_if_empty": 0,
-  "fieldname": "is_bns_internal_supplier",
+  "fieldname": "is_bns_internal_customer",
   "fieldtype": "Check",
   "hidden": 0,
   "hide_border": 0,
@@ -2306,16 +2477,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "is_internal_supplier",
+  "insert_after": "represents_company",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Is BNS Internal Supplier",
+  "label": "Is BNS Internal Customer",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
   "modified": "2025-11-24 12:00:00",
   "module": "Business Needed Solutions",
-  "name": "Purchase Invoice-is_bns_internal_supplier",
+  "name": "Sales Invoice-is_bns_internal_customer",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2348,7 +2519,7 @@
   "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Purchase Invoice",
+  "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "bns_inter_company_reference",
@@ -2363,7 +2534,7 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "is_bns_internal_supplier",
+  "insert_after": "is_bns_internal_customer",
   "is_system_generated": 0,
   "is_virtual": 0,
   "label": "BNS Inter Company Reference",
@@ -2372,7 +2543,7 @@
   "mandatory_depends_on": null,
   "modified": "2025-11-24 12:00:00",
   "module": "Business Needed Solutions",
-  "name": "Purchase Invoice-bns_inter_company_reference",
+  "name": "Sales Invoice-bns_inter_company_reference",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
@@ -2395,20 +2566,20 @@
  },
  {
   "allow_in_quick_entry": 0,
-  "allow_on_submit": 0,
+  "allow_on_submit": 1,
   "bold": 0,
   "collapsible": 0,
   "collapsible_depends_on": null,
   "columns": 0,
-  "default": "0",
-  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock') && frappe.db.get_single_value('BNS Settings', 'enable_per_warehouse_negative_stock_disallow')",
-  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings. This feature must be enabled in BNS Settings first.",
+  "default": null,
+  "depends_on": null,
+  "description": null,
   "docstatus": 0,
   "doctype": "Custom Field",
-  "dt": "Warehouse",
+  "dt": "Sales Invoice",
   "fetch_from": null,
   "fetch_if_empty": 0,
-  "fieldname": "bns_disallow_negative_stock",
+  "fieldname": "is_bns_internal_check",
   "fieldtype": "Check",
   "hidden": 0,
   "hide_border": 0,
@@ -2420,16 +2591,16 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "is_rejected_warehouse",
+  "insert_after": "is_internal_customer",
   "is_system_generated": 0,
   "is_virtual": 0,
-  "label": "Disallow Negative Stock",
+  "label": "Is BNS Internal Check",
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2025-01-27 10:00:00.000000",
+  "modified": "2025-04-27 17:36:28.324931",
   "module": "Business Needed Solutions",
-  "name": "Warehouse-bns_disallow_negative_stock",
+  "name": "Sales Invoice-custom_internal_check_done",
   "no_copy": 0,
   "non_negative": 0,
   "options": null,
diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
index a3e12af..387c36c 100644
--- a/business_needed_solutions/hooks.py
+++ b/business_needed_solutions/hooks.py
@@ -247,7 +247,8 @@ doc_events = {
 fixtures = [
             # {"doctype": "Client Script", "filters": [["module" , "in" , ("Business Needed Solutions" )]]},
             # {"doctype": "Print Format", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
-            {"doctype": "Custom Field", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True}
+            {"doctype": "Custom Field", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
+            {"doctype":"Terms and Conditions", "filters": [["name" , "in" , ("General" )]],"overwrite": True}
         ]
 # fixtures = [{"doctype": "Report", "filters": [["module" , "in" , ("Business Needed Solutions" )]]}]
 
diff --git a/diff.txt b/diff.txt
index 251f972..f1ac2ce 100644
--- a/diff.txt
+++ b/diff.txt
@@ -1,881 +0,0 @@
-diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-index bd3ebbf..8c8e98a 100644
---- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-@@ -37,9 +37,30 @@ def execute(filters=None):
- 	company = filters.get("company") or frappe.defaults.get_global_default("company")
- 	from_date, to_date = get_fiscal_year_dates(report_date, company)
- 
--	# 1. Get columns & data for Receivable (main) and Payable (secondary).
-+	# Prepare filters for secondary (Receivable) run - map Supplier filters to Customer filters
-+	secondary_filters = frappe._dict(filters.copy())
-+	secondary_filters.party_type = "Customer"
-+	secondary_filters.party = []
-+
-+	if filters.get("party_type") == "Supplier" and filters.get("party"):
-+		party_links = frappe.get_all(
-+			"Party Link",
-+			fields=["primary_party", "primary_role", "secondary_party", "secondary_role"],
-+		)
-+		mapped_customers = set()
-+		for pl in party_links:
-+			# Supplier (primary) -> Customer (secondary)
-+			if pl.secondary_role == "Customer" and pl.primary_party in filters["party"]:
-+				mapped_customers.add(pl.secondary_party)
-+			# Customer (primary) -> Supplier (secondary) where supplier is selected
-+			if pl.primary_role == "Customer" and pl.secondary_party in filters["party"]:
-+				mapped_customers.add(pl.primary_party)
-+
-+		secondary_filters.party = list(mapped_customers)
-+
-+	# 1. Get columns & data for Payable (main) and Receivable (secondary).
- 	main_columns, main_data = AccountsReceivablePayableSummary(filters).run(args)
--	secondary_columns, secondary_data = AccountsReceivablePayableSummary(filters).run(secondary_args)
-+	secondary_columns, secondary_data = AccountsReceivablePayableSummary(secondary_filters).run(secondary_args)
- 
- 	# Add city column if add_supplier_cities is checked
- 	supplier_cities = {}
-@@ -118,11 +139,30 @@ def execute(filters=None):
- 
- 		skip_set.add(secondary)
- 
--	# 5. Get currency fields for adjustments
--	currency_fields = []
--	for col in main_columns:
--		if col.get("fieldtype") == "Currency":
--			currency_fields.append(col["fieldname"])
-+	# 5. Define numeric fields to net (non-ageing)
-+	numeric_fields = [
-+		"invoiced",
-+		"paid",
-+		"credit_note",
-+		"outstanding",
-+		"total_due",
-+		"future_amount",
-+		"opening",
-+	]
-+
-+	if filters.get("show_gl_balance"):
-+		numeric_fields.extend(["gl_balance", "diff"])
-+
-+	if filters.get("show_future_payments"):
-+		numeric_fields.append("remaining_balance")
-+
-+	# Ageing buckets (range1, range2, ...) taken directly from columns
-+	ageing_bucket_fields = [
-+		col.get("fieldname")
-+		for col in main_columns
-+		if col.get("fieldname", "").startswith("range")
-+	]
-+	ageing_bucket_fields = [f for f in ageing_bucket_fields if f]
- 
- 	# 5a. Build mapping of supplier parties to their linked customer parties
- 	# and get customer invoice/paid amounts for those customers
-@@ -198,13 +238,18 @@ def execute(filters=None):
- 			# Make a copy so we don't overwrite main_dict
- 			updated_row = row.copy()
- 			
--			# Subtract AR amounts from AP amounts for all currency fields
- 			sec_row = secondary_dict[party]
- 			updated_row["secondary_party_type"] = sec_row["party_type"]
- 			updated_row["secondary_party"] = sec_row["party"]
- 			updated_row["is_common_party"] = True
- 			
--			for fieldname in currency_fields:
-+			for fieldname in numeric_fields:
-+				updated_row[fieldname] = (
-+					flt(updated_row.get(fieldname, 0.0)) 
-+					- flt(sec_row.get(fieldname, 0.0))
-+				)
-+
-+			for fieldname in ageing_bucket_fields:
- 				updated_row[fieldname] = (
- 					flt(updated_row.get(fieldname, 0.0)) 
- 					- flt(sec_row.get(fieldname, 0.0))
-@@ -241,8 +286,14 @@ def execute(filters=None):
- 							primary_row = secondary_dict[primary_party_for_secondary]
- 							updated_row["secondary_party_type"] = primary_row["party_type"]
- 							updated_row["secondary_party"] = primary_party_for_secondary
--							# Net AP - AR for all currency fields
--							for fieldname in currency_fields:
-+							# Net AP - AR for defined numeric fields
-+							for fieldname in numeric_fields:
-+								updated_row[fieldname] = (
-+									flt(updated_row.get(fieldname, 0.0)) 
-+									- flt(primary_row.get(fieldname, 0.0))
-+								)
-+
-+							for fieldname in ageing_bucket_fields:
- 								updated_row[fieldname] = (
- 									flt(updated_row.get(fieldname, 0.0)) 
- 									- flt(primary_row.get(fieldname, 0.0))
-@@ -260,7 +311,13 @@ def execute(filters=None):
- 						sec_row = secondary_dict[secondary_party]
- 						updated_row["secondary_party_type"] = sec_row["party_type"]
- 						updated_row["secondary_party"] = sec_row["party"]
--						for fieldname in currency_fields:
-+						for fieldname in numeric_fields:
-+							updated_row[fieldname] = (
-+								flt(updated_row.get(fieldname, 0.0)) 
-+								- flt(sec_row.get(fieldname, 0.0))
-+							)
-+
-+						for fieldname in ageing_bucket_fields:
- 							updated_row[fieldname] = (
- 								flt(updated_row.get(fieldname, 0.0)) 
- 								- flt(sec_row.get(fieldname, 0.0))
-diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-index 0e99ed2..c742383 100644
---- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-@@ -181,9 +181,30 @@ def execute(filters=None):
- 		if not customers:
- 			return [], []
- 
-+	# Prepare filters for secondary (Payable) run - map Customer filters to Supplier filters
-+	secondary_filters = frappe._dict(filters.copy())
-+	secondary_filters.party_type = "Supplier"
-+	secondary_filters.party = []
-+
-+	if filters.get("party_type") == "Customer" and filters.get("party"):
-+		party_links = frappe.get_all(
-+			"Party Link",
-+			fields=["primary_party", "primary_role", "secondary_party", "secondary_role"],
-+		)
-+		mapped_suppliers = set()
-+		for pl in party_links:
-+			# Customer (primary) -> Supplier (secondary)
-+			if pl.secondary_role == "Supplier" and pl.primary_party in filters["party"]:
-+				mapped_suppliers.add(pl.secondary_party)
-+			# Supplier (primary) -> Customer (secondary) where the customer is selected
-+			if pl.primary_role == "Supplier" and pl.secondary_party in filters["party"]:
-+				mapped_suppliers.add(pl.primary_party)
-+
-+		secondary_filters.party = list(mapped_suppliers)
-+
- 	# 1. Get columns & data for Receivable (main) and Payable (secondary).
- 	main_columns, main_data = AccountsReceivablePayableSummary(filters).run(args)
--	secondary_columns, secondary_data = AccountsReceivablePayableSummary(filters).run(secondary_args)
-+	secondary_columns, secondary_data = AccountsReceivablePayableSummary(secondary_filters).run(secondary_args)
- 
- 	# Filter main_data based on customers if sales person filter is applied
- 	if customers:
-@@ -263,11 +284,30 @@ def execute(filters=None):
- 
- 		skip_set.add(secondary)
- 
--	# 5. Get currency fields for adjustments
--	currency_fields = []
--	for col in main_columns:
--		if col.get("fieldtype") == "Currency":
--			currency_fields.append(col["fieldname"])
-+	# 5. Define numeric fields to net (non-ageing)
-+	numeric_fields = [
-+		"invoiced",
-+		"paid",
-+		"credit_note",
-+		"outstanding",
-+		"total_due",
-+		"future_amount",
-+		"opening",
-+	]
-+
-+	if filters.get("show_gl_balance"):
-+		numeric_fields.extend(["gl_balance", "diff"])
-+
-+	if filters.get("show_future_payments"):
-+		numeric_fields.append("remaining_balance")
-+
-+	# Ageing buckets (range1, range2, ...) taken directly from columns
-+	ageing_bucket_fields = [
-+		col.get("fieldname")
-+		for col in main_columns
-+		if col.get("fieldname", "").startswith("range")
-+	]
-+	ageing_bucket_fields = [f for f in ageing_bucket_fields if f]
- 
- 	# 5a. Build mapping of customer parties to their linked supplier parties
- 	# and get supplier invoice/received amounts for those suppliers
-@@ -343,13 +383,18 @@ def execute(filters=None):
- 			# Make a copy so we don't overwrite main_dict
- 			updated_row = row.copy()
- 			
--			# Subtract AP amounts from AR amounts for all currency fields
- 			sec_row = secondary_dict[party]
- 			updated_row["secondary_party_type"] = sec_row["party_type"]
- 			updated_row["secondary_party"] = sec_row["party"]
- 			updated_row["is_common_party"] = True
- 			
--			for fieldname in currency_fields:
-+			for fieldname in numeric_fields:
-+				updated_row[fieldname] = (
-+					flt(updated_row.get(fieldname, 0.0)) 
-+					- flt(sec_row.get(fieldname, 0.0))
-+				)
-+
-+			for fieldname in ageing_bucket_fields:
- 				updated_row[fieldname] = (
- 					flt(updated_row.get(fieldname, 0.0)) 
- 					- flt(sec_row.get(fieldname, 0.0))
-@@ -386,8 +431,14 @@ def execute(filters=None):
- 							primary_row = secondary_dict[primary_party_for_secondary]
- 							updated_row["secondary_party_type"] = primary_row["party_type"]
- 							updated_row["secondary_party"] = primary_party_for_secondary
--							# Net AR - AP for all currency fields
--							for fieldname in currency_fields:
-+							# Net AR - AP for defined numeric fields
-+							for fieldname in numeric_fields:
-+								updated_row[fieldname] = (
-+									flt(updated_row.get(fieldname, 0.0)) 
-+									- flt(primary_row.get(fieldname, 0.0))
-+								)
-+
-+							for fieldname in ageing_bucket_fields:
- 								updated_row[fieldname] = (
- 									flt(updated_row.get(fieldname, 0.0)) 
- 									- flt(primary_row.get(fieldname, 0.0))
-@@ -405,7 +456,13 @@ def execute(filters=None):
- 						sec_row = secondary_dict[secondary_party]
- 						updated_row["secondary_party_type"] = sec_row["party_type"]
- 						updated_row["secondary_party"] = sec_row["party"]
--						for fieldname in currency_fields:
-+						for fieldname in numeric_fields:
-+							updated_row[fieldname] = (
-+								flt(updated_row.get(fieldname, 0.0)) 
-+								- flt(sec_row.get(fieldname, 0.0))
-+							)
-+
-+						for fieldname in ageing_bucket_fields:
- 							updated_row[fieldname] = (
- 								flt(updated_row.get(fieldname, 0.0)) 
- 								- flt(sec_row.get(fieldname, 0.0))
-diff --git a/diff.txt b/diff.txt
-index 0a5da47..104aa99 100644
---- a/diff.txt
-+++ b/diff.txt
-@@ -1,625 +0,0 @@
--diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
--index b406f96..bd3ebbf 100644
----- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
--+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
--@@ -6,7 +6,8 @@ from frappe import _, scrub
-- from urllib.parse import quote
-- from frappe.utils import cint, flt
-- from business_needed_solutions.business_needed_solutions.report.pure_accounts_receivable_summary.pure_accounts_receivable_summary import (
---	AccountsReceivablePayableSummary,get_fiscal_year_dates
--+	AccountsReceivablePayableSummary, get_fiscal_year_dates, 
--+	get_supplier_invoice_and_received_amounts, get_customer_invoice_and_paid_amounts
-- )
-- 
-- 
--@@ -123,6 +124,55 @@ def execute(filters=None):
-- 		if col.get("fieldtype") == "Currency":
-- 			currency_fields.append(col["fieldname"])
-- 
--+	# 5a. Build mapping of supplier parties to their linked customer parties
--+	# and get customer invoice/paid amounts for those customers
--+	supplier_to_customer_map = {}
--+	customer_parties_to_query = set()
--+	
--+	for pl in party_links:
--+		# If secondary_role is Customer, then primary_party (Supplier) is linked to a customer
--+		if pl.secondary_role == "Customer":
--+			supplier_to_customer_map[pl.primary_party] = pl.secondary_party
--+			customer_parties_to_query.add(pl.secondary_party)
--+		# If primary_role is Customer, then secondary_party (Supplier) is linked to a customer
--+		if pl.primary_role == "Customer":
--+			supplier_to_customer_map[pl.secondary_party] = pl.primary_party
--+			customer_parties_to_query.add(pl.primary_party)
--+	
--+	# Also include common parties - they are both supplier and customer
--+	for party in common_parties:
--+		supplier_to_customer_map[party] = party
--+		customer_parties_to_query.add(party)
--+	
--+	# Get customer amounts keyed by customer party
--+	customer_amounts_by_customer = {}
--+	if customer_parties_to_query:
--+		customer_amounts_by_customer = get_customer_invoice_and_paid_amounts(
--+			list(customer_parties_to_query),
--+			company,
--+			report_date,
--+			filters.get("show_future_payments", 0),
--+			filters.get("from_date")
--+		)
--+	
--+	# Map customer amounts back to supplier parties
--+	customer_amounts = {}
--+	for supplier_party, customer_party in supplier_to_customer_map.items():
--+		if customer_party in customer_amounts_by_customer:
--+			customer_amounts[supplier_party] = customer_amounts_by_customer[customer_party]
--+	
--+	# 5b. Get supplier invoice and received amounts for all supplier parties
--+	supplier_parties_to_query = list(main_dict.keys())
--+	supplier_amounts = {}
--+	if supplier_parties_to_query:
--+		supplier_amounts = get_supplier_invoice_and_received_amounts(
--+			supplier_parties_to_query,
--+			company,
--+			report_date,
--+			filters.get("show_future_payments", 0),
--+			filters.get("from_date")
--+		)
--+
-- 	# 6. Build the final data with new logic:
-- 	#    - For common parties: categorize by net balance (debit -> Receivable, credit -> Payable)
-- 	#    - For Party Links: still apply netting but respect net balance categorization
--@@ -223,10 +273,27 @@ def execute(filters=None):
-- 				updated_row["city"] = supplier_cities.get(party, updated_row.get("city", ""))
-- 			
-- 			party_name = updated_row.get("party_name") or party
---			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account=undefined&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
--+			
--+			# Get Payable accounts to filter Party GL by account_type
--+			payable_accounts = frappe.get_all(
--+				"Account",
--+				filters={"account_type": "Payable", "company": company},
--+				pluck="name"
--+			)
--+			account_filter = quote(",".join(payable_accounts)) if payable_accounts else "undefined"
--+			
--+			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account={account_filter}&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
-- 			button_html = f'<a href="{gl_url}" target="_blank" class="btn btn-xs btn-default">GL: {party_name}</a>'
-- 
-- 			updated_row["party_gl_link"] = button_html
--+			
--+			# Add the 2 new columns:
--+			# 1. Received Invoice Amount (Supplier's received invoice including debit note)
--+			updated_row["received_invoice_amount"] = flt(supplier_amounts.get(party, {}).get("received_invoice_amount", 0.0))
--+			
--+			# 2. Invoiced Amount (if party linked to customer, then customer's invoiced amount incl credit note)
--+			updated_row["invoiced_amount"] = flt(customer_amounts.get(party, {}).get("invoiced_amount", 0.0))
--+			
-- 			final_data.append(updated_row)
-- 
-- 	main_columns.append(
--@@ -254,6 +321,43 @@ def execute(filters=None):
-- 			"width": 120,
-- 		}
-- 	)
--+	
--+	# Find the index of "Opening Balance" column and insert the 2 new columns after it
--+	opening_balance_index = None
--+	for i, col in enumerate(main_columns):
--+		if col.get("fieldname") == "opening":
--+			opening_balance_index = i
--+			break
--+	
--+	# Add the 2 new columns right after Opening Balance
--+	if opening_balance_index is not None:
--+		insert_index = opening_balance_index + 1
--+		main_columns.insert(insert_index, {
--+			"label": _("Received Invoice Amount"),
--+			"fieldname": "received_invoice_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+		main_columns.insert(insert_index + 1, {
--+			"label": _("Invoiced Amount"),
--+			"fieldname": "invoiced_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+	else:
--+		# Fallback: add at the end if opening balance not found
--+		main_columns.append({
--+			"label": _("Received Invoice Amount"),
--+			"fieldname": "received_invoice_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+		main_columns.append({
--+			"label": _("Invoiced Amount"),
--+			"fieldname": "invoiced_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
-- 
-- 	# 6. You can return the same columns from the main dataset
-- 	#    (they now reflect the differences).
--diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
--index 5e8f3a3..0e99ed2 100644
----- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
--+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
--@@ -44,6 +44,118 @@ def get_fiscal_year_dates(report_date, company):
-- 	return "2023-04-01", "2024-03-31"
-- 
-- 
--+def get_supplier_invoice_and_received_amounts(parties, company, report_date, show_future_payments=0, from_date=None):
--+	"""
--+	Get supplier invoice amounts (including debit notes) for parties that are linked to suppliers.
--+	Uses Purchase Invoice directly like Purchase Register does.
--+	Returns dict: {party: {"received_invoice_amount": x}}
--+	"""
--+	from frappe.query_builder.functions import Sum, Abs
--+	
--+	result = {}
--+	if not parties:
--+		return result
--+	
--+	# Get payable account types
--+	payable_accounts = frappe.get_all(
--+		"Account",
--+		filters={"account_type": "Payable", "company": company},
--+		pluck="name"
--+	)
--+	
--+	if not payable_accounts:
--+		return result
--+	
--+	# Query Purchase Invoices directly (like Purchase Register does)
--+	pi = frappe.qb.DocType("Purchase Invoice")
--+	
--+	# Build query for supplier invoices (Purchase Invoices) including debit notes
--+	# Sum absolute values of base_grand_total to get total invoice amount including debit notes
--+	supplier_invoices_query = (
--+		frappe.qb.from_(pi)
--+		.select(pi.supplier, Sum(Abs(pi.base_grand_total)).as_("amount"))
--+		.where(
--+			(pi.supplier.isin(parties))
--+			& (pi.docstatus == 1)
--+			& (pi.credit_to.isin(payable_accounts))
--+			& (pi.posting_date <= report_date)
--+		)
--+	)
--+	
--+	# Add from_date filter if provided
--+	if from_date:
--+		supplier_invoices_query = supplier_invoices_query.where(pi.posting_date >= from_date)
--+	
--+	supplier_invoices_query = supplier_invoices_query.groupby(pi.supplier)
--+	
--+	invoice_data = supplier_invoices_query.run(as_dict=True)
--+	
--+	# Combine invoice amounts
--+	for row in invoice_data:
--+		party = row["supplier"]
--+		if party not in result:
--+			result[party] = {"received_invoice_amount": 0.0}
--+		result[party]["received_invoice_amount"] = flt(row["amount"])
--+	
--+	return result
--+
--+
--+def get_customer_invoice_and_paid_amounts(parties, company, report_date, show_future_payments=0, from_date=None):
--+	"""
--+	Get customer invoice amounts (Sales Invoices including Credit Notes) for customer parties.
--+	Uses Sales Invoice directly like Sales Register does.
--+	Returns dict: {party: {"invoiced_amount": x}}
--+	"""
--+	from frappe.query_builder.functions import Sum, Abs
--+	
--+	result = {}
--+	if not parties:
--+		return result
--+	
--+	# Get receivable account types
--+	receivable_accounts = frappe.get_all(
--+		"Account",
--+		filters={"account_type": "Receivable", "company": company},
--+		pluck="name"
--+	)
--+	
--+	if not receivable_accounts:
--+		return result
--+	
--+	# Query Sales Invoices directly (like Sales Register does)
--+	si = frappe.qb.DocType("Sales Invoice")
--+	
--+	# Build query for customer invoices (Sales Invoices) including credit notes
--+	# Sum absolute values of base_grand_total to get total invoice amount including credit notes
--+	customer_invoices_query = (
--+		frappe.qb.from_(si)
--+		.select(si.customer, Sum(Abs(si.base_grand_total)).as_("amount"))
--+		.where(
--+			(si.customer.isin(parties))
--+			& (si.docstatus == 1)
--+			& (si.debit_to.isin(receivable_accounts))
--+			& (si.posting_date <= report_date)
--+		)
--+	)
--+	
--+	# Add from_date filter if provided
--+	if from_date:
--+		customer_invoices_query = customer_invoices_query.where(si.posting_date >= from_date)
--+	
--+	customer_invoices_query = customer_invoices_query.groupby(si.customer)
--+	
--+	invoice_data = customer_invoices_query.run(as_dict=True)
--+	
--+	# Combine invoice amounts
--+	for row in invoice_data:
--+		party = row["customer"]
--+		if party not in result:
--+			result[party] = {"invoiced_amount": 0.0}
--+		result[party]["invoiced_amount"] = flt(row["amount"])
--+	
--+	return result
--+
--+
-- 
-- 
-- 
--@@ -157,6 +269,55 @@ def execute(filters=None):
-- 		if col.get("fieldtype") == "Currency":
-- 			currency_fields.append(col["fieldname"])
-- 
--+	# 5a. Build mapping of customer parties to their linked supplier parties
--+	# and get supplier invoice/received amounts for those suppliers
--+	customer_to_supplier_map = {}
--+	supplier_parties_to_query = set()
--+	
--+	for pl in party_links:
--+		# If secondary_role is Supplier, then primary_party (Customer) is linked to a supplier
--+		if pl.secondary_role == "Supplier":
--+			customer_to_supplier_map[pl.primary_party] = pl.secondary_party
--+			supplier_parties_to_query.add(pl.secondary_party)
--+		# If primary_role is Supplier, then secondary_party (Customer) is linked to a supplier
--+		if pl.primary_role == "Supplier":
--+			customer_to_supplier_map[pl.secondary_party] = pl.primary_party
--+			supplier_parties_to_query.add(pl.primary_party)
--+	
--+	# Also include common parties - they are both customer and supplier
--+	for party in common_parties:
--+		customer_to_supplier_map[party] = party
--+		supplier_parties_to_query.add(party)
--+	
--+	# Get supplier amounts keyed by supplier party
--+	supplier_amounts_by_supplier = {}
--+	if supplier_parties_to_query:
--+		supplier_amounts_by_supplier = get_supplier_invoice_and_received_amounts(
--+			list(supplier_parties_to_query),
--+			company,
--+			report_date,
--+			filters.get("show_future_payments", 0),
--+			filters.get("from_date")
--+		)
--+	
--+	# Map supplier amounts back to customer parties
--+	supplier_amounts = {}
--+	for customer_party, supplier_party in customer_to_supplier_map.items():
--+		if supplier_party in supplier_amounts_by_supplier:
--+			supplier_amounts[customer_party] = supplier_amounts_by_supplier[supplier_party]
--+	
--+	# 5b. Get customer invoice and paid amounts for all customer parties
--+	customer_parties_to_query = list(main_dict.keys())
--+	customer_amounts = {}
--+	if customer_parties_to_query:
--+		customer_amounts = get_customer_invoice_and_paid_amounts(
--+			customer_parties_to_query,
--+			company,
--+			report_date,
--+			filters.get("show_future_payments", 0),
--+			filters.get("from_date")
--+		)
--+
-- 	# 6. Build the final data with new logic:
-- 	#    - For common parties: categorize by net balance (debit -> Receivable, credit -> Payable)
-- 	#    - For Party Links: still apply netting but respect net balance categorization
--@@ -253,10 +414,27 @@ def execute(filters=None):
-- 		# Only add if outstanding is positive after adjustments
-- 		if flt(updated_row.get("outstanding", 0.0)) > 0:
-- 			party_name = updated_row.get("party_name") or party
---			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account=undefined&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
--+			
--+			# Get Receivable accounts to filter Party GL by account_type
--+			receivable_accounts = frappe.get_all(
--+				"Account",
--+				filters={"account_type": "Receivable", "company": company},
--+				pluck="name"
--+			)
--+			account_filter = quote(",".join(receivable_accounts)) if receivable_accounts else "undefined"
--+			
--+			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account={account_filter}&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
-- 			button_html = f'<a href="{gl_url}" target="_blank" class="btn btn-xs btn-default">GL: {party_name}</a>'
-- 
-- 			updated_row["party_gl_link"] = button_html
--+			
--+			# Add the 2 new columns:
--+			# 1. Received Invoice Amount (if party linked to supplier, then supplier's received invoice including debit note)
--+			updated_row["received_invoice_amount"] = flt(supplier_amounts.get(party, {}).get("received_invoice_amount", 0.0))
--+			
--+			# 2. Invoiced Amount (Invoices we sent to customer incl credit note)
--+			updated_row["invoiced_amount"] = flt(customer_amounts.get(party, {}).get("invoiced_amount", 0.0))
--+			
-- 			final_data.append(updated_row)
-- 
-- 	main_columns.append(
--@@ -285,6 +463,44 @@ def execute(filters=None):
-- 			"width": 120,
-- 		}
-- 	)
--+	
--+	# Find the index of "Opening Balance" column and insert the 2 new columns after it
--+	opening_balance_index = None
--+	for i, col in enumerate(main_columns):
--+		if col.get("fieldname") == "opening":
--+			opening_balance_index = i
--+			break
--+	
--+	# Add the 2 new columns right after Opening Balance
--+	if opening_balance_index is not None:
--+		insert_index = opening_balance_index + 1
--+		main_columns.insert(insert_index, {
--+			"label": _("Received Invoice Amount"),
--+			"fieldname": "received_invoice_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+		main_columns.insert(insert_index + 1, {
--+			"label": _("Invoiced Amount"),
--+			"fieldname": "invoiced_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+	else:
--+		# Fallback: add at the end if opening balance not found
--+		main_columns.append({
--+			"label": _("Received Invoice Amount"),
--+			"fieldname": "received_invoice_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+		main_columns.append({
--+			"label": _("Invoiced Amount"),
--+			"fieldname": "invoiced_amount",
--+			"fieldtype": "Currency",
--+			"width": 150,
--+		})
--+	
-- 	# 6. You can return the same columns from the main dataset
-- 	#    (they now reflect the differences).
-- 	#    No extra "r_minus_p" column is needed since you replaced
--@@ -308,26 +524,12 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
-- 
-- 		self.get_party_total(args)
-- 
---		party = None
---		for party_type in self.party_type:
---			if self.filters.get(scrub(party_type)):
---				party = self.filters.get(scrub(party_type))
---
---		party_advance_amount = (
---			get_partywise_advanced_payment_amount(
---				self.party_type,
---				self.filters.report_date,
---				self.filters.show_future_payments,
---				self.filters.company,
---				party=party,
---			)
---			or {}
---		)
---
-- 		if self.filters.show_gl_balance:
---			gl_balance_map = get_gl_balance(self.filters.report_date, self.filters.company)
--+			gl_balance_map = get_gl_balance(self.filters.report_date, self.filters.company, self.account_type)
-- 
-- 		# Calculate opening balances
--+		# For Receivable (Asset): debit - credit (positive = customer owes us)
--+		# For Payable (Liability): credit - debit (positive = we owe supplier)
-- 		opening_balances = {}
-- 		if self.filters.get("from_date"):
-- 			for party_type in self.party_type:
--@@ -339,8 +541,16 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
-- 				if not accounts:
-- 					continue
-- 
---				opening_entries = frappe.db.sql("""
---					SELECT party, SUM(debit) - SUM(credit) as balance
--+				# Use different formula based on account type
--+				if self.account_type == "Payable":
--+					# For Payable: credit - debit (positive means we owe)
--+					balance_formula = "SUM(credit) - SUM(debit)"
--+				else:
--+					# For Receivable: debit - credit (positive means customer owes)
--+					balance_formula = "SUM(debit) - SUM(credit)"
--+
--+				opening_entries = frappe.db.sql(f"""
--+					SELECT party, {balance_formula} as balance
-- 					FROM `tabGL Entry`
-- 					WHERE posting_date < %s
-- 					AND party_type = %s
--@@ -384,13 +594,6 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
-- 			# Add opening balance
-- 			row.opening = opening_balances.get(party, 0.0)
-- 
---			# Advance against party
---			row.advance = party_advance_amount.get(party, 0)
---			row.purepaid = row.paid
---			# In AR/AP, advance shown in paid columns,
---			# but in summary report advance shown in separate column
---			row.paid -= row.advance
---
-- 			if self.filters.show_gl_balance:
-- 				row.gl_balance = gl_balance_map.get(party)
-- 				row.diff = flt(row.outstanding) - flt(row.gl_balance)
--@@ -469,8 +672,6 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
-- 				fieldtype="Data",
-- 			)
-- 			self.add_column(_("Opening Balance"), fieldname="opening")
---			self.add_column(_("Invoiced Amount"), fieldname="invoiced")
---			self.add_column(_("Paid Amount"), fieldname="purepaid")
-- 			self.add_column(_("Outstanding Amount"), fieldname="outstanding")
-- 
-- 		if self.filters.show_gl_balance:
--@@ -507,13 +708,38 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
-- 			)
-- 
-- 
---def get_gl_balance(report_date, company):
---	return frappe._dict(
---		frappe.db.get_all(
---			"GL Entry",
---			fields=["party", "sum(debit -  credit)"],
---			filters={"posting_date": ("<=", report_date), "is_cancelled": 0, "company": company},
---			group_by="party",
---			as_list=1,
---		)
---	)
--\ No newline at end of file
--+def get_gl_balance(report_date, company, account_type):
--+	"""
--+	Get GL balance for parties filtered by account_type.
--+	For Receivable (Asset): debit - credit (positive = customer owes us)
--+	For Payable (Liability): credit - debit (positive = we owe supplier)
--+	"""
--+	# Get accounts of the specified account_type
--+	accounts = frappe.get_all(
--+		"Account",
--+		filters={"account_type": account_type, "company": company},
--+		pluck="name"
--+	)
--+	
--+	if not accounts:
--+		return frappe._dict()
--+	
--+	# Use different formula based on account type
--+	if account_type == "Payable":
--+		# For Payable: credit - debit (positive means we owe)
--+		balance_formula = "SUM(credit) - SUM(debit)"
--+	else:
--+		# For Receivable: debit - credit (positive means customer owes)
--+		balance_formula = "SUM(debit) - SUM(credit)"
--+	
--+	balance_data = frappe.db.sql(f"""
--+		SELECT party, {balance_formula} as balance
--+		FROM `tabGL Entry`
--+		WHERE posting_date <= %s
--+		AND account IN %s
--+		AND company = %s
--+		AND is_cancelled = 0
--+		GROUP BY party
--+	""", (report_date, tuple(accounts), company), as_dict=1)
--+	
--+	return frappe._dict([(d.party, d.balance) for d in balance_data if d.party])
--\ No newline at end of file
--diff --git a/diff.txt b/diff.txt
--index 075d3d6..3ddfe0d 100644
----- a/diff.txt
--+++ b/diff.txt
--@@ -1,101 +0,0 @@
---diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
---index 9534667..8ca7ab3 100644
------ a/business_needed_solutions/fixtures/custom_field.json
---+++ b/business_needed_solutions/fixtures/custom_field.json
---@@ -2392,5 +2392,62 @@
---   "translatable": 0,
---   "unique": 0,
---   "width": null
---+ },
---+ {
---+  "allow_in_quick_entry": 0,
---+  "allow_on_submit": 0,
---+  "bold": 0,
---+  "collapsible": 0,
---+  "collapsible_depends_on": null,
---+  "columns": 0,
---+  "default": "0",
---+  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock')",
---+  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings.",
---+  "docstatus": 0,
---+  "doctype": "Custom Field",
---+  "dt": "Warehouse",
---+  "fetch_from": null,
---+  "fetch_if_empty": 0,
---+  "fieldname": "bns_disallow_negative_stock",
---+  "fieldtype": "Check",
---+  "hidden": 0,
---+  "hide_border": 0,
---+  "hide_days": 0,
---+  "hide_seconds": 0,
---+  "ignore_user_permissions": 0,
---+  "ignore_xss_filter": 0,
---+  "in_global_search": 0,
---+  "in_list_view": 0,
---+  "in_preview": 0,
---+  "in_standard_filter": 0,
---+  "insert_after": "is_rejected_warehouse",
---+  "is_system_generated": 0,
---+  "is_virtual": 0,
---+  "label": "Disallow Negative Stock",
---+  "length": 0,
---+  "link_filters": null,
---+  "mandatory_depends_on": null,
---+  "modified": "2025-01-27 10:00:00.000000",
---+  "module": "Business Needed Solutions",
---+  "name": "Warehouse-bns_disallow_negative_stock",
---+  "no_copy": 0,
---+  "non_negative": 0,
---+  "options": null,
---+  "permlevel": 0,
---+  "placeholder": null,
---+  "precision": "",
---+  "print_hide": 0,
---+  "print_hide_if_no_value": 0,
---+  "print_width": null,
---+  "read_only": 0,
---+  "read_only_depends_on": null,
---+  "report_hide": 0,
---+  "reqd": 0,
---+  "search_index": 0,
---+  "show_dashboard": 0,
---+  "sort_options": 0,
---+  "translatable": 0,
---+  "unique": 0,
---+  "width": null
---  }
--- ]
---\ No newline at end of file
---diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
---index 3827d72..a3e12af 100644
------ a/business_needed_solutions/hooks.py
---+++ b/business_needed_solutions/hooks.py
---@@ -63,7 +63,10 @@ doctype_js = {
---               # Purchase Documents
---               "Purchase Invoice" : "public/js/doctype_item_grid_controls.js",
---               "Purchase Order" : "public/js/doctype_item_grid_controls.js",
----              "Purchase Receipt" : ["public/js/purchase_receipt_form.js", "public/js/doctype_item_grid_controls.js"]
---+              "Purchase Receipt" : ["public/js/purchase_receipt_form.js", "public/js/doctype_item_grid_controls.js"],
---+              
---+              # Warehouse
---+              "Warehouse" : "public/js/warehouse.js"
--- }
--- 
--- 
---@@ -184,6 +187,9 @@ doc_events = {
---     "Item": {
---         "validate": "business_needed_solutions.business_needed_solutions.overrides.item_validation.validate_expense_account_for_non_stock_items"
---     },
---+    "Stock Ledger Entry": {
---+        "validate": "business_needed_solutions.business_needed_solutions.overrides.warehouse_negative_stock.validate_sle_warehouse_negative_stock"
---+    },
---     "Stock Entry": {
---         "on_submit": "business_needed_solutions.business_needed_solutions.overrides.submission_restriction.validate_submission_permission"
---     },
---@@ -346,3 +352,6 @@ fixtures = [
--- # Migration hook to ensure BNS settings are applied after migrations
--- after_migrate = "business_needed_solutions.business_needed_solutions.migration.after_migrate"
--- 
---+# Apply warehouse negative stock restriction patches on app initialization
---+after_app_init = "business_needed_solutions.business_needed_solutions.overrides.warehouse_negative_stock.apply_patches"
---+
