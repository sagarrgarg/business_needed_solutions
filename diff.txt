diff --git a/business_needed_solutions/business_needed_solutions/report/internal_transfer_receive_mismatch/internal_transfer_receive_mismatch.py b/business_needed_solutions/business_needed_solutions/report/internal_transfer_receive_mismatch/internal_transfer_receive_mismatch.py
index c2480e9..6db2e20 100644
--- a/business_needed_solutions/business_needed_solutions/report/internal_transfer_receive_mismatch/internal_transfer_receive_mismatch.py
+++ b/business_needed_solutions/business_needed_solutions/report/internal_transfer_receive_mismatch/internal_transfer_receive_mismatch.py
@@ -24,6 +24,19 @@ import frappe
 from frappe import _
 from frappe.utils import today, flt
 
+# No tolerance: compare rounded values so matching SI-PI (e.g. after link_si_pi) are not falsely reported as mismatch.
+# Amounts: round to 2 decimals; qty: round to 6 decimals. This avoids float representation noise without allowing any business tolerance.
+
+
+def _amounts_equal(a, b):
+	"""Compare amounts with no tolerance; round to 2 decimals."""
+	return round(flt(a or 0), 2) == round(flt(b or 0), 2)
+
+
+def _qtys_equal(a, b):
+	"""Compare quantities with no tolerance; round to 6 decimals."""
+	return round(flt(a or 0), 6) == round(flt(b or 0), 6)
+
 
 @frappe.whitelist()
 def company_address_query(doctype, txt, searchfield, start, page_len, filters):
@@ -721,26 +734,26 @@ def check_si_pi_mismatch(si_name, si_items, si_doc):
 				total_pi_net_amount += flt(pi_item.get("pi_net_amount") or 0)
 				total_pi_base_net_amount += flt(pi_item.get("pi_base_net_amount") or 0)
 			
-			# Check quantity match
+			# Check quantity match (no tolerance; rounded comparison)
 			if si_stock_qty > 0:
-				if abs(si_stock_qty - total_pi_stock_qty) > 0.01:  # Allow difference of 0.01
+				if not _qtys_equal(si_stock_qty, total_pi_stock_qty):
 					qty_mismatches.append({
 						"item": si_item.get("item_code") or "",
 						"si_qty": si_stock_qty,
 						"pi_qty": total_pi_stock_qty
 					})
 			else:
-				if abs(si_qty - total_pi_qty) > 0.01:  # Allow difference of 0.01
+				if not _qtys_equal(si_qty, total_pi_qty):
 					qty_mismatches.append({
 						"item": si_item.get("item_code") or "",
 						"si_qty": si_qty,
 						"pi_qty": total_pi_qty
 					})
 			
-			# Check taxable value mismatch
+			# Check taxable value mismatch (no tolerance; rounded comparison)
 			si_taxable_value = si_base_net_amount if si_base_net_amount > 0 else si_net_amount
 			pi_taxable_value = total_pi_base_net_amount if total_pi_base_net_amount > 0 else total_pi_net_amount
-			if abs(si_taxable_value - pi_taxable_value) > 5.0:  # Allow difference of ₹5
+			if not _amounts_equal(si_taxable_value, pi_taxable_value):
 				taxable_value_mismatches.append({
 					"item": si_item.get("item_code") or "",
 					"si_taxable_value": si_taxable_value,
@@ -771,32 +784,81 @@ def check_si_pi_mismatch(si_name, si_items, si_doc):
 	except Exception as e:
 		frappe.log_error(f"Error checking extra PI items: {str(e)}")
 	
-	# Check grand total mismatch
+	# Check grand total mismatch (no tolerance; rounded comparison)
 	grand_total_mismatch = None
-	if abs(flt(si_doc.grand_total or 0) - pi_grand_total) > 5.0:  # Allow difference of ₹5
+	if not _amounts_equal(si_doc.grand_total, pi_grand_total):
 		grand_total_mismatch = {
 			"si_total": flt(si_doc.grand_total or 0),
 			"pi_total": pi_grand_total,
 			"diff": flt(si_doc.grand_total or 0) - pi_grand_total
 		}
 	
-	# Check tax mismatch (compare in company currency - base_total_taxes_and_charges)
+	# Check tax mismatch (compare in company currency - base_total_taxes_and_charges; no tolerance)
 	tax_mismatch = None
 	si_base_taxes = flt(si_doc.base_total_taxes_and_charges or 0)
 	if si_base_taxes == 0:
-		# Fallback to total_taxes_and_charges if base not available
 		si_base_taxes = flt(si_doc.total_taxes_and_charges or 0)
 	if pi_base_taxes == 0:
-		# Fallback to total_taxes_and_charges if base not available
 		pi_base_taxes = pi_total_taxes
 	
-	if abs(si_base_taxes - pi_base_taxes) > 0.01:
+	if not _amounts_equal(si_base_taxes, pi_base_taxes):
 		tax_mismatch = {
 			"si_tax": si_base_taxes,
 			"pi_tax": pi_base_taxes,
 			"diff": si_base_taxes - pi_base_taxes
 		}
-	
+
+	# Fallback: when item-level linking is incomplete (missing/extra items) but no qty/taxable mismatch,
+	# compare by aggregated item_code totals. Ensures explicitly linked SI-PI (e.g. via link_si_pi) with
+	# matching items/qty/taxable value are not falsely reported as mismatch.
+	if (missing_items or extra_items) and not qty_mismatches and not taxable_value_mismatches:
+		all_pi_items_for_agg = frappe.db.sql(all_pi_items_query, (pi_name,), as_dict=True) or []
+		if all_pi_items_for_agg:
+			si_agg = {}
+			for si_item in si_items:
+				ic = si_item.get("item_code") or ""
+				q = flt(si_item.get("qty") or 0)
+				sq = flt(si_item.get("stock_qty") or q)
+				na = flt(si_item.get("net_amount") or 0)
+				bna = flt(si_item.get("base_net_amount") or 0)
+				if ic not in si_agg:
+					si_agg[ic] = {"qty": 0, "stock_qty": 0, "net_amount": 0, "base_net_amount": 0}
+				si_agg[ic]["qty"] += q
+				si_agg[ic]["stock_qty"] += sq
+				si_agg[ic]["net_amount"] += na
+				si_agg[ic]["base_net_amount"] += bna
+			pi_agg = {}
+			for pi_item in all_pi_items_for_agg:
+				ic = pi_item.get("item_code") or ""
+				q = flt(pi_item.get("qty") or 0)
+				na = flt(pi_item.get("net_amount") or 0)
+				bna = flt(pi_item.get("base_net_amount") or 0)
+				if ic not in pi_agg:
+					pi_agg[ic] = {"qty": 0, "net_amount": 0, "base_net_amount": 0}
+				pi_agg[ic]["qty"] += q
+				pi_agg[ic]["net_amount"] += na
+				pi_agg[ic]["base_net_amount"] += bna
+			agg_match = True
+			for ic, s in si_agg.items():
+				if ic not in pi_agg:
+					agg_match = False
+					break
+				p = pi_agg[ic]
+				if not _qtys_equal(s["qty"], p["qty"]):
+					agg_match = False
+					break
+				sv = s["base_net_amount"] if s["base_net_amount"] > 0 else s["net_amount"]
+				pv = p["base_net_amount"] if p["base_net_amount"] > 0 else p["net_amount"]
+				if not _amounts_equal(sv, pv):
+					agg_match = False
+					break
+			for ic in pi_agg:
+				if ic not in si_agg:
+					agg_match = False
+					break
+			if agg_match and not grand_total_mismatch and not tax_mismatch:
+				return None
+
 	# Build mismatch reason
 	if missing_items or qty_mismatches or taxable_value_mismatches or extra_items or grand_total_mismatch or tax_mismatch:
 		all_mismatches = []
diff --git a/business_needed_solutions/business_needed_solutions/utils.py b/business_needed_solutions/business_needed_solutions/utils.py
index d31a2da..2a71247 100644
--- a/business_needed_solutions/business_needed_solutions/utils.py
+++ b/business_needed_solutions/business_needed_solutions/utils.py
@@ -491,6 +491,9 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
         
         # Set represents_company so ERPNext's is_internal_transfer() works
         target_doc.represents_company = source_doc.company
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Handle addresses
         _update_addresses(target_doc, source_doc)
@@ -522,6 +525,9 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
         
         # Set represents_company so ERPNext's is_internal_transfer() works
         target_doc.represents_company = source_doc.company
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Update delivery note with reference
         _update_delivery_note_reference(source_doc.name, target_doc.name)
@@ -1110,6 +1116,9 @@ def _update_details_pi(source_doc, target_doc, source_parent) -> None:
         
         # Set supplier_invoice_number (bill_no) = SI name (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.bill_no = source_doc.name
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Handle addresses
         _update_addresses_pi(target_doc, source_doc)
@@ -1132,6 +1141,9 @@ def _update_details_pi(source_doc, target_doc, source_parent) -> None:
         
         # Set is_bns_internal_supplier = 1 (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.is_bns_internal_supplier = 1
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Set supplier_invoice_number (bill_no) = SI name (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.bill_no = source_doc.name
@@ -1451,6 +1463,9 @@ def _update_details_pr_from_si(source_doc, target_doc, source_parent) -> None:
         
         # Set supplier_delivery_note = SI name (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.supplier_delivery_note = source_doc.name
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Set is_bns_internal_customer = 0 (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.is_bns_internal_customer = 0
@@ -1468,6 +1483,9 @@ def _update_details_pr_from_si(source_doc, target_doc, source_parent) -> None:
         
         # Set supplier_delivery_note = SI name (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.supplier_delivery_note = source_doc.name
+
+        if getattr(source_doc, "custom_destination", None):
+            target_doc.custom_destination = source_doc.custom_destination
         
         # Set is_bns_internal_customer = 0 (TRANSFER UNDER DIFFERENT GSTIN)
         target_doc.is_bns_internal_customer = 0
@@ -1865,26 +1883,26 @@ def validate_si_pi_items_match(sales_invoice: str, purchase_invoice: str, check_
                 })
             else:
                 pi_data = pi_items[item_code]
-                # Check stock_qty first, then qty
+                # Check stock_qty first, then qty (no tolerance: rounded comparison)
                 if si_data["stock_qty"] > 0:
-                    if abs(si_data["stock_qty"] - pi_data["stock_qty"]) > 0.001:
+                    if round(flt(si_data["stock_qty"]), 6) != round(flt(pi_data["stock_qty"]), 6):
                         qty_mismatches.append({
                             "item_code": item_code,
                             "si_qty": si_data["stock_qty"],
                             "pi_qty": pi_data["stock_qty"]
                         })
-                elif abs(si_data["qty"] - pi_data["qty"]) > 0.001:
+                elif round(flt(si_data["qty"]), 6) != round(flt(pi_data["qty"]), 6):
                     qty_mismatches.append({
                         "item_code": item_code,
                         "si_qty": si_data["qty"],
                         "pi_qty": pi_data["qty"]
                     })
                 
-                # Check taxable value mismatch if check_all is True
+                # Check taxable value mismatch if check_all is True (no tolerance)
                 if check_all:
                     si_taxable_value = si_data["base_net_amount"] if si_data["base_net_amount"] > 0 else si_data["net_amount"]
                     pi_taxable_value = pi_data["base_net_amount"] if pi_data["base_net_amount"] > 0 else pi_data["net_amount"]
-                    if abs(si_taxable_value - pi_taxable_value) > 0.01:
+                    if round(flt(si_taxable_value), 2) != round(flt(pi_taxable_value), 2):
                         taxable_value_mismatches.append({
                             "item_code": item_code,
                             "si_taxable_value": si_taxable_value,
@@ -1907,24 +1925,22 @@ def validate_si_pi_items_match(sales_invoice: str, purchase_invoice: str, check_
         if check_all:
             si_grand_total = flt(si.grand_total or 0)
             pi_grand_total = flt(pi.grand_total or 0)
-            if abs(si_grand_total - pi_grand_total) > 0.01:
+            if round(si_grand_total, 2) != round(pi_grand_total, 2):
                 grand_total_mismatch = {
                     "si_total": si_grand_total,
                     "pi_total": pi_grand_total,
                     "diff": si_grand_total - pi_grand_total
                 }
             
-            # Compare total taxes and charges in company currency
+            # Compare total taxes and charges in company currency (no tolerance)
             si_base_taxes = flt(si.base_total_taxes_and_charges or 0)
             if si_base_taxes == 0:
-                # Fallback to total_taxes_and_charges if base not available
                 si_base_taxes = flt(si.total_taxes_and_charges or 0)
             pi_base_taxes = flt(pi.base_total_taxes_and_charges or 0)
             if pi_base_taxes == 0:
-                # Fallback to total_taxes_and_charges if base not available
                 pi_base_taxes = flt(pi.total_taxes_and_charges or 0)
             
-            if abs(si_base_taxes - pi_base_taxes) > 0.01:
+            if round(si_base_taxes, 2) != round(pi_base_taxes, 2):
                 tax_mismatch = {
                     "si_tax": si_base_taxes,
                     "pi_tax": pi_base_taxes,
@@ -1963,6 +1979,64 @@ def validate_si_pi_items_match(sales_invoice: str, purchase_invoice: str, check_
         frappe.throw(_("Error validating items: {0}").format(str(e)))
 
 
+def _match_and_set_item_references(si, pi) -> int:
+    """
+    Match SI items to PI items by item_code + qty and set sales_invoice_item on PI items.
+    Uses exact qty match first, then first-available partial match.
+    Returns the number of PI items updated.
+    """
+    si_item_map = defaultdict(list)
+    for si_item in si.items:
+        si_item_map[si_item.item_code].append({
+            "name": si_item.name,
+            "qty": flt(si_item.qty or 0),
+            "stock_qty": flt(si_item.stock_qty or si_item.qty or 0),
+            "remaining_qty": flt(si_item.qty or 0),
+            "remaining_stock_qty": flt(si_item.stock_qty or si_item.qty or 0),
+        })
+
+    count = 0
+    for pi_item in pi.items:
+        item_code = pi_item.item_code
+        pi_qty = flt(pi_item.qty or 0)
+        pi_stock_qty = flt(pi_item.stock_qty or pi_qty)
+
+        if item_code not in si_item_map or not si_item_map[item_code]:
+            continue
+
+        matched = False
+        for si_item_data in si_item_map[item_code]:
+            if si_item_data["remaining_qty"] <= 0:
+                continue
+            if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
+                if round(pi_stock_qty, 6) == round(si_item_data["remaining_stock_qty"], 6):
+                    pi_item.db_set("sales_invoice_item", si_item_data["name"], update_modified=False)
+                    si_item_data["remaining_qty"] = 0
+                    si_item_data["remaining_stock_qty"] = 0
+                    matched = True
+                    count += 1
+                    break
+            elif round(pi_qty, 6) == round(si_item_data["remaining_qty"], 6):
+                pi_item.db_set("sales_invoice_item", si_item_data["name"], update_modified=False)
+                si_item_data["remaining_qty"] = 0
+                si_item_data["remaining_stock_qty"] = 0
+                matched = True
+                count += 1
+                break
+
+        if not matched:
+            for si_item_data in si_item_map[item_code]:
+                if si_item_data["remaining_qty"] > 0:
+                    pi_item.db_set("sales_invoice_item", si_item_data["name"], update_modified=False)
+                    if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
+                        si_item_data["remaining_stock_qty"] -= pi_stock_qty
+                    else:
+                        si_item_data["remaining_qty"] -= pi_qty
+                    count += 1
+                    break
+    return count
+
+
 @frappe.whitelist()
 def convert_sales_invoice_to_bns_internal(sales_invoice: str, purchase_invoice: Optional[str] = None) -> Dict:
     """
@@ -2085,101 +2159,30 @@ def convert_sales_invoice_to_bns_internal(sales_invoice: str, purchase_invoice:
                     )
                 )
             
-            # Match SI items to PI items and update item-wise references
-            # Create mapping: item_code -> list of (si_item, remaining_qty)
-            si_item_map = {}
-            for si_item in si.items:
-                item_code = si_item.item_code
-                if item_code not in si_item_map:
-                    si_item_map[item_code] = []
-                si_item_map[item_code].append({
-                    "name": si_item.name,
-                    "qty": si_item.qty or 0,
-                    "stock_qty": si_item.stock_qty or (si_item.qty or 0),
-                    "remaining_qty": si_item.qty or 0,
-                    "remaining_stock_qty": si_item.stock_qty or (si_item.qty or 0)
-                })
-            
-            # Match PI items to SI items and update sales_invoice_item field
-            pi_items_to_update = []
-            for pi_item in pi.items:
-                item_code = pi_item.item_code
-                pi_qty = pi_item.qty or 0
-                pi_stock_qty = pi_item.stock_qty or pi_qty
-                
-                if item_code in si_item_map and si_item_map[item_code]:
-                    # Find matching SI item(s) for this PI item
-                    matched = False
-                    for si_item_data in si_item_map[item_code]:
-                        if si_item_data["remaining_qty"] <= 0:
-                            continue
-                        
-                        # Check if quantities match (prefer stock_qty if available)
-                        if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
-                            if abs(pi_stock_qty - si_item_data["remaining_stock_qty"]) < 0.001:
-                                # Perfect match
-                                pi_items_to_update.append({
-                                    "name": pi_item.name,
-                                    "sales_invoice_item": si_item_data["name"]
-                                })
-                                si_item_data["remaining_qty"] = 0
-                                si_item_data["remaining_stock_qty"] = 0
-                                matched = True
-                                break
-                        elif abs(pi_qty - si_item_data["remaining_qty"]) < 0.001:
-                            # Match by qty
-                            pi_items_to_update.append({
-                                "name": pi_item.name,
-                                "sales_invoice_item": si_item_data["name"]
-                            })
-                            si_item_data["remaining_qty"] = 0
-                            si_item_data["remaining_stock_qty"] = 0
-                            matched = True
-                            break
-                    
-                    # If no exact match found, match with first available SI item (partial match)
-                    if not matched:
-                        for si_item_data in si_item_map[item_code]:
-                            if si_item_data["remaining_qty"] > 0:
-                                pi_items_to_update.append({
-                                    "name": pi_item.name,
-                                    "sales_invoice_item": si_item_data["name"]
-                                })
-                                # Reduce remaining quantity
-                                if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
-                                    si_item_data["remaining_stock_qty"] -= pi_stock_qty
-                                else:
-                                    si_item_data["remaining_qty"] -= pi_qty
-                                matched = True
-                                break
-            
+            # Match SI items to PI items and set sales_invoice_item on PI items
+            n_updated = _match_and_set_item_references(si, pi)
+
             # Update Purchase Invoice document-level fields first
             frappe.db.set_value("Purchase Invoice", pi.name, {
                 "is_bns_internal_supplier": 1,
                 "bns_inter_company_reference": si.name,
                 "status": "BNS Internally Transferred"
             }, update_modified=False)
-            
-            # Update item-wise sales_invoice_item references
-            for item_update in pi_items_to_update:
-                frappe.db.set_value("Purchase Invoice Item", item_update["name"], {
-                    "sales_invoice_item": item_update["sales_invoice_item"]
-                }, update_modified=False)
-            
+
             # Reload PI to get updated values
             pi.reload()
-            
+
             # Then update Sales Invoice
             si.db_set("bns_inter_company_reference", pi.name, update_modified=False)
-            
+
             # Clear cache for both documents
             frappe.clear_cache(doctype="Purchase Invoice")
             frappe.clear_cache(doctype="Sales Invoice")
-            
+
             result["purchase_invoice"] = pi.name
             result["message"] = _("Sales Invoice and Purchase Invoice linked successfully")
-            
-            logger.info(f"Linked Sales Invoice {si.name} with Purchase Invoice {pi.name}, updated {len(pi_items_to_update)} item references")
+
+            logger.info(f"Linked Sales Invoice {si.name} with Purchase Invoice {pi.name}, updated {n_updated} item references")
         
         frappe.clear_cache(doctype="Sales Invoice")
         
@@ -2313,97 +2316,26 @@ def convert_purchase_invoice_to_bns_internal(purchase_invoice: str, sales_invoic
                     )
                 )
             
-            # Match SI items to PI items and update item-wise references
-            # Create mapping: item_code -> list of (si_item, remaining_qty)
-            si_item_map = {}
-            for si_item in si.items:
-                item_code = si_item.item_code
-                if item_code not in si_item_map:
-                    si_item_map[item_code] = []
-                si_item_map[item_code].append({
-                    "name": si_item.name,
-                    "qty": si_item.qty or 0,
-                    "stock_qty": si_item.stock_qty or (si_item.qty or 0),
-                    "remaining_qty": si_item.qty or 0,
-                    "remaining_stock_qty": si_item.stock_qty or (si_item.qty or 0)
-                })
-            
-            # Match PI items to SI items and update sales_invoice_item field
-            pi_items_to_update = []
-            for pi_item in pi.items:
-                item_code = pi_item.item_code
-                pi_qty = pi_item.qty or 0
-                pi_stock_qty = pi_item.stock_qty or pi_qty
-                
-                if item_code in si_item_map and si_item_map[item_code]:
-                    # Find matching SI item(s) for this PI item
-                    matched = False
-                    for si_item_data in si_item_map[item_code]:
-                        if si_item_data["remaining_qty"] <= 0:
-                            continue
-                        
-                        # Check if quantities match (prefer stock_qty if available)
-                        if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
-                            if abs(pi_stock_qty - si_item_data["remaining_stock_qty"]) < 0.001:
-                                # Perfect match
-                                pi_items_to_update.append({
-                                    "name": pi_item.name,
-                                    "sales_invoice_item": si_item_data["name"]
-                                })
-                                si_item_data["remaining_qty"] = 0
-                                si_item_data["remaining_stock_qty"] = 0
-                                matched = True
-                                break
-                        elif abs(pi_qty - si_item_data["remaining_qty"]) < 0.001:
-                            # Match by qty
-                            pi_items_to_update.append({
-                                "name": pi_item.name,
-                                "sales_invoice_item": si_item_data["name"]
-                            })
-                            si_item_data["remaining_qty"] = 0
-                            si_item_data["remaining_stock_qty"] = 0
-                            matched = True
-                            break
-                    
-                    # If no exact match found, match with first available SI item (partial match)
-                    if not matched:
-                        for si_item_data in si_item_map[item_code]:
-                            if si_item_data["remaining_qty"] > 0:
-                                pi_items_to_update.append({
-                                    "name": pi_item.name,
-                                    "sales_invoice_item": si_item_data["name"]
-                                })
-                                # Reduce remaining quantity
-                                if pi_stock_qty > 0 and si_item_data["remaining_stock_qty"] > 0:
-                                    si_item_data["remaining_stock_qty"] -= pi_stock_qty
-                                else:
-                                    si_item_data["remaining_qty"] -= pi_qty
-                                matched = True
-                                break
-            
+            # Match SI items to PI items and set sales_invoice_item on PI items
+            n_updated = _match_and_set_item_references(si, pi)
+
             # Update Purchase Invoice document-level fields first
             frappe.db.set_value("Purchase Invoice", pi.name, {
                 "is_bns_internal_supplier": 1,
                 "bns_inter_company_reference": si.name,
                 "status": "BNS Internally Transferred"
             }, update_modified=False)
-            
-            # Update item-wise sales_invoice_item references
-            for item_update in pi_items_to_update:
-                frappe.db.set_value("Purchase Invoice Item", item_update["name"], {
-                    "sales_invoice_item": item_update["sales_invoice_item"]
-                }, update_modified=False)
-            
+
             # Reload PI to get updated values
             pi.reload()
-            
+
             # Then update Sales Invoice
             si.db_set("bns_inter_company_reference", pi.name, update_modified=False)
             if si.status != "BNS Internally Transferred":
                 si.db_set("status", "BNS Internally Transferred", update_modified=False)
             if not si.get("is_bns_internal_customer"):
                 si.db_set("is_bns_internal_customer", 1, update_modified=False)
-            
+
             # Clear cache for both documents
             frappe.clear_cache(doctype="Purchase Invoice")
             frappe.clear_cache(doctype="Sales Invoice")
@@ -2411,7 +2343,7 @@ def convert_purchase_invoice_to_bns_internal(purchase_invoice: str, sales_invoic
             result["sales_invoice"] = si.name
             result["message"] = _("Purchase Invoice and Sales Invoice linked successfully")
             
-            logger.info(f"Linked Purchase Invoice {pi.name} with Sales Invoice {si.name}, updated {len(pi_items_to_update)} item references")
+            logger.info(f"Linked Purchase Invoice {pi.name} with Sales Invoice {si.name}, updated {n_updated} item references")
         
         frappe.clear_cache(doctype="Purchase Invoice")
         
@@ -3163,24 +3095,34 @@ def unlink_dn_pr(delivery_note: str = None, purchase_receipt: str = None) -> Dic
                     "message": _("Cleared reference from Purchase Receipt")
                 }
         
-        # Validate both documents exist
-        dn = frappe.get_doc("Delivery Note", delivery_note)
-        pr = frappe.get_doc("Purchase Receipt", purchase_receipt)
-        
-        # Remove bidirectional references - clear both sides regardless of current state
-        # This allows unlinking even if one side doesn't have the reference
-        if dn.get("bns_inter_company_reference"):
-            dn.db_set("bns_inter_company_reference", "", update_modified=False)
-        
-        if pr.get("bns_inter_company_reference"):
-            pr.db_set("bns_inter_company_reference", "", update_modified=False)
+        # Clear each side independently — the contra document may have been
+        # cancelled or deleted, so we must not crash when it is missing.
+        dn_cleared = False
+        pr_cleared = False
+        
+        if delivery_note:
+            if frappe.db.exists("Delivery Note", delivery_note):
+                dn = frappe.get_doc("Delivery Note", delivery_note)
+                if dn.get("bns_inter_company_reference"):
+                    dn.db_set("bns_inter_company_reference", "", update_modified=False)
+                dn_cleared = True
+            else:
+                logger.warning(f"Delivery Note {delivery_note} does not exist — skipping its side of unlink")
         
-        # Note: We don't change status or flags as they might be set for other reasons
-        # Only remove the inter-company reference
+        if purchase_receipt:
+            if frappe.db.exists("Purchase Receipt", purchase_receipt):
+                pr = frappe.get_doc("Purchase Receipt", purchase_receipt)
+                if pr.get("bns_inter_company_reference"):
+                    pr.db_set("bns_inter_company_reference", "", update_modified=False)
+                pr_cleared = True
+            else:
+                logger.warning(f"Purchase Receipt {purchase_receipt} does not exist — skipping its side of unlink")
         
-        # Clear cache
-        frappe.clear_cache(doctype="Delivery Note")
-        frappe.clear_cache(doctype="Purchase Receipt")
+        # Clear cache for whichever sides were touched
+        if dn_cleared:
+            frappe.clear_cache(doctype="Delivery Note")
+        if pr_cleared:
+            frappe.clear_cache(doctype="Purchase Receipt")
         
         logger.info(f"Unlinked Delivery Note {delivery_note} from Purchase Receipt {purchase_receipt}")
         
@@ -3278,15 +3220,9 @@ def link_si_pi(sales_invoice: str, purchase_invoice: str) -> Dict:
         si.db_set("bns_inter_company_reference", pi.name, update_modified=False)
         pi.db_set("bns_inter_company_reference", si.name, update_modified=False)
         
-        # Set item-wise references for PI items
-        si_items = si.items
-        pi_items = pi.items
-        
-        if len(si_items) == len(pi_items):
-            for si_item, pi_item in zip(si_items, pi_items):
-                if si_item.item_code == pi_item.item_code:
-                    pi_item.db_set("sales_invoice_item", si_item.name, update_modified=False)
-        
+        # Set item-wise references for PI items (match by item_code + qty)
+        _match_and_set_item_references(si, pi)
+
         # Update status and flags if not already set
         if not si.get("is_bns_internal_customer"):
             si.db_set("is_bns_internal_customer", 1, update_modified=False)
@@ -3361,29 +3297,38 @@ def unlink_si_pi(sales_invoice: str = None, purchase_invoice: str = None) -> Dic
                     "message": _("Cleared reference from Purchase Invoice")
                 }
         
-        # Validate both documents exist
-        si = frappe.get_doc("Sales Invoice", sales_invoice)
-        pi = frappe.get_doc("Purchase Invoice", purchase_invoice)
-        
-        # Remove bidirectional references - clear both sides regardless of current state
-        if si.get("bns_inter_company_reference"):
-            si.db_set("bns_inter_company_reference", "", update_modified=False)
+        # Clear each side independently — the contra document may have been
+        # cancelled or deleted, so we must not crash when it is missing.
+        si_cleared = False
+        pi_cleared = False
         
-        if pi.get("bns_inter_company_reference"):
-            pi.db_set("bns_inter_company_reference", "", update_modified=False)
-        
-        # Clear item-wise references
-        pi_items = pi.items
-        for pi_item in pi_items:
-            if pi_item.get("sales_invoice_item"):
-                pi_item.db_set("sales_invoice_item", "", update_modified=False)
+        if sales_invoice:
+            if frappe.db.exists("Sales Invoice", sales_invoice):
+                si = frappe.get_doc("Sales Invoice", sales_invoice)
+                if si.get("bns_inter_company_reference"):
+                    si.db_set("bns_inter_company_reference", "", update_modified=False)
+                si_cleared = True
+            else:
+                logger.warning(f"Sales Invoice {sales_invoice} does not exist — skipping its side of unlink")
         
-        # Note: We don't change status or flags as they might be set for other reasons
-        # Only remove the inter-company reference
+        if purchase_invoice:
+            if frappe.db.exists("Purchase Invoice", purchase_invoice):
+                pi = frappe.get_doc("Purchase Invoice", purchase_invoice)
+                if pi.get("bns_inter_company_reference"):
+                    pi.db_set("bns_inter_company_reference", "", update_modified=False)
+                # Clear item-wise references
+                for pi_item in pi.items:
+                    if pi_item.get("sales_invoice_item"):
+                        pi_item.db_set("sales_invoice_item", "", update_modified=False)
+                pi_cleared = True
+            else:
+                logger.warning(f"Purchase Invoice {purchase_invoice} does not exist — skipping its side of unlink")
         
-        # Clear cache
-        frappe.clear_cache(doctype="Sales Invoice")
-        frappe.clear_cache(doctype="Purchase Invoice")
+        # Clear cache for whichever sides were touched
+        if si_cleared:
+            frappe.clear_cache(doctype="Sales Invoice")
+        if pi_cleared:
+            frappe.clear_cache(doctype="Purchase Invoice")
         
         logger.info(f"Unlinked Sales Invoice {sales_invoice} from Purchase Invoice {purchase_invoice}")
         
@@ -3659,4 +3604,135 @@ def bulk_convert_to_bns_internal(from_date: str, force: int = 0) -> Dict:
         
     except Exception as e:
         logger.error(f"Error in bulk conversion: {str(e)}")
-        frappe.throw(_("Error in bulk conversion: {0}").format(str(e)))
\ No newline at end of file
+        frappe.throw(_("Error in bulk conversion: {0}").format(str(e)))
+
+
+def _match_and_set_dn_pr_item_references(dn, pr) -> int:
+    """
+    Match DN items to PR items by item_code + qty and set delivery_note_item on PR items.
+    Returns the number of PR items updated.
+    """
+    dn_item_map = defaultdict(list)
+    for dn_item in dn.items:
+        dn_item_map[dn_item.item_code].append({
+            "name": dn_item.name,
+            "qty": flt(dn_item.qty or 0),
+            "stock_qty": flt(dn_item.stock_qty or dn_item.qty or 0),
+            "remaining_qty": flt(dn_item.qty or 0),
+            "remaining_stock_qty": flt(dn_item.stock_qty or dn_item.qty or 0),
+        })
+
+    count = 0
+    for pr_item in pr.items:
+        item_code = pr_item.item_code
+        pr_qty = flt(pr_item.qty or 0)
+        pr_stock_qty = flt(pr_item.stock_qty or pr_qty)
+
+        if item_code not in dn_item_map or not dn_item_map[item_code]:
+            continue
+
+        matched = False
+        for dn_item_data in dn_item_map[item_code]:
+            if dn_item_data["remaining_qty"] <= 0:
+                continue
+            if pr_stock_qty > 0 and dn_item_data["remaining_stock_qty"] > 0:
+                if abs(pr_stock_qty - dn_item_data["remaining_stock_qty"]) < 0.001:
+                    pr_item.db_set("delivery_note_item", dn_item_data["name"], update_modified=False)
+                    dn_item_data["remaining_qty"] = 0
+                    dn_item_data["remaining_stock_qty"] = 0
+                    matched = True
+                    count += 1
+                    break
+            elif abs(pr_qty - dn_item_data["remaining_qty"]) < 0.001:
+                pr_item.db_set("delivery_note_item", dn_item_data["name"], update_modified=False)
+                dn_item_data["remaining_qty"] = 0
+                dn_item_data["remaining_stock_qty"] = 0
+                matched = True
+                count += 1
+                break
+
+        if not matched:
+            for dn_item_data in dn_item_map[item_code]:
+                if dn_item_data["remaining_qty"] > 0:
+                    pr_item.db_set("delivery_note_item", dn_item_data["name"], update_modified=False)
+                    if pr_stock_qty > 0 and dn_item_data["remaining_stock_qty"] > 0:
+                        dn_item_data["remaining_stock_qty"] -= pr_stock_qty
+                    else:
+                        dn_item_data["remaining_qty"] -= pr_qty
+                    count += 1
+                    break
+    return count
+
+
+@frappe.whitelist()
+def backfill_item_references(from_date: str) -> Dict:
+    """
+    Backfill sales_invoice_item on Purchase Invoice items and delivery_note_item on
+    Purchase Receipt items for BNS internal transfers from a given date.
+    Callable via bench console or one-time from BNS Settings.
+    Returns a summary with counts of documents and items fixed.
+    """
+    from_date = frappe.utils.getdate(from_date)
+    pi_docs_fixed = 0
+    pi_items_fixed = 0
+    pr_docs_fixed = 0
+    pr_items_fixed = 0
+
+    # SI-PI: PIs with is_bns_internal_supplier=1, posting_date >= from_date
+    pi_list = frappe.get_all(
+        "Purchase Invoice",
+        filters={
+            "is_bns_internal_supplier": 1,
+            "docstatus": 1,
+            "posting_date": [">=", from_date],
+        },
+        pluck="name",
+    )
+    for pi_name in pi_list:
+        pi = frappe.get_doc("Purchase Invoice", pi_name)
+        si_name = pi.get("bns_inter_company_reference") or pi.get("inter_company_invoice_reference")
+        if not si_name or not frappe.db.exists("Sales Invoice", si_name):
+            continue
+        has_empty = any(not (pi_item.get("sales_invoice_item") or "").strip() for pi_item in pi.items)
+        if not has_empty:
+            continue
+        si = frappe.get_doc("Sales Invoice", si_name)
+        n = _match_and_set_item_references(si, pi)
+        if n > 0:
+            pi_docs_fixed += 1
+            pi_items_fixed += n
+
+    # DN-PR: PRs with is_bns_internal_supplier=1, posting_date >= from_date
+    pr_list = frappe.get_all(
+        "Purchase Receipt",
+        filters={
+            "is_bns_internal_supplier": 1,
+            "docstatus": 1,
+            "posting_date": [">=", from_date],
+        },
+        pluck="name",
+    )
+    for pr_name in pr_list:
+        pr = frappe.get_doc("Purchase Receipt", pr_name)
+        dn_name = pr.get("bns_inter_company_reference") or pr.get("supplier_delivery_note")
+        if not dn_name or not frappe.db.exists("Delivery Note", dn_name):
+            continue
+        has_empty = any(not (pr_item.get("delivery_note_item") or "").strip() for pr_item in pr.items)
+        if not has_empty:
+            continue
+        dn = frappe.get_doc("Delivery Note", dn_name)
+        n = _match_and_set_dn_pr_item_references(dn, pr)
+        if n > 0:
+            pr_docs_fixed += 1
+            pr_items_fixed += n
+
+    return {
+        "success": True,
+        "purchase_invoice_docs_fixed": pi_docs_fixed,
+        "purchase_invoice_items_fixed": pi_items_fixed,
+        "purchase_receipt_docs_fixed": pr_docs_fixed,
+        "purchase_receipt_items_fixed": pr_items_fixed,
+        "message": _(
+            "Backfill complete: {0} Purchase Invoice(s) ({1} items), {2} Purchase Receipt(s) ({3} items)."
+        ).format(pi_docs_fixed, pi_items_fixed, pr_docs_fixed, pr_items_fixed),
+    }
\ No newline at end of file
diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
index 145228f..d33ba9b 100644
--- a/business_needed_solutions/fixtures/custom_field.json
+++ b/business_needed_solutions/fixtures/custom_field.json
@@ -398,6 +398,63 @@
   "unique": 0,
   "width": null
  },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 1,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 1,
+  "default": null,
+  "depends_on": "eval:frappe.db.get_single_value('BNS Settings', 'enable_bns_variance_qty')",
+  "description": "Allowed ±% variance for component qty validation against BOM. Leave empty to use the default from BNS Settings.",
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "BOM Item",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "bns_variance_qty",
+  "fieldtype": "Percent",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "qty",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "Variance (%)",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2026-01-25 10:00:00",
+  "module": "Business Needed Solutions",
+  "name": "BOM Item-bns_variance_qty",
+  "no_copy": 0,
+  "non_negative": 1,
+  "options": null,
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 0,
+  "unique": 0,
+  "width": null
+ },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 0,
@@ -717,7 +774,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:05.960361",
+  "modified": "2026-02-07 18:37:06.432027",
   "module": "Business Needed Solutions",
   "name": "Sales Invoice Item-custom_d1_",
   "no_copy": 0,
@@ -774,7 +831,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:05.960665",
+  "modified": "2026-02-07 18:37:06.432346",
   "module": "Business Needed Solutions",
   "name": "Sales Invoice Item-custom_d2",
   "no_copy": 0,
@@ -831,7 +888,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.306865",
+  "modified": "2026-02-07 18:37:06.790896",
   "module": "Business Needed Solutions",
   "name": "Quotation Item-custom_d1_",
   "no_copy": 0,
@@ -888,7 +945,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:05.960924",
+  "modified": "2026-02-07 18:37:06.432620",
   "module": "Business Needed Solutions",
   "name": "Sales Invoice Item-custom_d3",
   "no_copy": 0,
@@ -945,7 +1002,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.307214",
+  "modified": "2026-02-07 18:37:06.791257",
   "module": "Business Needed Solutions",
   "name": "Quotation Item-custom_d2",
   "no_copy": 0,
@@ -1002,7 +1059,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.217487",
+  "modified": "2026-02-07 18:37:06.697081",
   "module": "Business Needed Solutions",
   "name": "Delivery Note Item-custom_d1_",
   "no_copy": 0,
@@ -1059,7 +1116,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.089754",
+  "modified": "2026-02-07 18:37:06.570179",
   "module": "Business Needed Solutions",
   "name": "Sales Order Item-custom_d1_",
   "no_copy": 0,
@@ -1116,7 +1173,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.307551",
+  "modified": "2026-02-07 18:37:06.791609",
   "module": "Business Needed Solutions",
   "name": "Quotation Item-custom_d3",
   "no_copy": 0,
@@ -1173,7 +1230,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.217833",
+  "modified": "2026-02-07 18:37:06.697429",
   "module": "Business Needed Solutions",
   "name": "Delivery Note Item-custom_d2",
   "no_copy": 0,
@@ -1230,7 +1287,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.090111",
+  "modified": "2026-02-07 18:37:06.570584",
   "module": "Business Needed Solutions",
   "name": "Sales Order Item-custom_d2",
   "no_copy": 0,
@@ -1287,7 +1344,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.218165",
+  "modified": "2026-02-07 18:37:06.697761",
   "module": "Business Needed Solutions",
   "name": "Delivery Note Item-custom_d3",
   "no_copy": 0,
@@ -1344,7 +1401,7 @@
   "length": 0,
   "link_filters": null,
   "mandatory_depends_on": null,
-  "modified": "2026-01-11 20:55:06.090439",
+  "modified": "2026-02-07 18:37:06.570977",
   "module": "Business Needed Solutions",
   "name": "Sales Order Item-custom_d3",
   "no_copy": 0,
@@ -1440,7 +1497,7 @@
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_destination",
-  "fieldtype": "Data",
+  "fieldtype": "Link",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -1463,7 +1520,7 @@
   "name": "Delivery Note-custom_destination",
   "no_copy": 0,
   "non_negative": 0,
-  "options": null,
+  "options": "Location",
   "permlevel": 0,
   "placeholder": null,
   "precision": "",
@@ -1652,6 +1709,63 @@
   "unique": 0,
   "width": null
  },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": null,
+  "depends_on": null,
+  "description": null,
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Purchase Receipt",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "custom_destination",
+  "fieldtype": "Link",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "bns_inter_company_reference",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "Destination",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2025-05-01 11:00:00",
+  "module": "Business Needed Solutions",
+  "name": "Purchase Receipt-custom_destination",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": "Location",
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 1,
+  "unique": 0,
+  "width": null
+ },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 0,
@@ -1679,7 +1793,7 @@
   "in_list_view": 0,
   "in_preview": 0,
   "in_standard_filter": 0,
-  "insert_after": "bns_inter_company_reference",
+  "insert_after": "custom_destination",
   "is_system_generated": 0,
   "is_virtual": 0,
   "label": "Is BNS Internal Supplier",
@@ -2108,6 +2222,63 @@
   "unique": 0,
   "width": null
  },
+ {
+  "allow_in_quick_entry": 0,
+  "allow_on_submit": 0,
+  "bold": 0,
+  "collapsible": 0,
+  "collapsible_depends_on": null,
+  "columns": 0,
+  "default": null,
+  "depends_on": null,
+  "description": null,
+  "docstatus": 0,
+  "doctype": "Custom Field",
+  "dt": "Purchase Invoice",
+  "fetch_from": null,
+  "fetch_if_empty": 0,
+  "fieldname": "custom_destination",
+  "fieldtype": "Link",
+  "hidden": 0,
+  "hide_border": 0,
+  "hide_days": 0,
+  "hide_seconds": 0,
+  "ignore_user_permissions": 0,
+  "ignore_xss_filter": 0,
+  "in_global_search": 0,
+  "in_list_view": 0,
+  "in_preview": 0,
+  "in_standard_filter": 0,
+  "insert_after": "bns_inter_company_reference",
+  "is_system_generated": 0,
+  "is_virtual": 0,
+  "label": "Destination",
+  "length": 0,
+  "link_filters": null,
+  "mandatory_depends_on": null,
+  "modified": "2025-11-24 12:00:00",
+  "module": "Business Needed Solutions",
+  "name": "Purchase Invoice-custom_destination",
+  "no_copy": 0,
+  "non_negative": 0,
+  "options": "Location",
+  "permlevel": 0,
+  "placeholder": null,
+  "precision": "",
+  "print_hide": 0,
+  "print_hide_if_no_value": 0,
+  "print_width": null,
+  "read_only": 0,
+  "read_only_depends_on": null,
+  "report_hide": 0,
+  "reqd": 0,
+  "search_index": 0,
+  "show_dashboard": 0,
+  "sort_options": 0,
+  "translatable": 1,
+  "unique": 0,
+  "width": null
+ },
  {
   "allow_in_quick_entry": 0,
   "allow_on_submit": 0,
@@ -2295,7 +2466,7 @@
   "fetch_from": null,
   "fetch_if_empty": 0,
   "fieldname": "custom_destination",
-  "fieldtype": "Data",
+  "fieldtype": "Link",
   "hidden": 0,
   "hide_border": 0,
   "hide_days": 0,
@@ -2318,7 +2489,7 @@
   "name": "Sales Invoice-custom_destination",
   "no_copy": 0,
   "non_negative": 0,
-  "options": null,
+  "options": "Location",
   "permlevel": 0,
   "placeholder": null,
   "precision": "",
@@ -2620,62 +2791,5 @@
   "translatable": 0,
   "unique": 0,
   "width": null
- },
- {
-  "allow_in_quick_entry": 0,
-  "allow_on_submit": 1,
-  "bold": 0,
-  "collapsible": 0,
-  "collapsible_depends_on": null,
-  "columns": 1,
-  "default": null,
-  "depends_on": "eval:frappe.db.get_single_value('BNS Settings', 'enable_bns_variance_qty')",
-  "description": "Allowed ±% variance for component qty validation against BOM. Leave empty to use the default from BNS Settings.",
-  "docstatus": 0,
-  "doctype": "Custom Field",
-  "dt": "BOM Item",
-  "fetch_from": null,
-  "fetch_if_empty": 0,
-  "fieldname": "bns_variance_qty",
-  "fieldtype": "Percent",
-  "hidden": 0,
-  "hide_border": 0,
-  "hide_days": 0,
-  "hide_seconds": 0,
-  "ignore_user_permissions": 0,
-  "ignore_xss_filter": 0,
-  "in_global_search": 0,
-  "in_list_view": 0,
-  "in_preview": 0,
-  "in_standard_filter": 0,
-  "insert_after": "qty",
-  "is_system_generated": 0,
-  "is_virtual": 0,
-  "label": "Variance (%)",
-  "length": 0,
-  "link_filters": null,
-  "mandatory_depends_on": null,
-  "modified": "2026-01-25 10:00:00.000000",
-  "module": "Business Needed Solutions",
-  "name": "BOM Item-bns_variance_qty",
-  "no_copy": 0,
-  "non_negative": 1,
-  "options": null,
-  "permlevel": 0,
-  "placeholder": null,
-  "precision": "",
-  "print_hide": 0,
-  "print_hide_if_no_value": 0,
-  "print_width": null,
-  "read_only": 0,
-  "read_only_depends_on": null,
-  "report_hide": 0,
-  "reqd": 0,
-  "search_index": 0,
-  "show_dashboard": 0,
-  "sort_options": 0,
-  "translatable": 0,
-  "unique": 0,
-  "width": null
  }
 ]
\ No newline at end of file
diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
index 6123120..4715a65 100644
--- a/business_needed_solutions/hooks.py
+++ b/business_needed_solutions/hooks.py
@@ -250,7 +250,8 @@ fixtures = [
             # {"doctype": "Client Script", "filters": [["module" , "in" , ("Business Needed Solutions" )]]},
             # {"doctype": "Print Format", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
             {"doctype": "Custom Field", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
-            {"doctype":"Terms and Conditions", "filters": [["name" , "in" , ("General" )]],"overwrite": True}
+            {"doctype":"Terms and Conditions", "filters": [["name" , "in" , ("General" )]],"overwrite": True},
+            {"doctype":"Property Setter", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True}
         ]
 # fixtures = [{"doctype": "Report", "filters": [["module" , "in" , ("Business Needed Solutions" )]]}]
 
diff --git a/diff.txt b/diff.txt
index 3163e08..a012b41 100644
--- a/diff.txt
+++ b/diff.txt
@@ -1,3463 +0,0 @@
-diff --git a/business_needed_solutions/business_needed_solutions/overrides/gst_compliance.py b/business_needed_solutions/business_needed_solutions/overrides/gst_compliance.py
-index c4df4d5..e5ab4e8 100644
---- a/business_needed_solutions/business_needed_solutions/overrides/gst_compliance.py
-+++ b/business_needed_solutions/business_needed_solutions/overrides/gst_compliance.py
-@@ -94,18 +94,25 @@ def _is_same_gstin_validation_enabled() -> bool:
- 
- def validate_internal_dn_vehicle_no(doc, method: Optional[str] = None) -> None:
-     """
--    Mandate Vehicle No before submission for Delivery Notes where the
--    customer is an internal customer (ERPNext) or a BNS internal customer.
-+    Mandate Vehicle No or GST Transporter ID before submission for internal
-+    customer Delivery Notes only when:
-+    1. The transfer is intra-state (same GSTIN) — because inter-state
-+       (different GSTIN) transfers go through Sales Invoice flow anyway.
-+    2. The invoice value meets or exceeds the GST Settings e-Waybill threshold.
- 
--    Applies only when docstatus is transitioning to 1 (submit) and
--    the DN is not a return.
-+    Per GST e-Way Bill rules, either vehicle_no OR gst_transporter_id is
-+    sufficient to satisfy the transport detail requirement.
-+
-+    Intra-state is determined by comparing the **full** company_gstin and
-+    billing_address_gstin (not just the first 2 state-code digits).
- 
-     Args:
-         doc: The Delivery Note document being validated
-         method (Optional[str]): The method being called
- 
-     Raises:
--        frappe.ValidationError: If Vehicle No is missing
-+        frappe.ValidationError: If neither Vehicle No nor GST Transporter ID
-+            is provided for an intra-state transfer above threshold
-     """
-     # Only enforce on submit
-     if doc.docstatus != 1:
-@@ -119,11 +126,41 @@ def validate_internal_dn_vehicle_no(doc, method: Optional[str] = None) -> None:
-     if not is_internal:
-         return
- 
--    if not (doc.get("vehicle_no") or "").strip():
--        frappe.throw(
--            _("Vehicle No is mandatory before submitting a Delivery Note for an internal customer."),
--            title=_("Missing Vehicle No"),
-+    # Skip if vehicle number OR transporter ID is already provided
-+    has_vehicle = bool((doc.get("vehicle_no") or "").strip())
-+    has_transporter = bool((doc.get("gst_transporter_id") or "").strip())
-+    if has_vehicle or has_transporter:
-+        return
-+
-+    # Only enforce for intra-state (same full GSTIN) transfers.
-+    # Inter-state (different GSTIN) transfers use the Sales Invoice flow,
-+    # so vehicle details are not required on the DN.
-+    if _is_inter_state_transfer(doc):
-+        logger.debug(
-+            f"DN {doc.name}: Inter-state internal transfer — vehicle/transporter "
-+            f"not mandatory on DN (handled via Sales Invoice)"
-+        )
-+        return
-+
-+    # Check against the e-Waybill threshold from GST Settings
-+    e_waybill_threshold = _get_ewaybill_threshold()
-+    if abs(doc.base_grand_total) < e_waybill_threshold:
-+        logger.debug(
-+            f"DN {doc.name}: Value {doc.base_grand_total} below e-Waybill threshold "
-+            f"{e_waybill_threshold} — vehicle/transporter not mandatory"
-         )
-+        return
-+
-+    frappe.throw(
-+        _(
-+            "Either Vehicle No or GST Transporter ID is mandatory for intra-state "
-+            "internal Delivery Notes with value of {0} or above. (Current value: {1})"
-+        ).format(
-+            frappe.format_value(e_waybill_threshold, {"fieldtype": "Currency"}),
-+            frappe.format_value(abs(doc.base_grand_total), {"fieldtype": "Currency"}),
-+        ),
-+        title=_("Missing Transport Details"),
-+    )
- 
- 
- def maybe_generate_internal_dn_ewaybill(doc, method: Optional[str] = None) -> None:
-@@ -371,3 +408,51 @@ def _validate_transport_details(doc) -> Optional[str]:
-         return _("L/R No. is required to generate e-Waybill for supply via Rail or Air")
-     
-     return None
-+
-+
-+def _is_inter_state_transfer(doc) -> bool:
-+    """
-+    Determine whether the Delivery Note is an inter-state (different GSTIN)
-+    transfer by comparing the full company_gstin and billing_address_gstin.
-+
-+    For BNS internal transfers "intra-state" means **same GSTIN** — the
-+    exact same GST registration on both sides.  When GSTINs differ the
-+    transfer is inter-state and must go through the Sales Invoice flow,
-+    so vehicle details are not required on the DN.
-+
-+    Args:
-+        doc: The Delivery Note document
-+
-+    Returns:
-+        bool: True if different GSTIN (inter-state), False if same GSTIN
-+              (intra-state) or if either GSTIN is missing
-+    """
-+    company_gstin = (doc.get("company_gstin") or "").strip().upper()
-+    billing_gstin = (doc.get("billing_address_gstin") or "").strip().upper()
-+
-+    if not company_gstin or not billing_gstin:
-+        # Cannot determine — treat as intra-state (safer default: enforce
-+        # vehicle requirement so the user is prompted to fill in details).
-+        logger.debug(
-+            f"DN {doc.name}: Cannot determine GSTIN — company_gstin={company_gstin!r}, "
-+            f"billing_gstin={billing_gstin!r}. Treating as same GSTIN (intra-state)."
-+        )
-+        return False
-+
-+    return company_gstin != billing_gstin
-+
-+
-+def _get_ewaybill_threshold() -> float:
-+    """
-+    Fetch the e-Waybill threshold amount from GST Settings.
-+
-+    Returns:
-+        float: The threshold amount; 0 if not configured or on error
-+    """
-+    try:
-+        return float(
-+            frappe.db.get_single_value("GST Settings", "e_waybill_threshold") or 0
-+        )
-+    except Exception as e:
-+        logger.error(f"Error fetching e-Waybill threshold: {e}")
-+        return 0
-diff --git a/business_needed_solutions/business_needed_solutions/utils.py b/business_needed_solutions/business_needed_solutions/utils.py
-index af60a4d..d31a2da 100644
---- a/business_needed_solutions/business_needed_solutions/utils.py
-+++ b/business_needed_solutions/business_needed_solutions/utils.py
-@@ -394,10 +394,15 @@ def _get_delivery_note_mapping() -> Dict[str, Any]:
-                 "target_warehouse": "from_warehouse",
-                 "serial_no": "serial_no",
-                 "batch_no": "batch_no",
--                "purchase_order": "purchase_order",
--                "purchase_order_item": "purchase_order_item",
-             },
--            "field_no_map": ["warehouse", "rejected_warehouse", "expense_account", "cost_center", "project", "location"],
-+            # Deliberately exclude purchase_order / purchase_order_item:
-+            # The DN items may reference a PO whose supplier differs from
-+            # the BNS internal supplier on the new PR.  Carrying them over
-+            # triggers ERPNext's validate_with_previous_doc() which
-+            # compares PR.supplier against PO.supplier and throws
-+            # "Incorrect value: Supplier must be equal to …".
-+            "field_no_map": ["warehouse", "rejected_warehouse", "expense_account", "cost_center", "project", "location",
-+                             "purchase_order", "purchase_order_item"],
-             "condition": lambda item: flt(item.qty) + flt(item.returned_qty or 0) - flt(item.received_qty or 0) > 0,
-             "postprocess": _update_item,
-         },
-@@ -473,6 +478,10 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
-         target_doc.buying_price_list = source_doc.selling_price_list
-         target_doc.is_internal_supplier = 1
-         target_doc.bns_inter_company_reference = source_doc.name
-+        # Also set ERPNext's standard inter_company_reference so that
-+        # validate_inter_company_reference() does not throw
-+        # "Internal Sale or Delivery Reference missing".
-+        target_doc.inter_company_reference = source_doc.name
-         
-         # Set supplier_delivery_note = DN name (TRANSFER UNDER SAME GSTIN)
-         target_doc.supplier_delivery_note = source_doc.name
-@@ -480,6 +489,9 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
-         # Set is_bns_internal_supplier = 1 (TRANSFER UNDER SAME GSTIN)
-         target_doc.is_bns_internal_supplier = 1
-         
-+        # Set represents_company so ERPNext's is_internal_transfer() works
-+        target_doc.represents_company = source_doc.company
-+        
-         # Handle addresses
-         _update_addresses(target_doc, source_doc)
-         
-@@ -497,6 +509,10 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
-         target_doc.buying_price_list = source_doc.selling_price_list
-         target_doc.is_internal_supplier = 1
-         target_doc.bns_inter_company_reference = source_doc.name
-+        # Also set ERPNext's standard inter_company_reference so that
-+        # validate_inter_company_reference() does not throw
-+        # "Internal Sale or Delivery Reference missing".
-+        target_doc.inter_company_reference = source_doc.name
-         
-         # Set supplier_delivery_note = DN name (TRANSFER UNDER SAME GSTIN)
-         target_doc.supplier_delivery_note = source_doc.name
-@@ -504,6 +520,9 @@ def _update_details(source_doc, target_doc, source_parent) -> None:
-         # Set is_bns_internal_supplier = 1 (TRANSFER UNDER SAME GSTIN)
-         target_doc.is_bns_internal_supplier = 1
-         
-+        # Set represents_company so ERPNext's is_internal_transfer() works
-+        target_doc.represents_company = source_doc.company
-+        
-         # Update delivery note with reference
-         _update_delivery_note_reference(source_doc.name, target_doc.name)
-         
-@@ -554,13 +573,41 @@ def _update_delivery_note_reference(dn_name: str, pr_name: str) -> None:
- 
- 
- def _update_addresses(target_doc, source_doc) -> None:
--    """Update addresses for internal transfer."""
-+    """Update addresses for internal transfer.
-+
-+    For BNS internal transfers the DN's company_address is the *logical*
-+    supplier address on the receiving PR, but ERPNext validates that the
-+    ``supplier_address`` has a Dynamic Link to the Supplier.  To avoid
-+    "Billing Address does not belong to the Supplier" errors we resolve
-+    the supplier_address to an address that is actually linked to the
-+    Supplier.  If the DN's company_address is already linked to the
-+    Supplier (common when the Supplier represents the same company), we
-+    use it directly.  Otherwise we fall back to the Supplier's default
-+    address.  If no linked address exists at all, we skip setting
-+    supplier_address so the user can fill it manually without being
-+    blocked.
-+    """
-     # For Purchase Receipt, swap shipping/dispatch addresses (inverse)
-     if target_doc.doctype == "Purchase Receipt":
--        # Company address becomes supplier address
--        update_address(target_doc, "supplier_address", "address_display", source_doc.company_address)
--        # Customer address becomes billing address
--        update_address(target_doc, "billing_address", "billing_address_display", source_doc.customer_address)
-+        # Resolve supplier_address: prefer source company_address if it
-+        # belongs to the supplier, otherwise fall back to supplier default.
-+        supplier = target_doc.supplier
-+        supplier_address = _resolve_supplier_address(
-+            supplier, source_doc.company_address
-+        )
-+        if supplier_address:
-+            update_address(target_doc, "supplier_address", "address_display", supplier_address)
-+        else:
-+            # Clear supplier_address so validation won't choke on a
-+            # mismatched address; the user can set it manually.
-+            target_doc.supplier_address = None
-+            target_doc.address_display = None
-+
-+        # Customer address becomes billing address (company-linked, no
-+        # party validation on billing_address for Purchase Receipt).
-+        if source_doc.customer_address:
-+            update_address(target_doc, "billing_address", "billing_address_display", source_doc.customer_address)
-+
-         # Shipping address = Dispatch address from source (inverse)
-         if source_doc.dispatch_address_name:
-             update_address(target_doc, "shipping_address", "shipping_address_display", source_doc.dispatch_address_name)
-@@ -593,6 +640,48 @@ def _update_addresses(target_doc, source_doc) -> None:
-         target_doc.shipping_address_template = None
- 
- 
-+def _resolve_supplier_address(supplier: str, preferred_address: Optional[str] = None) -> Optional[str]:
-+    """Return an address linked to *supplier* via Dynamic Link.
-+
-+    1. If *preferred_address* is already linked to the supplier, return it.
-+    2. Otherwise return the supplier's default / first linked address.
-+    3. If no linked address exists, return ``None``.
-+    """
-+    if not supplier:
-+        return preferred_address
-+
-+    # Addresses linked to this Supplier via Dynamic Link
-+    linked_addresses = frappe.get_all(
-+        "Dynamic Link",
-+        filters={
-+            "link_doctype": "Supplier",
-+            "link_name": supplier,
-+            "parenttype": "Address",
-+        },
-+        pluck="parent",
-+    )
-+
-+    if not linked_addresses:
-+        logger.debug(f"No addresses linked to Supplier {supplier}")
-+        return None
-+
-+    # Prefer the address we already have if it's linked
-+    if preferred_address and preferred_address in linked_addresses:
-+        return preferred_address
-+
-+    # Fall back to the supplier's default address or first available
-+    default_address = frappe.db.get_value(
-+        "Dynamic Link",
-+        {
-+            "link_doctype": "Supplier",
-+            "link_name": supplier,
-+            "parenttype": "Address",
-+        },
-+        "parent",
-+    )
-+    return default_address or linked_addresses[0]
-+
-+
- def _update_taxes(target_doc) -> None:
-     """Update taxes for the purchase receipt."""
-     # Recalculate taxes based on supplier and addresses
-@@ -626,8 +715,13 @@ def _update_item(source, target, source_parent) -> None:
-         target.base_net_rate = flt(source.base_net_rate)
-     
-     target.received_qty = 0
--    target.purchase_order = source.purchase_order
--    target.purchase_order_item = source.purchase_order_item
-+
-+    # Do NOT carry purchase_order / purchase_order_item from the DN.
-+    # The DN's PO belongs to a different supplier; copying it causes
-+    # ERPNext's validate_with_previous_doc() to throw
-+    # "Incorrect value: Supplier must be equal to …".
-+    target.purchase_order = None
-+    target.purchase_order_item = None
-     
-     # Clear accounting fields to let system auto-populate
-     _clear_item_level_fields(target)
-diff --git a/business_needed_solutions/public/js/purchase_invoice_form.js b/business_needed_solutions/public/js/purchase_invoice_form.js
-index 2188c2b..b01e4fd 100644
---- a/business_needed_solutions/public/js/purchase_invoice_form.js
-+++ b/business_needed_solutions/public/js/purchase_invoice_form.js
-@@ -165,86 +165,93 @@ frappe.ui.form.on('Purchase Invoice', {
-                     );
-                 }, __('Actions'));
-             } else if (frm.doc.bill_no) {
--                // Only show link button if bill_no exists and matches an SI
--                frappe.call({
--                    method: 'frappe.client.get',
--                    args: {
--                        doctype: 'Sales Invoice',
--                        name: frm.doc.bill_no
--                    },
--                    callback: function(si_result) {
--                        // Only show if SI exists and is submitted
--                        if (!si_result.exc && si_result.message && si_result.message.docstatus == 1) {
--                            frm.add_custom_button(__('Link Sales Invoice'), function() {
--                                const fields = [
--                                    {
--                                        label: __('Sales Invoice'),
--                                        fieldname: 'sales_invoice',
--                                        fieldtype: 'Link',
--                                        options: 'Sales Invoice',
--                                        reqd: 1,
--                                        default: frm.doc.bill_no,
--                                        get_filters: function() {
--                                            const filters = {
--                                                'docstatus': 1
--                                            };
--                                            // Filter by company match
--                                            if (frm.doc.company) {
--                                                filters['company'] = frm.doc.company;
--                                            }
--                                            // Filter by date: SI posting_date should be <= PI posting_date
--                                            if (frm.doc.posting_date) {
--                                                filters['posting_date'] = ['<=', frm.doc.posting_date];
--                                            }
--                                            // Filter by name matching bill_no
--                                            if (frm.doc.bill_no) {
--                                                filters['name'] = frm.doc.bill_no;
--                                            }
--                                            return filters;
--                                        },
--                                        description: __('Sales Invoice matching supplier invoice number')
--                                    }
--                                ];
--                                
--                                const d = new frappe.ui.Dialog({
--                                    title: __('Link Sales Invoice'),
--                                    fields: fields,
--                                    primary_action_label: __('Link'),
--                                    primary_action(values) {
--                                        if (!values.sales_invoice) {
--                                            frappe.msgprint({
--                                                title: __('Validation Error'),
--                                                message: __('Sales Invoice is required'),
--                                                indicator: 'red'
--                                            });
--                                            return;
-+                // Only attempt the SI lookup for BNS internal suppliers.
-+                // For external suppliers bill_no is the vendor's own invoice
-+                // number (e.g. "KPU1/25-26/4588") which is NOT a Sales
-+                // Invoice in the system.  Calling frappe.client.get with
-+                // that name causes a harmless but annoying "not found" error
-+                // every time the PI is opened.
-+                frappe.db.get_value("Supplier", frm.doc.supplier, "is_bns_internal_supplier", (supplier_r) => {
-+                    if (!supplier_r || !supplier_r.is_bns_internal_supplier) {
-+                        // External supplier — nothing to link
-+                        return;
-+                    }
-+
-+                    // BNS internal supplier — check if bill_no matches a submitted SI
-+                    frappe.db.get_value("Sales Invoice", frm.doc.bill_no, ["name", "docstatus"], (si_result) => {
-+                        if (!si_result || !si_result.name || si_result.docstatus != 1) {
-+                            return;
-+                        }
-+
-+                        frm.add_custom_button(__('Link Sales Invoice'), function() {
-+                            const fields = [
-+                                {
-+                                    label: __('Sales Invoice'),
-+                                    fieldname: 'sales_invoice',
-+                                    fieldtype: 'Link',
-+                                    options: 'Sales Invoice',
-+                                    reqd: 1,
-+                                    default: frm.doc.bill_no,
-+                                    get_filters: function() {
-+                                        const filters = {
-+                                            'docstatus': 1
-+                                        };
-+                                        // Filter by company match
-+                                        if (frm.doc.company) {
-+                                            filters['company'] = frm.doc.company;
-                                         }
--                                        
--                                        frappe.call({
--                                            method: 'business_needed_solutions.business_needed_solutions.utils.link_si_pi',
--                                            args: {
--                                                sales_invoice: values.sales_invoice,
--                                                purchase_invoice: frm.doc.name
--                                            },
--                                            freeze: true,
--                                            freeze_message: __('Linking...'),
--                                            callback: function(r) {
--                                                if (!r.exc) {
--                                                    frappe.show_alert({
--                                                        message: r.message.message || __('Linked successfully'),
--                                                        indicator: 'green'
--                                                    });
--                                                    frm.reload_doc();
--                                                    d.hide();
--                                                }
--                                            }
-+                                        // Filter by date: SI posting_date should be <= PI posting_date
-+                                        if (frm.doc.posting_date) {
-+                                            filters['posting_date'] = ['<=', frm.doc.posting_date];
-+                                        }
-+                                        // Filter by name matching bill_no
-+                                        if (frm.doc.bill_no) {
-+                                            filters['name'] = frm.doc.bill_no;
-+                                        }
-+                                        return filters;
-+                                    },
-+                                    description: __('Sales Invoice matching supplier invoice number')
-+                                }
-+                            ];
-+                            
-+                            const d = new frappe.ui.Dialog({
-+                                title: __('Link Sales Invoice'),
-+                                fields: fields,
-+                                primary_action_label: __('Link'),
-+                                primary_action(values) {
-+                                    if (!values.sales_invoice) {
-+                                        frappe.msgprint({
-+                                            title: __('Validation Error'),
-+                                            message: __('Sales Invoice is required'),
-+                                            indicator: 'red'
-                                         });
-+                                        return;
-                                     }
--                                });
--                                d.show();
--                            }, __('Actions'));
--                        }
--                    }
-+                                    
-+                                    frappe.call({
-+                                        method: 'business_needed_solutions.business_needed_solutions.utils.link_si_pi',
-+                                        args: {
-+                                            sales_invoice: values.sales_invoice,
-+                                            purchase_invoice: frm.doc.name
-+                                        },
-+                                        freeze: true,
-+                                        freeze_message: __('Linking...'),
-+                                        callback: function(r) {
-+                                            if (!r.exc) {
-+                                                frappe.show_alert({
-+                                                    message: r.message.message || __('Linked successfully'),
-+                                                    indicator: 'green'
-+                                                });
-+                                                frm.reload_doc();
-+                                                d.hide();
-+                                            }
-+                                        }
-+                                    });
-+                                }
-+                            });
-+                            d.show();
-+                        }, __('Actions'));
-+                    });
-                 });
-             }
-         }
-diff --git a/diff.txt b/diff.txt
-index 3fa3b39..97e4d40 100644
---- a/diff.txt
-+++ b/diff.txt
-@@ -1,2973 +0,0 @@
--diff --git a/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json b/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
--index 5f35395..2352825 100644
----- a/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
--+++ b/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
--@@ -12,6 +12,12 @@
--   "enforce_pan_uniqueness",
--   "enforce_expense_account_for_non_stock_items",
-- 
--+  "tab_break_gst_compliance",
--+  "gst_compliance_section",
--+  "block_purchase_invoice_same_gstin",
--+  "column_break_gst",
--+  "enable_internal_dn_ewaybill",
--+
--   "tab_break_grid",
--   "item_grid_section",
--   "enable_uom_restriction",
--@@ -84,6 +90,34 @@
--    "fieldtype": "Check",
--    "label": "Enforce Expense Account for Non-Stock Items"
--   },
--+  {
--+   "fieldname": "tab_break_gst_compliance",
--+   "fieldtype": "Tab Break",
--+   "label": "GST & Compliance"
--+  },
--+  {
--+   "fieldname": "gst_compliance_section",
--+   "fieldtype": "Section Break",
--+   "label": "GST Validation Controls"
--+  },
--+  {
--+   "default": "0",
--+   "description": "Block Purchase Invoice submission when Supplier GSTIN and Company GSTIN are the same.",
--+   "fieldname": "block_purchase_invoice_same_gstin",
--+   "fieldtype": "Check",
--+   "label": "Block Purchase Invoice with Same GSTIN"
--+  },
--+  {
--+   "fieldname": "column_break_gst",
--+   "fieldtype": "Column Break"
--+  },
--+  {
--+   "default": "0",
--+   "description": "Auto-generate e-Waybill for Delivery Notes when customer is BNS internal and billing GSTIN equals company GSTIN (respects GST Settings thresholds).",
--+   "fieldname": "enable_internal_dn_ewaybill",
--+   "fieldtype": "Check",
--+   "label": "Auto e-Waybill for Internal Customer DN"
--+  },
--   {
--    "fieldname": "tab_break_grid",
--    "fieldtype": "Tab Break",
--@@ -269,7 +303,7 @@
--  "index_web_pages_for_search": 1,
--  "issingle": 1,
--  "links": [],
--- "modified": "2026-01-25 14:00:00.000000",
--+ "modified": "2026-01-25 20:00:00.000000",
--  "modified_by": "Administrator",
--  "module": "Business Needed Solutions",
--  "name": "BNS Settings",
--diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
--index faf941e..b07cdde 100644
----- a/business_needed_solutions/hooks.py
--+++ b/business_needed_solutions/hooks.py
--@@ -197,7 +197,8 @@ doc_events = {
--         "validate": "business_needed_solutions.business_needed_solutions.utils.validate_bns_internal_delivery_note_return",
--         "on_submit": [
--             "business_needed_solutions.business_needed_solutions.overrides.submission_restriction.validate_submission_permission",
---            "business_needed_solutions.business_needed_solutions.utils.update_delivery_note_status_for_bns_internal"
--+            "business_needed_solutions.business_needed_solutions.utils.update_delivery_note_status_for_bns_internal",
--+            "business_needed_solutions.business_needed_solutions.overrides.gst_compliance.maybe_generate_internal_dn_ewaybill"
--         ],
--         "on_cancel": "business_needed_solutions.business_needed_solutions.utils.validate_delivery_note_cancellation"
--     },
--@@ -223,7 +224,8 @@ doc_events = {
--     "Purchase Invoice": {
--         "on_submit": [
--             "business_needed_solutions.business_needed_solutions.overrides.submission_restriction.validate_submission_permission",
---            "business_needed_solutions.business_needed_solutions.utils.update_purchase_invoice_status_for_bns_internal"
--+            "business_needed_solutions.business_needed_solutions.utils.update_purchase_invoice_status_for_bns_internal",
--+            "business_needed_solutions.business_needed_solutions.overrides.gst_compliance.validate_purchase_invoice_same_gstin"
--         ],
--         "validate": "business_needed_solutions.business_needed_solutions.overrides.stock_update_validation.validate_stock_update_or_reference"
--     },
--diff --git a/diff.txt b/diff.txt
--index 608e4f4..e69de29 100644
----- a/diff.txt
--+++ b/diff.txt
--@@ -1,2883 +0,0 @@
---diff --git a/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json b/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
---index 2e27080..5f35395 100644
------ a/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
---+++ b/business_needed_solutions/business_needed_solutions/doctype/bns_settings/bns_settings.json
---@@ -4,227 +4,241 @@
---  "creation": "2025-04-05 02:44:18.812451",
---  "doctype": "DocType",
---  "engine": "InnoDB",
----"field_order": [
---- "tab_break_general",
---- "general_section",
---- "discount_type",
---- "column_break_pan",
---- "enforce_pan_uniqueness",
---- "enforce_stock_update_or_reference",
---- "enforce_expense_account_for_non_stock_items",
---- 
---- "tab_break_grid",
---- "item_grid_section",
---- "enable_uom_restriction",
---- "enable_conversion_tags",
---- "enable_custom_update_items_po_so",
---- 
---- "tab_break_submission",
---- "submission_section",
---- "restrict_submission",
---- "submission_restriction_override_roles",
---- "enable_per_warehouse_negative_stock_disallow",
---- 
---- "tab_break_print",
---- "print_format_section",
---- "print_format",
---- "section_break_rates",
---- "rate_incl_tax",
---- "rate_excl_tax",
---- "column_break_rates",
---- "is_item_amount_tax_incl",
---- "secondary_rate_display",
---- "secondary_rate_field",
---- "section_break_display",
---- "show_item_code",
---- "bns_show_item_barcode"
---+ "field_order": [
---+  "tab_break_general",
---+  "general_section",
---+  "discount_type",
---+  "column_break_pan",
---+  "enforce_pan_uniqueness",
---+  "enforce_expense_account_for_non_stock_items",
---+
---+  "tab_break_grid",
---+  "item_grid_section",
---+  "enable_uom_restriction",
---+  "enable_conversion_tags",
---+  "enable_custom_update_items_po_so",
---+  "stock_entry_controls_section",
---+  "enforce_stock_update_or_reference",
---+  "enable_per_warehouse_negative_stock_disallow",
---+
---+  "tab_break_manufacturing",
---+  "manufacturing_section",
---+  "enforce_bom_for_manufacture",
---+  "enable_bns_variance_qty",
---+  "bns_default_variance_qty",
---+
---+  "tab_break_submission",
---+  "submission_section",
---+  "restrict_submission",
---+  "submission_restriction_override_roles",
---+
---+  "tab_break_print",
---+  "print_format_section",
---+  "print_format",
---+  "section_break_rates",
---+  "rate_incl_tax",
---+  "column_break_rates",
---+  "rate_excl_tax",
---+  "is_item_amount_tax_incl",
---+  "section_break_display",
---+  "show_item_code",
---+  "bns_show_item_barcode",
---+  "secondary_rate_display",
---+  "secondary_rate_field"
---  ],
----"fields": [
---- {
----  "fieldname": "tab_break_general",
----  "fieldtype": "Tab Break",
----  "label": "General Settings"
---- },
---- {
----  "fieldname": "general_section",
----  "fieldtype": "Section Break",
----  "label": "General Controls"
----  },
---+ "fields": [
---   {
----   "default": "1",
----   "description": "Enable UOM restriction in Stock Entry grid based on Item's allowed UOMs",
----   "fieldname": "enable_uom_restriction",
----   "fieldtype": "Check",
----   "label": "Enable UOM Restriction"
---+   "fieldname": "tab_break_general",
---+   "fieldtype": "Tab Break",
---+   "label": "General"
---   },
---   {
----   "default": "1", 
----   "description": "Show conversion tags/badges in Stock Entry grid",
----   "fieldname": "enable_conversion_tags",
----   "fieldtype": "Check",
----   "label": "Enable Conversion Tags"
---+   "fieldname": "general_section",
---+   "fieldtype": "Section Break",
---+   "label": "Pricing & Data Validation"
---   },
---- {
----  "default": "0",
----  "description": "When enabled, ERPNext's standard 'Update Items' button on Sales Order / Purchase Order will be replaced by BNS Update Items (supports Price List Rate + Discounts based pricing).",
----  "fieldname": "enable_custom_update_items_po_so",
----  "fieldtype": "Check",
----  "label": "Enable BNS Update Items for Sales/Purchase Orders"
---- },
---   {
---    "default": "Single",
---+   "description": "Controls how discounts are calculated: Single applies one discount, Triple Compounded applies three discounts sequentially.",
---    "fieldname": "discount_type",
---    "fieldtype": "Select",
---    "label": "Discount Type",
---    "options": "Single\nTriple Compounded",
---    "permlevel": 1
---   },
----  {
----   "fieldname": "general_section",
----   "fieldtype": "Section Break"
----  },
---   {
---    "fieldname": "column_break_pan",
---    "fieldtype": "Column Break"
---   },
---   {
---    "default": "0",
---+   "description": "Ensures PAN numbers are unique across all customers and suppliers to prevent duplicate entries.",
---    "fieldname": "enforce_pan_uniqueness",
---    "fieldtype": "Check",
----   "label": "Enforce PAN Uniqueness",
----   "description": "Ensures PAN numbers are unique across all customers and suppliers to prevent duplicate entries and maintain data integrity."
---+   "label": "Enforce PAN Uniqueness"
---   },
---   {
---    "default": "0",
----   "fieldname": "enforce_stock_update_or_reference",
---+   "description": "Requires non-stock items (except fixed assets) to have an expense account configured.",
---+   "fieldname": "enforce_expense_account_for_non_stock_items",
---    "fieldtype": "Check",
----   "label": "Enforce Stock Update or Reference",
----   "description": "Requires stock items in invoices to either update stock directly or reference a delivery note/purchase receipt for accurate inventory tracking."
---+   "label": "Enforce Expense Account for Non-Stock Items"
---+  },
---+  {
---+   "fieldname": "tab_break_grid",
---+   "fieldtype": "Tab Break",
---+   "label": "Stock & Inventory"
---   },
---   {
----   "fieldname": "section_break_submission_control",
---+   "fieldname": "item_grid_section",
---    "fieldtype": "Section Break",
----   "label": "Submission Control"
---+   "label": "Item Grid Controls"
---+  },
---+  {
---+   "default": "1",
---+   "description": "Restrict UOM selection in Stock Entry grid to Item's allowed UOMs only.",
---+   "fieldname": "enable_uom_restriction",
---+   "fieldtype": "Check",
---+   "label": "Enable UOM Restriction"
---+  },
---+  {
---+   "default": "1",
---+   "description": "Show conversion tags/badges in Stock Entry grid for quick reference.",
---+   "fieldname": "enable_conversion_tags",
---+   "fieldtype": "Check",
---+   "label": "Enable Conversion Tags"
---   },
---   {
---    "default": "0",
----   "description": "Restrict submission of documents across all categories (Stock, Transaction, Order)",
----   "fieldname": "restrict_submission",
---+   "description": "Replace ERPNext's 'Update Items' on Sales/Purchase Orders with BNS version (supports Price List Rate + Discounts).",
---+   "fieldname": "enable_custom_update_items_po_so",
---    "fieldtype": "Check",
----   "label": "Restrict Document Submission"
---+   "label": "Enable BNS Update Items for Orders"
---   },
---   {
----   "depends_on": "restrict_submission",
----   "description": "Select roles that can submit documents in addition to System Manager",
----   "fieldname": "submission_restriction_override_roles",
----   "fieldtype": "Table MultiSelect",
----   "label": "Override Submission Restriction",
----   "options": "Has Role"
---+   "fieldname": "stock_entry_controls_section",
---+   "fieldtype": "Section Break",
---+   "label": "Stock Validation"
---   },
---   {
---    "default": "0",
----   "description": "Enable warehouse-level negative stock restriction. When enabled, warehouses can individually disallow negative stock even if 'Allow Negative Stock' is enabled in Stock Settings.",
----   "fieldname": "enable_per_warehouse_negative_stock_disallow",
---+   "description": "Requires stock items in invoices to either update stock directly or reference a delivery note/purchase receipt.",
---+   "fieldname": "enforce_stock_update_or_reference",
---    "fieldtype": "Check",
----   "insert_after": "submission_restriction_override_roles",
----   "label": "Enable Per Warehouse Negative Stock Disallow"
---+   "label": "Enforce Stock Update or Reference"
---   },
---   {
---    "default": "0",
----   "fieldname": "enforce_expense_account_for_non_stock_items",
---+   "description": "Allow warehouses to individually disallow negative stock even when global 'Allow Negative Stock' is enabled.",
---+   "fieldname": "enable_per_warehouse_negative_stock_disallow",
---    "fieldtype": "Check",
----   "label": "Enforce Expense Account for Non-Stock Items",
----   "description": "Requires non-stock items (except fixed assets) to have an expense account configured for proper accounting and tracking."
---+   "label": "Enable Per-Warehouse Negative Stock Control"
---   },
---   {
----   "fieldname": "tab_break_grid",
----  "fieldtype": "Tab Break",
----  "label": "Item Grid Controls"
---- },
---- {
----  "fieldname": "item_grid_section",
----  "fieldtype": "Section Break",
----  "label": "Item Grid Settings"
---- },
---- {
----  "fieldname": "tab_break_submission",
----  "fieldtype": "Tab Break",
----  "label": "Document Submission"
---- },
---- {
----  "fieldname": "submission_section",
----  "fieldtype": "Section Break",
----  "label": "Submission Controls"
---- },
---- {
----  "fieldname": "tab_break_print",
----  "fieldtype": "Tab Break",
----  "label": "Print Settings"
---- },
---- {
----  "fieldname": "print_format_section",
----  "fieldtype": "Section Break",
----  "label": "Print Format Options"
---- },
---- {
----  "fieldname": "section_break_display",
----  "fieldtype": "Section Break",
----  "label": "Item Display Options"
---+   "fieldname": "tab_break_manufacturing",
---+   "fieldtype": "Tab Break",
---+   "label": "Manufacturing"
---   },
---   {
----   "default": "1",
----   "fieldname": "rate_incl_tax",
----   "fieldtype": "Check",
----   "label": "Rate (Incl Tax)"
---+   "fieldname": "manufacturing_section",
---+   "fieldtype": "Section Break",
---+   "label": "BOM & Stock Entry Controls"
---   },
---   {
----   "fieldname": "column_break_giiq",
----   "fieldtype": "Column Break"
---+   "default": "0",
---+   "description": "Require BOM for Manufacture Stock Entry and enforce that components match the BOM exactly.",
---+   "fieldname": "enforce_bom_for_manufacture",
---+   "fieldtype": "Check",
---+   "label": "Enforce BOM for Manufacture"
---   },
---   {
---    "default": "0",
----   "fieldname": "rate_excl_tax",
---+   "description": "Allow ±% variance in component quantities instead of requiring exact BOM quantities during Stock Entry validation.",
---+   "fieldname": "enable_bns_variance_qty",
---    "fieldtype": "Check",
----   "label": "Rate (Excl Tax)"
---+   "label": "Enable BOM Quantity Variance"
---   },
---   {
----   "fieldname": "print_format",
----   "fieldtype": "Table",
----   "label": "Print Format",
----   "options": "BNS Settings Print Format"
---+   "default": "0",
---+   "depends_on": "enable_bns_variance_qty",
---+   "description": "Default allowed variance (±%). Individual BOM items can override this value.",
---+   "fieldname": "bns_default_variance_qty",
---+   "fieldtype": "Percent",
---+   "label": "Default Variance (%)"
---   },
---   {
----   "fieldname": "section_break_vlqx",
----   "fieldtype": "Section Break"
---+   "fieldname": "tab_break_submission",
---+   "fieldtype": "Tab Break",
---+   "label": "Submission"
---   },
---   {
----   "fieldname": "section_break_qbpg",
----   "fieldtype": "Section Break"
---+   "fieldname": "submission_section",
---+   "fieldtype": "Section Break",
---+   "label": "Document Submission Controls"
---   },
---   {
---    "default": "0",
----   "fieldname": "secondary_rate_display",
---+   "description": "Restrict document submission across all categories (Stock, Transaction, Order) to specific roles.",
---+   "fieldname": "restrict_submission",
---    "fieldtype": "Check",
----   "label": "Secondary Rate Display"
---+   "label": "Restrict Document Submission"
---   },
---   {
----   "depends_on": "secondary_rate_display",
----   "fieldname": "secondary_rate_field",
----   "fieldtype": "Select",
----   "label": "Secondary Rate Field",
----   "mandatory_depends_on": "secondary_rate_display",
----   "options": "print_uom\nweight_uom"
---+   "depends_on": "restrict_submission",
---+   "description": "Roles that can submit documents in addition to System Manager.",
---+   "fieldname": "submission_restriction_override_roles",
---+   "fieldtype": "Table MultiSelect",
---+   "label": "Allowed Roles",
---+   "options": "Has Role"
---+  },
---+  {
---+   "fieldname": "tab_break_print",
---+   "fieldtype": "Tab Break",
---+   "label": "Print Format"
---+  },
---+  {
---+   "fieldname": "print_format_section",
---+   "fieldtype": "Section Break",
---+   "label": "Print Format Configuration"
---+  },
---+  {
---+   "fieldname": "print_format",
---+   "fieldtype": "Table",
---+   "label": "Print Formats",
---+   "options": "BNS Settings Print Format"
---+  },
---+  {
---+   "fieldname": "section_break_rates",
---+   "fieldtype": "Section Break",
---+   "label": "Rate Display Options"
---   },
---   {
----   "fieldname": "column_break_qfib",
---+   "default": "1",
---+   "fieldname": "rate_incl_tax",
---+   "fieldtype": "Check",
---+   "label": "Show Rate (Incl Tax)"
---+  },
---+  {
---+   "fieldname": "column_break_rates",
---    "fieldtype": "Column Break"
---   },
---+  {
---+   "default": "0",
---+   "fieldname": "rate_excl_tax",
---+   "fieldtype": "Check",
---+   "label": "Show Rate (Excl Tax)"
---+  },
---   {
---    "default": "0",
---    "fieldname": "is_item_amount_tax_incl",
---    "fieldtype": "Check",
---    "label": "Item Amount Incl Tax"
---   },
---+  {
---+   "fieldname": "section_break_display",
---+   "fieldtype": "Section Break",
---+   "label": "Item Display Options"
---+  },
---   {
---    "default": "0",
---    "fieldname": "show_item_code",
---@@ -235,13 +249,27 @@
---    "default": "0",
---    "fieldname": "bns_show_item_barcode",
---    "fieldtype": "Check",
----   "label": "Show Item Barcode (If Available)"
---+   "label": "Show Item Barcode"
---+  },
---+  {
---+   "default": "0",
---+   "fieldname": "secondary_rate_display",
---+   "fieldtype": "Check",
---+   "label": "Enable Secondary Rate"
---+  },
---+  {
---+   "depends_on": "secondary_rate_display",
---+   "fieldname": "secondary_rate_field",
---+   "fieldtype": "Select",
---+   "label": "Secondary Rate Field",
---+   "mandatory_depends_on": "secondary_rate_display",
---+   "options": "print_uom\nweight_uom"
---   }
---  ],
---  "index_web_pages_for_search": 1,
---  "issingle": 1,
---  "links": [],
---- "modified": "2025-09-22 02:55:56.144200",
---+ "modified": "2026-01-25 14:00:00.000000",
---  "modified_by": "Administrator",
---  "module": "Business Needed Solutions",
---  "name": "BNS Settings",
---@@ -286,4 +314,4 @@
---  "sort_order": "DESC",
---  "states": [],
---  "track_changes": 1
----}
---\ No newline at end of file
---+}
---diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
---index db2730d..145228f 100644
------ a/business_needed_solutions/fixtures/custom_field.json
---+++ b/business_needed_solutions/fixtures/custom_field.json
---@@ -2620,5 +2620,62 @@
---   "translatable": 0,
---   "unique": 0,
---   "width": null
---+ },
---+ {
---+  "allow_in_quick_entry": 0,
---+  "allow_on_submit": 1,
---+  "bold": 0,
---+  "collapsible": 0,
---+  "collapsible_depends_on": null,
---+  "columns": 1,
---+  "default": null,
---+  "depends_on": "eval:frappe.db.get_single_value('BNS Settings', 'enable_bns_variance_qty')",
---+  "description": "Allowed ±% variance for component qty validation against BOM. Leave empty to use the default from BNS Settings.",
---+  "docstatus": 0,
---+  "doctype": "Custom Field",
---+  "dt": "BOM Item",
---+  "fetch_from": null,
---+  "fetch_if_empty": 0,
---+  "fieldname": "bns_variance_qty",
---+  "fieldtype": "Percent",
---+  "hidden": 0,
---+  "hide_border": 0,
---+  "hide_days": 0,
---+  "hide_seconds": 0,
---+  "ignore_user_permissions": 0,
---+  "ignore_xss_filter": 0,
---+  "in_global_search": 0,
---+  "in_list_view": 0,
---+  "in_preview": 0,
---+  "in_standard_filter": 0,
---+  "insert_after": "qty",
---+  "is_system_generated": 0,
---+  "is_virtual": 0,
---+  "label": "Variance (%)",
---+  "length": 0,
---+  "link_filters": null,
---+  "mandatory_depends_on": null,
---+  "modified": "2026-01-25 10:00:00.000000",
---+  "module": "Business Needed Solutions",
---+  "name": "BOM Item-bns_variance_qty",
---+  "no_copy": 0,
---+  "non_negative": 1,
---+  "options": null,
---+  "permlevel": 0,
---+  "placeholder": null,
---+  "precision": "",
---+  "print_hide": 0,
---+  "print_hide_if_no_value": 0,
---+  "print_width": null,
---+  "read_only": 0,
---+  "read_only_depends_on": null,
---+  "report_hide": 0,
---+  "reqd": 0,
---+  "search_index": 0,
---+  "show_dashboard": 0,
---+  "sort_options": 0,
---+  "translatable": 0,
---+  "unique": 0,
---+  "width": null
---  }
--- ]
---\ No newline at end of file
---diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
---index 5f8bad9..faf941e 100644
------ a/business_needed_solutions/hooks.py
---+++ b/business_needed_solutions/hooks.py
---@@ -161,9 +161,9 @@ doctype_list_js = {
--- # ---------------
--- # Override standard doctype classes
--- 
----# override_doctype_class = {
----# 	"ToDo": "custom_app.overrides.CustomToDo"
----# }
---+override_doctype_class = {
---+    "Stock Entry": "business_needed_solutions.business_needed_solutions.overrides.stock_entry_component_qty_variance.BNSStockEntry"
---+}
--- 
--- # Document Events
--- # ---------------
---diff --git a/diff.txt b/diff.txt
---index f42660c..9dc265d 100644
------ a/diff.txt
---+++ b/diff.txt
---@@ -1,2363 +0,0 @@
----diff --git a/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json b/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
----index 7176925..bdbb05d 100644
------- a/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
----+++ b/business_needed_solutions/business_needed_solutions/print_format/bns_si_dynamic_v2/bns_si_dynamic_v2.json
----@@ -2,7 +2,7 @@
----  "absolute_value": 0,
----  "align_labels_right": 0,
----  "creation": "2025-04-23 16:48:38.390423",
----- "css": ".print-format {\n    margin-top:37mm;\n    margin-left: 2mm;\n    margin-right: 2mm;\n    /*height: 100% !important;*/\n    /*margin-bottom:5mm;*/\n}\n\n.print-heading{\n    border-bottom:1px solid #000;\n    margin-bottom:-5mm;\n    color:#000;\n    font-weight:bold;\n}\n\nh6{\n    font-weight: bold;\n    margin-top:0px;\n    margin-bottom:0px;\n}\n\n.no-border td {\n  border: none;\n  padding: 2px 4px;\n}\n\n.invoice-copy {\n  display: block;\n  font-size: 0.45rem;\n  margin-top: 3px;\n  margin-bottom: 6px;\n}\n\n\n.einv-det .col-xs-8.text-right .row.data-field {\n  /*margin-bottom: 4mm;*/\n  vertical-align: middle !important;\n  margin-left:0;\n  margin-right:0;\n  margin-top: 4mm;\n  margin-bottom:4mm;\n}\n\n.qrcode {\n  width: 50mm;\n  /*display: block;*/\n}\n\n.party-details-table {\n    /*table-layout: fixed;*/\n    width: 100%;\n    margin-bottom:auto;\n    padding-bottom:0;\n}\n.party-details-table td {\n    vertical-align: top;\n    /*padding: 8px;*/\n}\n\n.item-det{\n    margin:0;\n}\ntable{\n    margin:0 !important;\n}\n\n.item-det td,.item-det th{\n    text-align:center;\n    font-size:0.8em;\n    padding:0.2em !important;\n    vertical-align: middle !important;\n}\n\n.item-det .even td{\n    background-color: #f1f1f1;\n\n}\n.item-det .odd td {\n    background-color: #ffffff;\n}\n\n.item-det .item-det-item-name{\n    text-align:justify;\n    font-size:1em;\n    padding-left: 1mm !important;\n}\n\n.final-tax-total-table {\n  page-break-inside: avoid;\n  /*position: -webkit-sticky;*/\n  /*position: fixed;*/\n  margin-top:2mm;\n  /*bottom:0;*/\n  width:100%;\n}\n\n.no-preview-available {\n    color: grey;\n    font-size: 14px;\n}\n\n.page-footer-1 {\n    content: counter(page);\n    border-top:2px solid black;\n    margin-top: -35mm !important;\n    margin-bottom: -5mm !important;\n}\n\n#ewaybill-page-layout {\n    font-size: 12px;\n    width: 100%;\n    margin: 0;\n}\n\n#ewaybill-page-layout table{\n    font-size: 10px;\n    line-height:1.1;\n    width: 100%;\n    margin: 0;\n}\n\n.print-format table td img.barcode,\n.print-format table td img.qr-code {\n    /*margin-top: 5px;*/\n    width: 100px !important;\n    image-rendering: -webkit-optimize-contrast;\n}\n\n\n.watermark {\n  position: fixed;\n  top: 150mm;             /* push to vertical middle */\n  left: 0;            /* push slightly left */\n  width: 100%;\n  text-align: center;\n  font-size: 90px;\n  color: #000000;\n  opacity: 0.04;        /* light watermark */\n  -webkit-transform: rotate(-45deg);\n  -ms-transform: rotate(-45deg);\n  transform: rotate(-45deg);\n  z-index: 1000;\n}",
----+ "css": ".print-format {\n    margin-top:37mm;\n    margin-left: 2mm;\n    margin-right: 2mm;\n    /*height: 100% !important;*/\n    /*margin-bottom:5mm;*/\n}\n\n.print-heading{\n    border-bottom:1px solid #000;\n    margin-bottom:-5mm;\n    color:#000;\n    font-weight:bold;\n}\n\nh6{\n    font-weight: bold;\n    margin-top:0px;\n    margin-bottom:0px;\n}\n\n.no-border td {\n  border: none;\n  padding: 2px 4px;\n}\n\n.invoice-copy {\n  display: block;\n  font-size: 0.45rem;\n  margin-top: 3px;\n  margin-bottom: 6px;\n}\n\n\n.einv-det .col-xs-8.text-right .row.data-field {\n  /*margin-bottom: 4mm;*/\n  vertical-align: middle !important;\n  margin-left:0;\n  margin-right:0;\n  margin-top: 4mm;\n  margin-bottom:4mm;\n}\n\n.qrcode {\n  width: 50mm;\n  /*display: block;*/\n}\n\n.party-details-table {\n    /*table-layout: fixed;*/\n    width: 100%;\n    margin-bottom:auto;\n    padding-bottom:0;\n}\n.party-details-table td {\n    vertical-align: top;\n    /*padding: 8px;*/\n}\n\n.item-det{\n    margin:0;\n}\ntable{\n    margin:0 !important;\n}\n\n.item-det td,.item-det th{\n    text-align:center;\n    font-size:0.8em;\n    padding:0.2em !important;\n    vertical-align: middle !important;\n}\n\n.item-det .even td{\n    background-color: #f1f1f1;\n\n}\n.item-det .odd td {\n    background-color: #ffffff;\n}\n\n.item-det .item-det-item-name{\n    text-align:justify;\n    font-size:1em;\n    padding-left: 1mm !important;\n    width:325px;\n    font-size:0.85em;\n}\n\n.final-tax-total-table {\n  page-break-inside: avoid;\n  /*position: -webkit-sticky;*/\n  /*position: fixed;*/\n  margin-top:2mm;\n  /*bottom:0;*/\n  width:100%;\n}\n\n.no-preview-available {\n    color: grey;\n    font-size: 14px;\n}\n\n.page-footer-1 {\n    content: counter(page);\n    border-top:2px solid black;\n    margin-top: -35mm !important;\n    margin-bottom: -5mm !important;\n}\n\n#ewaybill-page-layout {\n    font-size: 12px;\n    width: 100%;\n    margin: 0;\n}\n\n#ewaybill-page-layout table{\n    font-size: 10px;\n    line-height:1.1;\n    width: 100%;\n    margin: 0;\n}\n\n.print-format table td img.barcode,\n.print-format table td img.qr-code {\n    /*margin-top: 5px;*/\n    width: 100px !important;\n    image-rendering: -webkit-optimize-contrast;\n}\n\n\n.watermark {\n  position: fixed;\n  top: 150mm;             /* push to vertical middle */\n  left: 0;            /* push slightly left */\n  width: 100%;\n  text-align: center;\n  font-size: 90px;\n  color: #000000;\n  opacity: 0.04;        /* light watermark */\n  -webkit-transform: rotate(-45deg);\n  -ms-transform: rotate(-45deg);\n  transform: rotate(-45deg);\n  z-index: 1000;\n}",
----  "custom_format": 1,
----  "default_print_language": "en",
----  "disabled": 0,
----@@ -10,20 +10,20 @@
----  "docstatus": 0,
----  "doctype": "Print Format",
----  "font_size": 14,
----- "html": "{%- from \"templates/print_formats/standard_macros.html\" import add_header, render_field, print_value -%}\n\n{% set e_invoice_log = None %}\n{% if doc.irn %}\n{% set e_invoice_log = frappe.db.get_value(\n        \"e-Invoice Log\", doc.irn, (\"invoice_data\", \"signed_qr_code\"), as_dict=True\n    ) %}\n{% set invoice_data = e_invoice_log and e_invoice_log.invoice_data and _dict(json.loads(e_invoice_log.invoice_data)) or None %}\n{% endif %}\n\n{% macro format_address(address) %}\n{% if address %}\n<p>\n    {{ address.address_line1 }}\n    {% if address.address_line2 %}\n    {{ address.address_line2 }}<br>\n    {% endif %}\n    {{ address.city }}, {{ address.state }}, {{ address.country }}: {{ address.pincode }}<br>\n</p>\n{% endif %}\n{% endmacro %}\n\n{% set bns_settings = frappe.get_doc(\"BNS Settings\") %}\n{% set base_currency = frappe.db.get_value(\"Company\", doc.company, \"default_currency\") %}\n\n{% set copy_map = {\n    \"1\": \"Original for Recipient\",\n    \"2\": \"Duplicate for Transporter\",\n    \"3\": \"Duplicate for Supplier\",\n    \"4\": \"Triplicate for Supplier\"\n} %}\n\n{% set invoice_copy_param = frappe.form_dict.get(\"invoice_copy\") or \"1\" %}\n{% set invoice_copy_text = copy_map.get(invoice_copy_param, \"Original for Recipient\") %}\n\n\n<!--<div class=\"watermark text-center\">MEVABITE</div>-->\n\n<!--<div class=\"page\">-->\n\n\n<div id=\"header-html\">\n    <div class=\"watermark\">{{ invoice_copy_text }}</div>\n    <div class=\"row print-heading\" style=\"line-height:1.1;padding:10px\">\n        <div class=\"col-xs-3 column-break\">\n            {% set company_logo = frappe.db.get_value(\"Company\", doc.company, \"logo_for_printing\") %}\n            {% if company_logo %}\n            <div>\n                <img height=\"125px\" width=\"150px\" src=\"{{ company_logo }}\">\n            </div>\n            {% endif %}\n        </div>\n        <div class=\"col-xs-6 column-break text-center\">\n            <h3 style=\"margin-bottom:0;\"><b>{{ doc.company }}</b></h3>\n            {% if frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\") %}\n                <div style=\"font-size:0.85em;\">Previously Known As: {{frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\")}}</div>\n            {% endif %}\n            <div style=\"font-size:0.85rem\">\n                {% set seller_address = frappe.db.get_value(\"Address\", doc.company_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                    {{ format_address(seller_address) }}\n                    {% if doc.company_gstin %}\n                    GST: {{ doc.company_gstin }}<br>\n                    {% endif %}\n                    <p>PAN: {{ frappe.db.get_value(\"Company\", doc.company, \"pan\") }}</p>\n                \n            </div>\n        </div>\n        <div class=\"col-xs-3 column-break text-right\">\n            <h2 style=\"margin-top:5mm;\"><b>\n                    {% if doc.status == \"Cancelled\" and doc.is_return %}\n                        Cancelled Credit Note\n                    {% elif doc.status == \"Cancelled\" %}\n                        Cancelled Invoice\n                    {% elif doc.status == \"Draft\" and doc.is_return %}\n                        Draft Credit Note\n                    {% elif doc.status == \"Draft\" %}\n                        Draft Invoice\n                    {% elif doc.is_return %}\n                        Credit Note\n                    {% elif doc.irn %}\n                        e-Invoice\n                    {% else %}\n                        Tax Invoice\n                    {% endif %}\n                </b>\n            </h2>\n            <div class=\"invoice-meta\">\n              <table class=\"table-condensed no-border\" style=\"width:100%; font-size:0.9em; text-align:left;\">\n                <tr>\n                  <td><b>Invoice Date:</b></td>\n                  <td>{{ frappe.utils.formatdate(doc.posting_date) }}</td>\n                </tr>\n                <tr>\n                  <td><b>Invoice No:</b></td>\n                  <td><b>{{ doc.name }}</b></td>\n                </tr>\n              </table>\n            </div>\n        </div>\n    </div>\n</div>\n\n{% if doc.irn %}\n<div class=\"einv-det\">\n    <!--<div class=\"col-xs-2 column-break text-left\"></div>-->\n    <div class=\"col-xs-4 column-break text-left\">\n        {% if e_invoice_log and e_invoice_log.signed_qr_code %}\n        <img class=\"qrcode\" src=\"data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}\">\n        {% endif %}\n    </div>\n    <div class=\"col-xs-8 column-break text-right\">\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>IRN</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.irn }}</u></div>\n        </div>\n        {% if invoice_data and invoice_data.AckNo %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. No.</label></div>\n            <div class=\"col-xs-8 value\">{{ invoice_data.AckNo }}</div>\n        </div>\n        {% endif %}\n        {% if invoice_data and invoice_data.AckDt %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. Date</label></div>\n            <div class=\"col-xs-8 value\">{{ frappe.utils.format_datetime(invoice_data.AckDt, \"dd/MM/yyyy hh:mm:ss\") }}</div>\n        </div>\n        {% endif %}\n        {% if doc.ewaybill %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>e-Waybill No.</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.ewaybill }}</u></div>\n        </div>\n        {% endif %}\n    </div>\n    <!--<div class=\"col-xs-1 column-break text-right\">-->\n    </div>\n{% endif %}\n\n<table class=\"table table-bordered party-details-table\">\n    <tbody>\n        <tr>\n            <td colspan=3 rowspan=4 style=\"width:45%;\">\n                {% set contact_person = frappe.db.get_value(\n            \"Contact\", doc.contact_person, (\"mobile_no\"), as_dict=True\n        ) %}\n                <h6><b><u>Buyer Details</u></b></h6>\n                <p><b>{{ doc.customer_name }}</b></p>\n                {% set customer_address = frappe.db.get_value(\"Address\", doc.customer_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(customer_address) }}\n\n                {% if doc.billing_address_gstin %}\n                GST: <u>{{ doc.billing_address_gstin }}</u><br>\n                {% endif %}\n                {% set customer_pan = frappe.db.get_value(\"Customer\", doc.customer_name, \"pan\")%}\n                {% if customer_pan %}\n                PAN: {{ customer_pan }}<br>\n                {% endif %}\n                {% if contact_person.mobile_no %}\n                Phone No: {{ contact_person.mobile_no }}\n                {% endif %}\n                {% if doc.shipping_address %}\n                <br>\n                <h6><b><u>Shipping Details</u></b></h6>\n                {% set shipping_address = frappe.db.get_value(\"Address\", doc.shipping_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(shipping_address) }}\n                {% if shipping_address.gstin %}\n                GST: <u>{{ shipping_address.gstin }}</u><br>\n                {% endif %}\n                {% endif %}\n                {% if doc.dispatch_address %}\n                <h6><b><u>Dispatch Details</u></b></h6>\n                <p><b>{{ frappe.db.get_value(\"Address\", doc.dispatch_address_name, \"address_title\") }}</b></p>\n                <!--<p>{{doc.dispatch_address}}</p>-->\n                {% set dispatch_address = frappe.db.get_value(\"Address\", doc.dispatch_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                {{ format_address(dispatch_address) }}\n                {% endif %}\n            </td>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Transporter:</h6>\n                {% if doc.transporter_name %}\n                {{ doc.transporter_name }} <br>\n                {{ doc.gst_transporter_id }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Vehicle No:</h6>\n                {% if doc.vehicle_no %}\n                {{ doc.vehicle_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Builty No:</h6>\n                {% if doc.custom_builty_no %}\n                {{ doc.custom_builty_no }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1>\n                <h6>Place Of Supply</h6>\n                {{ doc.place_of_supply }}\n            </td>\n            {% if not doc.irn and doc.ewaybill %}\n            <td colspan=1>\n                <h6>e-Waybill No.</h6>\n                <u>{{ doc.ewaybill }}</u>\n            </td>            \n            {% endif %}\n            <td colspan=1>\n                <h6>Buyer's PO No:</h6>\n                {% if doc.po_no %}\n                {{ doc.po_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>PO Date:</h6>\n                {% if doc.po_date %}\n                {{ doc.po_date }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% if doc.incoterm or doc.named_place  %}\n        <tr>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Incoterm:</h6>\n                {% if doc.incoterm %}\n                {{ doc.incoterm }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=2>\n                <h6>Named Place:</h6>\n                {% if doc.named_place %}\n                {{ doc.named_place }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% endif %}\n        <tr>\n            <td colspan=1>\n                \n                <h6>Destination:</h6>\n                {% if doc.custom_destination %}\n                {{doc.custom_destination}}\n                {% else %}<br>{% endif %}\n            </td>\n            <td rowspan=2 colspan=\"{{ 3 if (not doc.irn and doc.ewaybill) else 2 }}\">\n                <h6>Terms of Delivery:</h6>\n                {% if doc.custom_terms_of_delivery %}\n                {{ doc.custom_terms_of_delivery }}\n                {% elif doc.custom_terms_of_delivery_new %}\n                {{ doc.custom_terms_of_delivery_new }}\n                {% else %}<br><br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1 rowspan=1>\n                <h6>Doc No:</h6>\n                {% if doc.custom_doc_no %}\n                {{doc.custom_doc_no}}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n\n<table class=\"table table-bordered item-det\">\n<thead>\n    <tr>\n        <th colspan=\"2\">#</th>\n        <th colspan=\"24\">Item</th>\n        <th colspan=\"7\">HSN/SAC</th>\n        <th colspan=\"7\">Qty</th>\n        {% if bns_settings.rate_excl_tax %}\n        <th colspan=\"9\">Rate(Exc Tax)</th>\n        {% endif %}\n        {% if doc.is_print_gst_rate_per_row %}\n        <th colspan=\"4\">GST</th>\n        {% endif %}\n        {% if bns_settings.rate_incl_tax %}\n        <th colspan=\"9\">Rate(Inc Tax)</th>\n        {% endif %}\n        {% if bns_settings.discount_type == \"Triple Compounded\" %}\n        <th colspan=\"4\">D1</th>\n        <th colspan=\"4\">D2</th>\n        <th colspan=\"4\">D3</th>\n        {% else %}\n        <th colspan=\"4\">Disc</th>\n        {% endif %}\n        {% if bns_settings.is_item_amount_tax_incl %}\n        <th colspan=\"11\">Amount(Incl)</th>\n        {% else %}\n        <th colspan=\"11\">Amount(Excl)</th>\n        {% endif %}\n    </tr>\n</thead>\n\n    <tbody>\n        {% for item in doc.items %}\n        <tr class=\"no-break {{ 'odd' if loop.index is odd else 'even' }}\">\n            <td colspan=\"2\">{{ loop.index }}</td>\n            <td colspan=\"24\" class=\"item-det-item-name\">\n                <b>{% if bns_settings.show_item_code or doc.bns_show_item_code %}{{ item.item_code }}:{% endif %}{{ item.item_name }}</b><br>\n                {% if item.barcode and (doc.bns_show_item_barcode or bns_settings.bns_show_item_barcode) %}\n                <p style=\"font-size:0.75em;\">\n                    EAN: {{ item.barcode }}\n                </p>\n                {% endif %}\n            </td>\n            <td colspan=\"7\">{{ item.gst_hsn_code }}</td>\n            <td colspan=\"7\">\n                <b>\n                    <span>{{ item.qty }} {{ item.uom }}</span>\n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <small style=\"font-size:0.7em;\">{{ (item.conversion_factor * item.qty / print_uom_conversion ) | int }} {{ print_uom }} </small>\n                                \n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <br>\n                                <small style=\"font-size:0.6em;\">{{ item.total_weight }} Kg</small>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <br>\n                                <small style=\"font-size:0.7em;\">{{ item.total_weight / 1000 }} Kg</small>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% if doc.taxes[0].included_in_print_rate == 1 %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set inclusive_rate = item.base_price_list_rate %}\n                {% set exclusive_rate = inclusive_rate*100/(100+gst_rate) %}\n            \n            {% else %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set exclusive_rate = item.base_price_list_rate %}\n                {% set inclusive_rate = exclusive_rate*(100+gst_rate)/100 %}\n            \n            {% endif %}\n            \n            {% if bns_settings.rate_excl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {% if doc.is_print_gst_rate_per_row %}\n                <td colspan=\"4\">{{ gst_rate | round(0) | int }}%</td>\n            {% endif %}\n            \n            {% if bns_settings.rate_incl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {# --- Step 1: Calculate / Fix discount_percentage if needed --- #}\n            {% if item.discount_percentage == 0 and item.base_price_list_rate and item.base_rate and item.base_price_list_rate != item.base_rate %}\n                {% set manual_discount = ((item.base_price_list_rate - item.base_rate) * 100) / item.base_price_list_rate %}\n                {% set item_discount = \"{:.2f}\".format(manual_discount|float) %}\n            {% else %}\n                {% set item_discount = item.discount_percentage %}\n            {% endif %}\n            \n            {# --- Step 2: Render depending on discount_type --- #}\n            {% if bns_settings.discount_type != \"Single\" %}\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if (item.custom_d1_ == 0.0 and not item_discount) else (item.custom_d1_ if item.custom_d1_ != 0.0 else item_discount) ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d2_ == 0.0 else item.custom_d2_ ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d3_ == 0.0 else item.custom_d3_ ~ '%' }}\n                </td>\n            {% else %}\n                <td colspan=\"4\">{{ item_discount }}%</td>\n            {% endif %}\n            \n            \n            {% if bns_settings.is_item_amount_tax_incl %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount*(1+(gst_rate/100))), currency=base_currency) }}</b></td>\n            {% else %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount), currency=base_currency) }}</b></td>\n            {% endif %}\n        </tr>\n        {% endfor %}\n    </tbody>\n</table>\n\n<div class=\"final-tax-total-table\">\n    <table class=\"table table-bordered\">\n        <tbody>\n            <tr>\n                <td rowspan=1 colspan=5 style=\"vertical-align:top !important; width:45%;\" class=\"text-center\"><b>Bank Details</b></td>\n                <td class=\"text-right\" colspan=2><b>Total Taxable Value</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(doc.base_net_total), currency=base_currency) }}\n                </td>\n            </tr>\n    \n            {# --- calculate extra rows count --- #}\n            {% set taxes_count = doc.taxes | length %}\n            {% set extra_rows = taxes_count %}\n            {% if doc.discount_amount %}\n                {% set extra_rows = extra_rows + 1 %}\n            {% endif %}\n            {# +1 for Grand Total, +1 for Amount in words #}\n            {% set total_rows = extra_rows + 2 %}\n    \n            <tr>\n                <td class=\"text-center\" rowspan={{ total_rows+1 }} colspan=5 style=\"vertical-align:top !important;\">\n                    {% set bank_account = frappe.db.get_value(\"Bank Account\", {\"company\": doc.company, \"is_default\": 1}, [\"account_name\",\"bank\", \"bank_account_no\", \"branch_code\",\"iban\"], as_dict=True) %}\n                    {% if bank_account.account_name %}\n                    Account Name: <b><i>{{ bank_account.account_name }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank %}\n                    Bank Name: <b><i>{{ bank_account.bank }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank_account_no %}\n                    Account Number: <b><i>{{ bank_account.bank_account_no }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.branch_code %}\n                    Branch Code (IFSC): <b><i>{{ bank_account.branch_code }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.iban %}\n                    IBAN: <b><i>{{ bank_account.iban }}</i></b><br>\n                    {% endif %}\n                </td>\n            </tr>\n    \n            {# --- loop through Sales Taxes & Charges rows --- #}\n            {% for tax_row in doc.taxes %}\n            <tr>\n                <td class=\"text-right\" colspan=2 style=\"font-size:0.8em;\">\n                    <b>{{ tax_row.description or tax_row.account_head }}</b>\n                </td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(tax_row.base_tax_amount), currency=base_currency) }}\n                </td>\n            </tr>\n            {% endfor %}\n    \n            {% if doc.discount_amount %}\n            <tr>\n                <td class=\"text-right\" colspan=2>Additional Discount</td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_discount_amount, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            {% endif %}\n    \n            <tr>\n                <td class=\"text-right\" colspan=2><b>Grand Total</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_rounded_total, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            <tr>\n                <td colspan=4>\n                    <b>Amount (in words): </b><span style=\"font-size:0.85em\">{{ doc.base_in_words }}</span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n    \n    {{ doc.gst_breakup_table }}\n    {% if doc.is_print_gst_table %}\n    \n    {% set gst_summary = {} %}\n    {% set gst_flags = {\"uses_igst\": false, \"uses_cgst_sgst\": false} %}\n        \n        {% for item in doc.items %}\n            {% set gst_rate = (frappe.db.get_value(\"Item Tax Template\", {\"name\": item.item_tax_template}, \"gst_rate\") or 0) | float %}\n            {% set key = gst_rate|string %}\n        \n            {% if item.igst_amount %}\n                {% set _ = gst_flags.update({\"uses_igst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"igst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"igst_amount\": gst_summary[key].igst_amount + item.igst_amount\n                }) %}\n            {% elif item.cgst_amount and item.sgst_amount %}\n                {% set _ = gst_flags.update({\"uses_cgst_sgst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"cgst_amount\": 0,\n                        \"sgst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"cgst_amount\": gst_summary[key].cgst_amount + item.cgst_amount,\n                    \"sgst_amount\": gst_summary[key].sgst_amount + item.sgst_amount\n                }) %}\n            {% endif %}\n        {% endfor %}\n        \n        <h4>GST Summary</h4>\n        <table class=\"table table-bordered table-hover\" style=\"text-align: center;\">\n            <thead>\n                <tr>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">GST RATE</th>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">Taxable Value</th>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">CGST</th>\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">SGST/UTGST</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">IGST</th>\n                    {% endif %}\n                </tr>\n                <tr>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% endif %}\n                </tr>\n            </thead>\n            <tbody>\n                {% for row in gst_summary.values() %}\n                    <tr>\n                        <td>{{ row.gst_rate }}%</td>\n                        <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.taxable_value), currency=doc.currency) }}</td>\n        \n                        {% if gst_flags.uses_cgst_sgst %}\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.cgst_amount), currency=doc.currency) }}</td>\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.sgst_amount), currency=doc.currency) }}</td>\n                        {% elif gst_flags.uses_igst %}\n                            <td>{{ row.gst_rate }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.igst_amount), currency=doc.currency) }}</td>\n                        {% endif %}\n                    </tr>\n                {% endfor %}\n            </tbody>\n        </table>\n    \n    \n    {% endif %}\n    \n    \n    <table class=\"table table-bordered\" style=\" table-layout: fixed; border-collapse: collapse; width:100%; text-align:center; font-size:12px;\">\n        <tr rowspan=1>\n            <td rowspan=1 colspan=4>\n                <b>{% if doc.is_print_payment_terms==1%} Payment Terms {% endif %}</b>\n            </td>\n            <td colspan=4>\n                <b>Pre Authenticated By: {{doc.company}}</b>\n            </td>\n        </tr>\n        <tr>\n            <td colspan=4 rowspan=3>\n            {% if doc.payment_schedule and doc.is_print_payment_terms==1 %}\n            <table class=\"payment_terms_table\" style=\"width: 100%; border-collapse: collapse;\">\n                <thead>\n                    <tr>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Due Date</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Invoice Portion</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Payment Amount</b></th>\n    \n                    </tr>\n                </thead>\n                <tbody>\n                    {% for row in doc.payment_schedule %}\n                    <tr>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.due_date }}</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.invoice_portion }}%</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ frappe.utils.fmt_money(row.payment_amount, currency=\"INR\") }}</td>\n                    </tr>\n                    {% endfor %}\n                </tbody>\n            </table>\n            {% endif %}\n            </td>\n            <td colspan=4>\n                Issuing Signatory\n            </td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left\">\n                Name:\n            </td>\n            <td colspan=3></td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left;\">\n                Designation:\n            </td>\n            <td colspan=3></td>\n        </tr>\n    </table>\n\n</div>\n\n{% if doc.ewaybill %}\n    {% set e_waybill_data = frappe.db.get_value(\"e-Waybill Log\", {\"reference_name\": doc.name, \"reference_doctype\": \"Sales Invoice\"}, \"data\") %}\n    <div class=\"page-break\"></div>\n    {% set data = _dict(json.loads(e_waybill_data)) %}\n    {%- set irn = doc.irn -%}\n\n    {% if data.supplyType == \"O\" %}\n    {% set generated_by = data.fromTrdName %}\n    {% else %}\n    {% set generated_by = data.toTrdName %}\n    {% endif %}\n\n    <div id=\"ewaybill-page-layout\">\n        <table class=\"table borderless\" style=\"border:0\">\n            <tbody>\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <h3 class=\"title\">e-Waybill</h1>\n                    </td>\n                </tr>\n\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img src=\"data:image/png;base64,{{ get_e_waybill_qr_code(data.ewbNo,data.userGstin, data.ewayBillDate) }}\" class=\"qr-code\" />\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n\n        <table class=\"table borderless\">\n            <tbody>\n                <tr>\n                    <td>\n                        <span>e-Waybill No:</span>\n                    </td>\n                    <td>\n                        <span class=\"e-waybill-number\">\n                            <strong>{{ add_spacing(data.ewbNo, 4) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>e-Waybill Date:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \"\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Generated By:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>\n                                {{ add_spacing(data.userGstin, 5) }} - {{ generated_by }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid From:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \" \") }}\n                                {{ \" [\" }}{{ data.actualDist }}{{ \"Kms]\" }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid Until:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.validUpto[:10] }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if irn %}\n                <tr>\n                    <td>\n                        <span>IRN:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ irn }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - A</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Supplier</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.fromGstin, 5) }}-{{ data.fromTrdName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Dispatch</td>\n                    <td>\n                        <span>\n                            <strong>{{ data.fromPlace }},\n                                {{ get_state(data.actFromStateCode) }} -\n                                {{ data.fromPincode }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Recipient</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.toGstin, 5) }}-{{ data.toTrdName }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Delivery</td>\n                    <td>\n                        <span><strong>\n                                {{ data.toPlace }},\n                                {{ get_state(data.actToStateCode) }} -{{ data.toPincode }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document No.</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docNo }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document Date</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docDate }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Transaction Type:</span>\n                    </td>\n                    <td>\n                        <span><strong>{{ get_transport_type(data.transactionType) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Value of Goods</td>\n                    <td>\n                        <span class=\"classfont\">\n                            <strong>\n                                {{ frappe.utils.fmt_money(data.totInvValue, currency=\"INR\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>HSN Code</td>\n                    <td>\n                        <span class=\"form-control1\" onkeydown=\"expandtext(this);\">\n                            <strong>{{ data.itemList[0].hsnCode }}\n                                {%if data.itemList[0].productDesc%}\n                                {{ \" - \" ~data.itemList[0].productDesc }}\n                                {%endif%}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Reason for Transportation</td>\n                    <td>\n                        <span>\n                            <strong>{{ get_supply_type(data.supplyType) }} - {{ get_sub_supply_type(data.subSupplyType) }} </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Transporter</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.transporterId, 5) }}-\n                                {{ data.transporterName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if data.VehiclListDetails|length > 0 %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - B</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div>\n                            <table cellspacing=\"0\" cellpadding=\"3\" rules=\"all\" class=\"table table-responsive vehicle-info\" border=\"1\">\n                                <tbody>\n                                    <tr>\n                                        <th scope=\"col\">Mode</th>\n                                        <th scope=\"col\">\n                                            Vehicle / Trans <br />\n                                            Doc No &amp; Dt.\n                                        </th>\n                                        <th scope=\"col\">From</th>\n                                        <th scope=\"col\">Entered Date</th>\n                                        <th scope=\"col\">Entered By</th>\n                                        <th scope=\"col\">\n                                            Cdata No. <br />\n                                            (If any)\n                                        </th>\n                                        <th scope=\"col\">\n                                            Multi Veh.Info <br />\n                                            (If any)\n                                        </th>\n                                    </tr>\n                                    {% for detail in data.VehiclListDetails %}\n                                    <tr>\n                                        <td>\n                                            {{ get_transport_mode(detail.transMode) }}\n                                        </td>\n                                        <td>\n                                            {{ detail.vehicleNo }} /\n                                            {{ detail.transDocNo }} Dt:\n                                            {{ detail.transDocDate }}\n                                        </td>\n                                        <td>{{ detail.fromPlace }}</td>\n                                        <td>\n                                            {{ detail.enteredDate |\n                                                replace(\":00 \", \" \") }}\n                                        </td>\n                                        <td>{{ detail.userGSTINTransin }}</td>\n                                        <td>-</td>\n                                        <td>-</td>\n                                    </tr>\n                                    {% endfor%}\n                                </tbody>\n                            </table>\n                        </div>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img class=\"barcode\" src=\"data:image/png;base64,{{ get_ewaybill_barcode(data.ewbNo) }}\">\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    {% endif %}\n\n\n\n\n\n<div id=\"footer-html\">\n    <div class=\"text-center small page-footer-1\">\n        {{ _(\"Page {0} of {1}\").format('<span class=\"page\"></span>', '<span class=\"topage\"></span>') }}<br>This is a computer generated document and does not require a signature.\n    </div>\n</div>\n",
----+ "html": "{%- from \"templates/print_formats/standard_macros.html\" import add_header, render_field, print_value -%}\n\n{% set e_invoice_log = None %}\n{% if doc.irn %}\n{% set e_invoice_log = frappe.db.get_value(\n        \"e-Invoice Log\", doc.irn, (\"invoice_data\", \"signed_qr_code\"), as_dict=True\n    ) %}\n{% set invoice_data = e_invoice_log and e_invoice_log.invoice_data and _dict(json.loads(e_invoice_log.invoice_data)) or None %}\n{% endif %}\n\n{% macro format_address(address) %}\n{% if address %}\n<p>\n    {{ address.address_line1 }}\n    {% if address.address_line2 %}\n    {{ address.address_line2 }}<br>\n    {% endif %}\n    {{ address.city }}, {{ address.state }}, {{ address.country }}: {{ address.pincode }}<br>\n</p>\n{% endif %}\n{% endmacro %}\n\n{% set bns_settings = frappe.get_doc(\"BNS Settings\") %}\n{% set base_currency = frappe.db.get_value(\"Company\", doc.company, \"default_currency\") %}\n\n\n{% set company_cin = frappe.db.get_value(\"Company\", doc.company, \"bns_company_cin\") %}\n{% set msme_no = frappe.db.get_value(\"Company\", doc.company, \"bns_msme_no\") %}\n{% set msme_type = frappe.db.get_value(\"Company\", doc.company, \"bns_msme_type\") %}\n\n{% set copy_map = {\n    \"1\": \"Original for Recipient\",\n    \"2\": \"Duplicate for Transporter\",\n    \"3\": \"Duplicate for Supplier\",\n    \"4\": \"Triplicate for Supplier\"\n} %}\n\n{% set invoice_copy_param = frappe.form_dict.get(\"invoice_copy\") or \"1\" %}\n{% set invoice_copy_text = copy_map.get(invoice_copy_param, \"Original for Recipient\") %}\n\n\n<!--<div class=\"watermark text-center\">MEVABITE</div>-->\n\n<!--<div class=\"page\">-->\n\n\n<div id=\"header-html\">\n    <div class=\"watermark\">{{ invoice_copy_text }}</div>\n    <div class=\"row print-heading\" style=\"line-height:1.1;padding:10px\">\n        <div class=\"col-xs-3 column-break\">\n            {% set company_logo = frappe.db.get_value(\"Company\", doc.company, \"logo_for_printing\") %}\n            {% if company_logo %}\n            <div>\n                <img height=\"125px\" width=\"150px\" src=\"{{ company_logo }}\">\n            </div>\n            {% endif %}\n        </div>\n        <div class=\"col-xs-6 column-break text-center\">\n            <h3 style=\"margin-bottom:0;\"><b>{{ doc.company }}</b></h3>\n            {% if frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\") %}\n                <div style=\"font-size:0.85em;\">Previously Known As: {{frappe.db.get_value(\"Company\",doc.company,\"bns_previously_known_as\")}}</div>\n            {% endif %}\n            <div style=\"font-size:0.85rem\">\n                {% set seller_address = frappe.db.get_value(\"Address\", doc.company_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                    {{ format_address(seller_address) }}\n                    {% if company_cin %}\n                    <span style=\"font-size:0.8em;\">CIN: {{ company_cin }}</span><br>\n                    {% endif %}\n                    {% if doc.company_gstin %}\n                    <span style=\"font-size:0.8em;\"><b>GST:</b> {{ doc.company_gstin }}</span> | \n                    {% endif %}\n                    <span style=\"font-size:0.8em;\">PAN: {{ frappe.db.get_value(\"Company\", doc.company, \"pan\") }}</span><br>\n                    {% if msme_no %}\n                    <span style=\"font-size:0.76em;\">MSME No.: {{ doc.msme_no }}</span> | \n                    {% endif %}\n                    {% if msme_type %}\n                    <span style=\"font-size:0.76em;\">MSME Type: {{ doc.msme_type }}</span>\n                    {% endif %}\n                \n            </div>\n        </div>\n        <div class=\"col-xs-3 column-break text-right\">\n            <h2 style=\"margin-top:5mm;\"><b>\n                    {% if doc.status == \"Cancelled\" and doc.is_return %}\n                        Cancelled Credit Note\n                    {% elif doc.status == \"Cancelled\" %}\n                        Cancelled Invoice\n                    {% elif doc.status == \"Draft\" and doc.is_return %}\n                        Draft Credit Note\n                    {% elif doc.status == \"Draft\" %}\n                        Draft Invoice\n                    {% elif doc.is_return %}\n                        Credit Note\n                    {% elif doc.irn %}\n                        e-Invoice\n                    {% else %}\n                        Tax Invoice\n                    {% endif %}\n                </b>\n            </h2>\n            <div class=\"invoice-meta\">\n              <table class=\"table-condensed no-border\" style=\"width:100%; font-size:0.9em; text-align:left;\">\n                <tr>\n                  <td><b>Invoice Date:</b></td>\n                  <td>{{ frappe.utils.formatdate(doc.posting_date) }}</td>\n                </tr>\n                <tr>\n                  <td><b>Invoice No:</b></td>\n                  <td><b>{{ doc.name }}</b></td>\n                </tr>\n              </table>\n            </div>\n        </div>\n    </div>\n</div>\n\n{% if doc.irn %}\n<div class=\"einv-det\">\n    <!--<div class=\"col-xs-2 column-break text-left\"></div>-->\n    <div class=\"col-xs-4 column-break text-left\">\n        {% if e_invoice_log and e_invoice_log.signed_qr_code %}\n        <img class=\"qrcode\" src=\"data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}\">\n        {% endif %}\n    </div>\n    <div class=\"col-xs-8 column-break text-right\">\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>IRN</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.irn }}</u></div>\n        </div>\n        {% if invoice_data and invoice_data.AckNo %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. No.</label></div>\n            <div class=\"col-xs-8 value\">{{ invoice_data.AckNo }}</div>\n        </div>\n        {% endif %}\n        {% if invoice_data and invoice_data.AckDt %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>Ack. Date</label></div>\n            <div class=\"col-xs-8 value\">{{ frappe.utils.format_datetime(invoice_data.AckDt, \"dd/MM/yyyy hh:mm:ss\") }}</div>\n        </div>\n        {% endif %}\n        {% if doc.ewaybill %}\n        <div class=\"row data-field\">\n            <div class=\"col-xs-4\"><label>e-Waybill No.</label></div>\n            <div class=\"col-xs-8 value\"><u>{{ doc.ewaybill }}</u></div>\n        </div>\n        {% endif %}\n    </div>\n    <!--<div class=\"col-xs-1 column-break text-right\">-->\n    </div>\n{% endif %}\n\n<table class=\"table table-bordered party-details-table\">\n    <tbody>\n        <tr>\n            <td colspan=3 rowspan=4 style=\"width:45%;\">\n                {% set contact_person = frappe.db.get_value(\n            \"Contact\", doc.contact_person, (\"mobile_no\"), as_dict=True\n        ) %}\n                <h6><b><u>Buyer Details</u></b></h6>\n                <p><b>{{ doc.customer_name }}</b></p>\n                {% set customer_address = frappe.db.get_value(\"Address\", doc.customer_address, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(customer_address) }}\n\n                {% if doc.billing_address_gstin %}\n                GST: <u>{{ doc.billing_address_gstin }}</u><br>\n                {% endif %}\n                {% set customer_pan = frappe.db.get_value(\"Customer\", doc.customer_name, \"pan\")%}\n                {% if customer_pan %}\n                PAN: {{ customer_pan }}<br>\n                {% endif %}\n                {% if contact_person.mobile_no %}\n                Phone No: {{ contact_person.mobile_no }}\n                {% endif %}\n                {% if doc.shipping_address %}\n                <br>\n                <h6><b><u>Shipping Details</u></b></h6>\n                {% set shipping_address = frappe.db.get_value(\"Address\", doc.shipping_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\",\"gstin\"], as_dict=True) %}\n                {{ format_address(shipping_address) }}\n                {% if shipping_address.gstin %}\n                GST: <u>{{ shipping_address.gstin }}</u><br>\n                {% endif %}\n                {% endif %}\n                {% if doc.dispatch_address %}\n                <h6><b><u>Dispatch Details</u></b></h6>\n                <p><b>{{ frappe.db.get_value(\"Address\", doc.dispatch_address_name, \"address_title\") }}</b></p>\n                <!--<p>{{doc.dispatch_address}}</p>-->\n                {% set dispatch_address = frappe.db.get_value(\"Address\", doc.dispatch_address_name, [\"address_line1\", \"address_line2\", \"city\", \"state\", \"pincode\", \"country\"], as_dict=True) %}\n                {{ format_address(dispatch_address) }}\n                {% endif %}\n            </td>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Transporter:</h6>\n                {% if doc.transporter_name %}\n                {{ doc.transporter_name }} <br>\n                {{ doc.gst_transporter_id }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Vehicle No:</h6>\n                {% if doc.vehicle_no %}\n                {{ doc.vehicle_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>Builty No:</h6>\n                {% if doc.custom_builty_no %}\n                {{ doc.custom_builty_no }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1>\n                <h6>Place Of Supply</h6>\n                {{ doc.place_of_supply }}\n            </td>\n            {% if not doc.irn and doc.ewaybill %}\n            <td colspan=1>\n                <h6>e-Waybill No.</h6>\n                <u>{{ doc.ewaybill }}</u>\n            </td>            \n            {% endif %}\n            <td colspan=1>\n                <h6>Buyer's PO No:</h6>\n                {% if doc.po_no %}\n                {{ doc.po_no }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=1>\n                <h6>PO Date:</h6>\n                {% if doc.po_date %}\n                {{ doc.po_date }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% if doc.incoterm or doc.named_place  %}\n        <tr>\n            <td colspan=\"{{ 2 if (not doc.irn and doc.ewaybill) else 1 }}\">\n                <h6>Incoterm:</h6>\n                {% if doc.incoterm %}\n                {{ doc.incoterm }}\n                {% else %}<br>{% endif %}\n            </td>\n            <td colspan=2>\n                <h6>Named Place:</h6>\n                {% if doc.named_place %}\n                {{ doc.named_place }}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n        {% endif %}\n        <tr>\n            <td colspan=1>\n                \n                <h6>Destination:</h6>\n                {% if doc.custom_destination %}\n                {{doc.custom_destination}}\n                {% else %}<br>{% endif %}\n            </td>\n            <td rowspan=2 colspan=\"{{ 3 if (not doc.irn and doc.ewaybill) else 2 }}\">\n                <h6>Terms of Delivery:</h6>\n                {% if doc.custom_terms_of_delivery %}\n                {{ doc.custom_terms_of_delivery }}\n                {% elif doc.custom_terms_of_delivery_new %}\n                {{ doc.custom_terms_of_delivery_new }}\n                {% else %}<br><br>{% endif %}\n            </td>\n        </tr>\n        <tr>\n            <td colspan=1 rowspan=1>\n                <h6>Doc No:</h6>\n                {% if doc.custom_doc_no %}\n                {{doc.custom_doc_no}}\n                {% else %}<br>{% endif %}\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n\n<table class=\"table table-bordered item-det\">\n<thead>\n    <tr>\n        <th colspan=\"2\">#</th>\n        <th>Item</th>\n        <th colspan=\"7\">Qty</th>\n        {% if bns_settings.rate_excl_tax %}\n        <th colspan=\"9\">Rate(Exc Tax)</th>\n        {% endif %}\n        {% if doc.is_print_gst_rate_per_row %}\n        <th colspan=\"4\">GST</th>\n        {% endif %}\n        {% if bns_settings.rate_incl_tax %}\n        <th colspan=\"9\">Rate(Inc Tax)</th>\n        {% endif %}\n        {% if bns_settings.discount_type == \"Triple Compounded\" %}\n        <th colspan=\"4\">D1</th>\n        <th colspan=\"4\">D2</th>\n        <th colspan=\"4\">D3</th>\n        {% else %}\n        <th colspan=\"4\">Disc</th>\n        {% endif %}\n        {% if bns_settings.is_item_amount_tax_incl %}\n        <th colspan=\"11\">Amount(Incl)</th>\n        {% else %}\n        <th colspan=\"11\">Amount(Excl)</th>\n        {% endif %}\n    </tr>\n</thead>\n\n    <tbody>\n        {% for item in doc.items %}\n        <tr class=\"no-break {{ 'odd' if loop.index is odd else 'even' }}\">\n            <td colspan=\"2\">{{ loop.index }}</td>\n            <td class=\"item-det-item-name\">\n                <b>{% if bns_settings.show_item_code or doc.bns_show_item_code %}{{ item.item_code }}:{% endif %}{{ item.item_name }}</b><br>\n                <p style=\"font-size:0.8em;margin:0;\"><i>\n                {% if item.gst_hsn_code %}\n                    <b>HSN/SAC: </b>{{item.gst_hsn_code}}\n                {% endif %}\n                {% if item.barcode and (doc.bns_show_item_barcode or bns_settings.bns_show_item_barcode) %}\n                    | <b>EAN:</b> {{ item.barcode }}\n                {% endif %}\n                </i>\n                </p>\n            </td>\n            <td colspan=\"7\">\n                <b>\n                    <span>{{ item.qty }} {{ item.uom }}</span>\n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <small style=\"font-size:0.9em;\">{{ (item.conversion_factor * item.qty / print_uom_conversion ) | int }} {{ print_uom }} </small>\n                                \n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <br>\n                                <small style=\"font-size:0.75em;\">{{ item.total_weight }} Kg</small>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <br>\n                                <small style=\"font-size:0.85em;\">{{ item.total_weight / 1000 }} Kg</small>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% if doc.taxes[0].included_in_print_rate == 1 %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set inclusive_rate = item.base_price_list_rate %}\n                {% set exclusive_rate = inclusive_rate*100/(100+gst_rate) %}\n            \n            {% else %}\n            \n                {% set gst_rate = frappe.db.get_value(\"Item Tax Template\",{\"name\": item.item_tax_template},[\"gst_rate\"]) %}\n                {% set exclusive_rate = item.base_price_list_rate %}\n                {% set inclusive_rate = exclusive_rate*(100+gst_rate)/100 %}\n            \n            {% endif %}\n            \n            {% if bns_settings.rate_excl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.95em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(exclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.85em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.85em;\">\n                                    {% set calculated_value = exclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {% if doc.is_print_gst_rate_per_row %}\n                <td colspan=\"4\">{{ gst_rate | round(0) | int }}%</td>\n            {% endif %}\n            \n            {% if bns_settings.rate_incl_tax %}\n            <td colspan=\"9\">\n                <b>\n                    <span>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate), currency=base_currency) }}/<small style=\"font-size:0.45rem;\">{{ item.uom }}</small>\n                    </span>\n                    \n                    {% if bns_settings.secondary_rate_display %}\n                        {% if bns_settings.secondary_rate_field == \"print_uom\" %}\n                            {% set print_uom = frappe.db.get_value(\"Item\", item.item_code, \"custom_print_uom\") %}\n                            {% if print_uom and item.uom != print_uom %}\n                                {% set print_uom_conversion = frappe.db.get_value(\n                                    \"UOM Conversion Detail\",\n                                    {\"parent\": item.item_code, \"uom\": print_uom},\n                                    \"conversion_factor\"\n                                ) %}\n                                <br>\n                                <span style=\"font-size:0.9em;\">\n                                {{ frappe.utils.fmt_money(\"{:.2f}\".format(inclusive_rate * print_uom_conversion / item.conversion_factor), currency=base_currency) }}/<small style=\"font-size:0.35rem;\">{{ print_uom }}</small>\n                                </span>\n                            {% endif %}\n                        {% elif bns_settings.secondary_rate_field == \"weight_uom\" and item.total_weight != 0 %}\n                            {% if item.weight_uom == \"Kg\" and item.weight_uom != item.uom %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% elif item.weight_uom == \"Gram\" and item.weight_uom != \"Kg\" and item.weight_uom != \"Gram\" %}\n                                <p style=\"font-size:0.8em;\">\n                                    {% set calculated_value = inclusive_rate * item.qty * 1000 / item.total_weight %}\n                                    {{ frappe.utils.fmt_money(calculated_value, currency=base_currency) }}/Kg\n                                </p>\n                            {% endif %}\n                        {% endif %}\n                    {% endif %}\n                </b>\n            </td>\n            {% endif %}\n            \n            {# --- Step 1: Calculate / Fix discount_percentage if needed --- #}\n            {% if item.discount_percentage == 0 and item.base_price_list_rate and item.base_rate and item.base_price_list_rate != item.base_rate %}\n                {% set manual_discount = ((item.base_price_list_rate - item.base_rate) * 100) / item.base_price_list_rate %}\n                {% set item_discount = \"{:.2f}\".format(manual_discount|float) %}\n            {% else %}\n                {% set item_discount = item.discount_percentage %}\n            {% endif %}\n            \n            {# --- Step 2: Render depending on discount_type --- #}\n            {% if bns_settings.discount_type != \"Single\" %}\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if (item.custom_d1_ == 0.0 and not item_discount) else (item.custom_d1_ if item.custom_d1_ != 0.0 else item_discount) ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d2_ == 0.0 else item.custom_d2_ ~ '%' }}\n                </td>\n                <td colspan=\"4\" style=\"font-size:0.8em;\">\n                    {{ '-' if item.custom_d3_ == 0.0 else item.custom_d3_ ~ '%' }}\n                </td>\n            {% else %}\n                <td colspan=\"4\">{{ item_discount }}%</td>\n            {% endif %}\n            \n            \n            {% if bns_settings.is_item_amount_tax_incl %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount*(1+(gst_rate/100))), currency=base_currency) }}</b></td>\n            {% else %}\n            <td colspan=\"11\"><b>{{ frappe.utils.fmt_money(\"{:.2f}\".format(item.base_net_amount), currency=base_currency) }}</b></td>\n            {% endif %}\n        </tr>\n        {% endfor %}\n    </tbody>\n</table>\n\n<div class=\"final-tax-total-table\">\n    <table class=\"table table-bordered\">\n        <tbody>\n            <tr>\n                <td rowspan=1 colspan=5 style=\"vertical-align:top !important; width:45%;\" class=\"text-center\"><b>Bank Details</b></td>\n                <td class=\"text-right\" colspan=2><b>Total Taxable Value</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(doc.base_net_total), currency=base_currency) }}\n                </td>\n            </tr>\n    \n            {# --- calculate extra rows count --- #}\n            {% set taxes_count = doc.taxes | length %}\n            {% set extra_rows = taxes_count %}\n            {% if doc.discount_amount %}\n                {% set extra_rows = extra_rows + 1 %}\n            {% endif %}\n            {# +1 for Grand Total, +1 for Amount in words #}\n            {% set total_rows = extra_rows + 2 %}\n    \n            <tr>\n                <td class=\"text-center\" rowspan={{ total_rows+1 }} colspan=5 style=\"vertical-align:top !important;\">\n                    {% set bank_account = frappe.db.get_value(\"Bank Account\", {\"company\": doc.company, \"is_default\": 1}, [\"account_name\",\"bank\", \"bank_account_no\", \"branch_code\",\"iban\"], as_dict=True) %}\n                    {% if bank_account.account_name %}\n                    Account Name: <b><i>{{ bank_account.account_name }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank %}\n                    Bank Name: <b><i>{{ bank_account.bank }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.bank_account_no %}\n                    Account Number: <b><i>{{ bank_account.bank_account_no }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.branch_code %}\n                    Branch Code (IFSC): <b><i>{{ bank_account.branch_code }}</i></b><br>\n                    {% endif %}\n                    {% if bank_account.iban %}\n                    IBAN: <b><i>{{ bank_account.iban }}</i></b><br>\n                    {% endif %}\n                </td>\n            </tr>\n    \n            {# --- loop through Sales Taxes & Charges rows --- #}\n            {% for tax_row in doc.taxes %}\n            <tr>\n                <td class=\"text-right\" colspan=2 style=\"font-size:0.8em;\">\n                    <b>{{ tax_row.description or tax_row.account_head }}</b>\n                </td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    {{ frappe.utils.fmt_money(\"{:.2f}\".format(tax_row.base_tax_amount), currency=base_currency) }}\n                </td>\n            </tr>\n            {% endfor %}\n    \n            {% if doc.discount_amount %}\n            <tr>\n                <td class=\"text-right\" colspan=2>Additional Discount</td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(doc.base_discount_amount, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            {% endif %}\n    \n            {% set total_to_show = doc.base_rounded_total\n            if doc.base_rounded_total and doc.base_rounded_total != 0\n            else doc.base_grand_total\n            %}\n    \n            <tr>\n                <td class=\"text-right\" colspan=2><b>Grand Total</b></td>\n                <td class=\"text-right text-nowrap\" colspan=2>\n                    <b>{{ frappe.utils.fmt_money(total_to_show, currency=base_currency) }}</b>\n                </td>\n            </tr>\n            <tr>\n                <td colspan=4>\n                    <b>Amount (in words): </b><span style=\"font-size:0.85em\">{{ doc.base_in_words }}</span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n    \n    {{ doc.gst_breakup_table }}\n    {% if doc.is_print_gst_table %}\n    \n    {% set gst_summary = {} %}\n    {% set gst_flags = {\"uses_igst\": false, \"uses_cgst_sgst\": false} %}\n        \n        {% for item in doc.items %}\n            {% set gst_rate = (frappe.db.get_value(\"Item Tax Template\", {\"name\": item.item_tax_template}, \"gst_rate\") or 0) | float %}\n            {% set key = gst_rate|string %}\n        \n            {% if item.igst_amount %}\n                {% set _ = gst_flags.update({\"uses_igst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"igst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"igst_amount\": gst_summary[key].igst_amount + item.igst_amount\n                }) %}\n            {% elif item.cgst_amount and item.sgst_amount %}\n                {% set _ = gst_flags.update({\"uses_cgst_sgst\": true}) %}\n                {% if gst_summary[key] is not defined %}\n                    {% set _ = gst_summary.update({ key: {\n                        \"gst_rate\": gst_rate,\n                        \"taxable_value\": 0,\n                        \"cgst_amount\": 0,\n                        \"sgst_amount\": 0\n                    } }) %}\n                {% endif %}\n                {% set _ = gst_summary[key].update({\n                    \"taxable_value\": gst_summary[key].taxable_value + item.net_amount,\n                    \"cgst_amount\": gst_summary[key].cgst_amount + item.cgst_amount,\n                    \"sgst_amount\": gst_summary[key].sgst_amount + item.sgst_amount\n                }) %}\n            {% endif %}\n        {% endfor %}\n        \n        <h4>GST Summary</h4>\n        <table class=\"table table-bordered table-hover\" style=\"text-align: center;\">\n            <thead>\n                <tr>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">GST RATE</th>\n                    <th rowspan=\"2\" style=\"text-align: center; vertical-align: middle;\">Taxable Value</th>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">CGST</th>\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">SGST/UTGST</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th colspan=\"2\" style=\"text-align: center; vertical-align: middle;\">IGST</th>\n                    {% endif %}\n                </tr>\n                <tr>\n                    {% if gst_flags.uses_cgst_sgst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% elif gst_flags.uses_igst %}\n                        <th style=\"text-align: center; vertical-align: middle;\">Rate</th>\n                        <th style=\"text-align: center; vertical-align: middle;\">Amount</th>\n                    {% endif %}\n                </tr>\n            </thead>\n            <tbody>\n                {% for row in gst_summary.values() %}\n                    <tr>\n                        <td>{{ row.gst_rate }}%</td>\n                        <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.taxable_value), currency=doc.currency) }}</td>\n        \n                        {% if gst_flags.uses_cgst_sgst %}\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.cgst_amount), currency=doc.currency) }}</td>\n                            <td>{{ (row.gst_rate / 2) | round(1) }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.sgst_amount), currency=doc.currency) }}</td>\n                        {% elif gst_flags.uses_igst %}\n                            <td>{{ row.gst_rate }}%</td>\n                            <td>{{ frappe.utils.fmt_money(\"{:.2f}\".format(row.igst_amount), currency=doc.currency) }}</td>\n                        {% endif %}\n                    </tr>\n                {% endfor %}\n            </tbody>\n        </table>\n    \n    \n    {% endif %}\n    \n\n    \n    <table class=\"table table-bordered\" style=\" table-layout: fixed; border-collapse: collapse; width:100%; text-align:center; font-size:12px;\">\n        <tr rowspan=1>\n            <td rowspan=1 colspan=4>\n                <b>{% if doc.is_print_payment_terms==1%} Payment Terms {% endif %}</b>\n            </td>\n            <td colspan=4>\n                <b>Pre Authenticated By: {{doc.company}}</b>\n            </td>\n        </tr>\n        <tr>\n            <td colspan=4 rowspan=3>\n            {% if doc.payment_schedule and doc.is_print_payment_terms==1 %}\n            <table class=\"payment_terms_table\" style=\"width: 100%; border-collapse: collapse;\">\n                <thead>\n                    <tr>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Due Date</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Invoice Portion</b></th>\n                        <th style=\"border: 1px solid black; padding: 8px;\"><b>Payment Amount</b></th>\n    \n                    </tr>\n                </thead>\n                <tbody>\n                    {% for row in doc.payment_schedule %}\n                    <tr>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.due_date }}</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ row.invoice_portion }}%</td>\n                        <td style=\"border: 1px solid black; padding: 8px;\">{{ frappe.utils.fmt_money(row.payment_amount, currency=\"INR\") }}</td>\n                    </tr>\n                    {% endfor %}\n                </tbody>\n            </table>\n            {% endif %}\n            </td>\n            <td colspan=4>\n                Issuing Signatory\n            </td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left\">\n                Name:\n            </td>\n            <td colspan=3></td>\n        </tr>\n        <tr rowspan=1>\n            <td colspan=1 style=\"text-align:left;\">\n                Designation:\n            </td>\n            <td colspan=3></td>\n        </tr>\n    </table>\n    {% if doc.terms %}\n    <p style=\"margin:0px;border: 1px solid black;page-break-inside: avoid;\">\n        <h6 style=\"margin:0px;\">Terms & Conditions:</h6>\n        {{ doc.terms }}\n    </p>\n    {% endif %}\n\n</div>\n\n\n{% if doc.ewaybill %}\n    {% set e_waybill_data = frappe.db.get_value(\"e-Waybill Log\", {\"reference_name\": doc.name, \"reference_doctype\": \"Sales Invoice\"}, \"data\") %}\n    <div class=\"page-break\"></div>\n    {% set data = _dict(json.loads(e_waybill_data)) %}\n    {%- set irn = doc.irn -%}\n\n    {% if data.supplyType == \"O\" %}\n    {% set generated_by = data.fromTrdName %}\n    {% else %}\n    {% set generated_by = data.toTrdName %}\n    {% endif %}\n\n    <div id=\"ewaybill-page-layout\">\n        <table class=\"table borderless\" style=\"border:0\">\n            <tbody>\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <h3 class=\"title\">e-Waybill</h1>\n                    </td>\n                </tr>\n\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img src=\"data:image/png;base64,{{ get_e_waybill_qr_code(data.ewbNo,data.userGstin, data.ewayBillDate) }}\" class=\"qr-code\" />\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n\n        <table class=\"table borderless\">\n            <tbody>\n                <tr>\n                    <td>\n                        <span>e-Waybill No:</span>\n                    </td>\n                    <td>\n                        <span class=\"e-waybill-number\">\n                            <strong>{{ add_spacing(data.ewbNo, 4) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>e-Waybill Date:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \"\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Generated By:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>\n                                {{ add_spacing(data.userGstin, 5) }} - {{ generated_by }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid From:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.ewayBillDate | replace(\":00 \", \" \") }}\n                                {{ \" [\" }}{{ data.actualDist }}{{ \"Kms]\" }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Valid Until:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ data.validUpto[:10] }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if irn %}\n                <tr>\n                    <td>\n                        <span>IRN:</span>\n                    </td>\n                    <td>\n                        <span>\n                            <strong>{{ irn }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - A</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Supplier</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.fromGstin, 5) }}-{{ data.fromTrdName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Dispatch</td>\n                    <td>\n                        <span>\n                            <strong>{{ data.fromPlace }},\n                                {{ get_state(data.actFromStateCode) }} -\n                                {{ data.fromPincode }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>GSTIN of Recipient</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.toGstin, 5) }}-{{ data.toTrdName }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Place of Delivery</td>\n                    <td>\n                        <span><strong>\n                                {{ data.toPlace }},\n                                {{ get_state(data.actToStateCode) }} -{{ data.toPincode }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document No.</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docNo }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Document Date</td>\n                    <td>\n                        <span><strong>\n                                {{ data.docDate }}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <span>Transaction Type:</span>\n                    </td>\n                    <td>\n                        <span><strong>{{ get_transport_type(data.transactionType) }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Value of Goods</td>\n                    <td>\n                        <span class=\"classfont\">\n                            <strong>\n                                {{ frappe.utils.fmt_money(data.totInvValue, currency=\"INR\") }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>HSN Code</td>\n                    <td>\n                        <span class=\"form-control1\" onkeydown=\"expandtext(this);\">\n                            <strong>{{ data.itemList[0].hsnCode }}\n                                {%if data.itemList[0].productDesc%}\n                                {{ \" - \" ~data.itemList[0].productDesc }}\n                                {%endif%}\n                            </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Reason for Transportation</td>\n                    <td>\n                        <span>\n                            <strong>{{ get_supply_type(data.supplyType) }} - {{ get_sub_supply_type(data.subSupplyType) }} </strong>\n                        </span>\n                    </td>\n                </tr>\n                <tr>\n                    <td>Transporter</td>\n                    <td>\n                        <span>\n                            <strong>{{ add_spacing(data.transporterId, 5) }}-\n                                {{ data.transporterName }}</strong>\n                        </span>\n                    </td>\n                </tr>\n                {% if data.VehiclListDetails|length > 0 %}\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                        <strong>Part - B</strong>\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div>\n                            <table cellspacing=\"0\" cellpadding=\"3\" rules=\"all\" class=\"table table-responsive vehicle-info\" border=\"1\">\n                                <tbody>\n                                    <tr>\n                                        <th scope=\"col\">Mode</th>\n                                        <th scope=\"col\">\n                                            Vehicle / Trans <br />\n                                            Doc No &amp; Dt.\n                                        </th>\n                                        <th scope=\"col\">From</th>\n                                        <th scope=\"col\">Entered Date</th>\n                                        <th scope=\"col\">Entered By</th>\n                                        <th scope=\"col\">\n                                            Cdata No. <br />\n                                            (If any)\n                                        </th>\n                                        <th scope=\"col\">\n                                            Multi Veh.Info <br />\n                                            (If any)\n                                        </th>\n                                    </tr>\n                                    {% for detail in data.VehiclListDetails %}\n                                    <tr>\n                                        <td>\n                                            {{ get_transport_mode(detail.transMode) }}\n                                        </td>\n                                        <td>\n                                            {{ detail.vehicleNo }} /\n                                            {{ detail.transDocNo }} Dt:\n                                            {{ detail.transDocDate }}\n                                        </td>\n                                        <td>{{ detail.fromPlace }}</td>\n                                        <td>\n                                            {{ detail.enteredDate |\n                                                replace(\":00 \", \" \") }}\n                                        </td>\n                                        <td>{{ detail.userGSTINTransin }}</td>\n                                        <td>-</td>\n                                        <td>-</td>\n                                    </tr>\n                                    {% endfor%}\n                                </tbody>\n                            </table>\n                        </div>\n                    </td>\n                </tr>\n                {% endif %}\n                <tr>\n                    <td colspan=\"2\" class=\"text-center\">\n                        <img class=\"barcode\" src=\"data:image/png;base64,{{ get_ewaybill_barcode(data.ewbNo) }}\">\n                    </td>\n                </tr>\n                <tr>\n                    <td colspan=\"2\">\n                        <div class=\"section-separator\"></div>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    {% endif %}\n\n\n\n\n\n<div id=\"footer-html\">\n    <div class=\"text-center small page-footer-1\">\n        {{ _(\"Page {0} of {1}\").format('<span class=\"page\"></span>', '<span class=\"topage\"></span>') }}<br>This is a computer generated document and does not require a signature.\n    </div>\n</div>\n",
----  "idx": 0,
----  "line_breaks": 0,
----  "margin_bottom": 0.0,
----  "margin_left": 0.0,
----  "margin_right": 0.0,
----  "margin_top": 0.0,
----- "modified": "2025-10-08 23:05:57.160865",
----+ "modified": "2026-01-11 22:13:23.243507",
----  "modified_by": "Administrator",
----  "module": "Business Needed Solutions",
----  "name": "BNS SI Dynamic V2",
----  "owner": "sagarratangarg@rbcolour.com",
----  "page_number": "Bottom Center",
----- "pdf_generator": "PrintX",
----+ "print_designer": 0,
----  "print_format_builder": 0,
----  "print_format_builder_beta": 0,
----  "print_format_for": "DocType",
----diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
----index 78ab0ee..db2730d 100644
------- a/business_needed_solutions/fixtures/custom_field.json
----+++ b/business_needed_solutions/fixtures/custom_field.json
----@@ -56,6 +56,63 @@
----   "unique": 0,
----   "width": null
----  },
----+ {
----+  "allow_in_quick_entry": 0,
----+  "allow_on_submit": 0,
----+  "bold": 0,
----+  "collapsible": 0,
----+  "collapsible_depends_on": null,
----+  "columns": 0,
----+  "default": "0",
----+  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock') && frappe.db.get_single_value('BNS Settings', 'enable_per_warehouse_negative_stock_disallow')",
----+  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings. This feature must be enabled in BNS Settings first.",
----+  "docstatus": 0,
----+  "doctype": "Custom Field",
----+  "dt": "Warehouse",
----+  "fetch_from": null,
----+  "fetch_if_empty": 0,
----+  "fieldname": "bns_disallow_negative_stock",
----+  "fieldtype": "Check",
----+  "hidden": 0,
----+  "hide_border": 0,
----+  "hide_days": 0,
----+  "hide_seconds": 0,
----+  "ignore_user_permissions": 0,
----+  "ignore_xss_filter": 0,
----+  "in_global_search": 0,
----+  "in_list_view": 0,
----+  "in_preview": 0,
----+  "in_standard_filter": 0,
----+  "insert_after": "is_rejected_warehouse",
----+  "is_system_generated": 0,
----+  "is_virtual": 0,
----+  "label": "Disallow Negative Stock",
----+  "length": 0,
----+  "link_filters": null,
----+  "mandatory_depends_on": null,
----+  "modified": "2025-01-27 10:00:00",
----+  "module": "Business Needed Solutions",
----+  "name": "Warehouse-bns_disallow_negative_stock",
----+  "no_copy": 0,
----+  "non_negative": 0,
----+  "options": null,
----+  "permlevel": 0,
----+  "placeholder": null,
----+  "precision": "",
----+  "print_hide": 0,
----+  "print_hide_if_no_value": 0,
----+  "print_width": null,
----+  "read_only": 0,
----+  "read_only_depends_on": null,
----+  "report_hide": 0,
----+  "reqd": 0,
----+  "search_index": 0,
----+  "show_dashboard": 0,
----+  "sort_options": 0,
----+  "translatable": 0,
----+  "unique": 0,
----+  "width": null
----+ },
----  {
----   "allow_in_quick_entry": 0,
----   "allow_on_submit": 0,
----@@ -170,6 +227,177 @@
----   "unique": 0,
----   "width": null
----  },
----+ {
----+  "allow_in_quick_entry": 0,
----+  "allow_on_submit": 0,
----+  "bold": 0,
----+  "collapsible": 0,
----+  "collapsible_depends_on": null,
----+  "columns": 0,
----+  "default": null,
----+  "depends_on": null,
----+  "description": null,
----+  "docstatus": 0,
----+  "doctype": "Custom Field",
----+  "dt": "Company",
----+  "fetch_from": null,
----+  "fetch_if_empty": 0,
----+  "fieldname": "bns_company_cin",
----+  "fieldtype": "Data",
----+  "hidden": 0,
----+  "hide_border": 0,
----+  "hide_days": 0,
----+  "hide_seconds": 0,
----+  "ignore_user_permissions": 0,
----+  "ignore_xss_filter": 0,
----+  "in_global_search": 0,
----+  "in_list_view": 0,
----+  "in_preview": 0,
----+  "in_standard_filter": 0,
----+  "insert_after": "tax_id",
----+  "is_system_generated": 0,
----+  "is_virtual": 0,
----+  "label": "Corporate Identification Number",
----+  "length": 0,
----+  "link_filters": null,
----+  "mandatory_depends_on": null,
----+  "modified": "2026-01-11 21:30:40.727439",
----+  "module": "Business Needed Solutions",
----+  "name": "Company-custom_corporate_identification_number",
----+  "no_copy": 0,
----+  "non_negative": 0,
----+  "options": null,
----+  "permlevel": 0,
----+  "placeholder": null,
----+  "precision": "",
----+  "print_hide": 0,
----+  "print_hide_if_no_value": 0,
----+  "print_width": null,
----+  "read_only": 0,
----+  "read_only_depends_on": null,
----+  "report_hide": 0,
----+  "reqd": 0,
----+  "search_index": 0,
----+  "show_dashboard": 0,
----+  "sort_options": 0,
----+  "translatable": 1,
----+  "unique": 0,
----+  "width": null
----+ },
----+ {
----+  "allow_in_quick_entry": 0,
----+  "allow_on_submit": 0,
----+  "bold": 0,
----+  "collapsible": 0,
----+  "collapsible_depends_on": null,
----+  "columns": 0,
----+  "default": null,
----+  "depends_on": null,
----+  "description": null,
----+  "docstatus": 0,
----+  "doctype": "Custom Field",
----+  "dt": "Company",
----+  "fetch_from": null,
----+  "fetch_if_empty": 0,
----+  "fieldname": "bns_msme_no",
----+  "fieldtype": "Data",
----+  "hidden": 0,
----+  "hide_border": 0,
----+  "hide_days": 0,
----+  "hide_seconds": 0,
----+  "ignore_user_permissions": 0,
----+  "ignore_xss_filter": 0,
----+  "in_global_search": 0,
----+  "in_list_view": 0,
----+  "in_preview": 0,
----+  "in_standard_filter": 0,
----+  "insert_after": "bns_company_cin",
----+  "is_system_generated": 0,
----+  "is_virtual": 0,
----+  "label": "MSME No.",
----+  "length": 0,
----+  "link_filters": null,
----+  "mandatory_depends_on": null,
----+  "modified": "2026-01-11 21:30:46.253006",
----+  "module": "Business Needed Solutions",
----+  "name": "Company-custom_msme_no",
----+  "no_copy": 0,
----+  "non_negative": 0,
----+  "options": null,
----+  "permlevel": 0,
----+  "placeholder": null,
----+  "precision": "",
----+  "print_hide": 0,
----+  "print_hide_if_no_value": 0,
----+  "print_width": null,
----+  "read_only": 0,
----+  "read_only_depends_on": null,
----+  "report_hide": 0,
----+  "reqd": 0,
----+  "search_index": 0,
----+  "show_dashboard": 0,
----+  "sort_options": 0,
----+  "translatable": 1,
----+  "unique": 0,
----+  "width": null
----+ },
----+ {
----+  "allow_in_quick_entry": 0,
----+  "allow_on_submit": 0,
----+  "bold": 0,
----+  "collapsible": 0,
----+  "collapsible_depends_on": null,
----+  "columns": 0,
----+  "default": null,
----+  "depends_on": null,
----+  "description": null,
----+  "docstatus": 0,
----+  "doctype": "Custom Field",
----+  "dt": "Company",
----+  "fetch_from": null,
----+  "fetch_if_empty": 0,
----+  "fieldname": "bns_msme_type",
----+  "fieldtype": "Select",
----+  "hidden": 0,
----+  "hide_border": 0,
----+  "hide_days": 0,
----+  "hide_seconds": 0,
----+  "ignore_user_permissions": 0,
----+  "ignore_xss_filter": 0,
----+  "in_global_search": 0,
----+  "in_list_view": 0,
----+  "in_preview": 0,
----+  "in_standard_filter": 0,
----+  "insert_after": "bns_msme_no",
----+  "is_system_generated": 0,
----+  "is_virtual": 0,
----+  "label": "MSME Type",
----+  "length": 0,
----+  "link_filters": null,
----+  "mandatory_depends_on": null,
----+  "modified": "2026-01-11 21:30:50.211451",
----+  "module": "Business Needed Solutions",
----+  "name": "Company-custom_msme_type",
----+  "no_copy": 0,
----+  "non_negative": 0,
----+  "options": "\nMicro\nSmall\nMedium",
----+  "permlevel": 0,
----+  "placeholder": null,
----+  "precision": "",
----+  "print_hide": 0,
----+  "print_hide_if_no_value": 0,
----+  "print_width": null,
----+  "read_only": 0,
----+  "read_only_depends_on": null,
----+  "report_hide": 0,
----+  "reqd": 0,
----+  "search_index": 0,
----+  "show_dashboard": 0,
----+  "sort_options": 0,
----+  "translatable": 1,
----+  "unique": 0,
----+  "width": null
----+ },
----  {
----   "allow_in_quick_entry": 0,
----   "allow_on_submit": 0,
----@@ -410,12 +638,12 @@
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Quotation Item",
----+  "dt": "Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d1_",
-----  "fieldtype": "Percent",
-----  "hidden": 1,
----+  "fieldname": "custom_print_uom",
----+  "fieldtype": "Link",
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----@@ -425,22 +653,22 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "column_break_18",
----+  "insert_after": "uoms",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D1",
----+  "label": "Print UOM",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.484320",
----+  "modified": "2025-04-02 02:46:14.810317",
----   "module": "Business Needed Solutions",
-----  "name": "Quotation Item-custom_d1_",
----+  "name": "Item-custom_print_uom",
----   "no_copy": 0,
----   "non_negative": 0,
-----  "options": null,
----+  "options": "UOM",
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": null,
----+  "precision": "",
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----@@ -461,43 +689,43 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Quotation Item",
----+  "dt": "Sales Invoice Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d2_",
----+  "fieldname": "custom_d1_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "custom_d1_",
----+  "insert_after": "column_break_19",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D2",
----+  "label": "D1",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.484669",
----+  "modified": "2026-01-11 20:55:05.960361",
----   "module": "Business Needed Solutions",
-----  "name": "Quotation Item-custom_d2",
----+  "name": "Sales Invoice Item-custom_d1_",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": null,
----+  "precision": "",
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----@@ -518,17 +746,17 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Item",
----+  "dt": "Sales Invoice Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_print_uom",
-----  "fieldtype": "Link",
----+  "fieldname": "custom_d2_",
----+  "fieldtype": "Percent",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -536,22 +764,22 @@
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "uoms",
----+  "insert_after": "custom_d1_",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Print UOM",
----+  "label": "D2",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-04-02 02:46:14.810317",
----+  "modified": "2026-01-11 20:55:05.960665",
----   "module": "Business Needed Solutions",
-----  "name": "Item-custom_print_uom",
----+  "name": "Sales Invoice Item-custom_d2",
----   "no_copy": 0,
----   "non_negative": 0,
-----  "options": "UOM",
----+  "options": null,
----   "permlevel": 0,
----   "placeholder": null,
----   "precision": "",
----@@ -559,7 +787,7 @@
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----   "read_only": 0,
-----  "read_only_depends_on": null,
----+  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0;",
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----@@ -575,7 +803,7 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----@@ -584,28 +812,28 @@
----   "dt": "Quotation Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d3_",
----+  "fieldname": "custom_d1_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "custom_d2_",
----+  "insert_after": "column_break_18",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D3",
----+  "label": "D1",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.485011",
----+  "modified": "2026-01-11 20:55:06.306865",
----   "module": "Business Needed Solutions",
-----  "name": "Quotation Item-custom_d3",
----+  "name": "Quotation Item-custom_d1_",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -632,48 +860,48 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Delivery Note Item",
----+  "dt": "Sales Invoice Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d1_",
----+  "fieldname": "custom_d3_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "column_break_19",
----+  "insert_after": "custom_d2_",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D1",
----+  "label": "D3",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.392341",
----+  "modified": "2026-01-11 20:55:05.960924",
----   "module": "Business Needed Solutions",
-----  "name": "Delivery Note Item-custom_d1_",
----+  "name": "Sales Invoice Item-custom_d3",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": null,
----+  "precision": "",
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----   "read_only": 0,
-----  "read_only_depends_on": null,
----+  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0 || !doc.custom_d2_ || doc.custom_d2_ == 0;",
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----@@ -689,25 +917,25 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Delivery Note Item",
----+  "dt": "Quotation Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d2_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "custom_d1_",
----@@ -717,9 +945,9 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.392686",
----+  "modified": "2026-01-11 20:55:06.307214",
----   "module": "Business Needed Solutions",
-----  "name": "Delivery Note Item-custom_d2",
----+  "name": "Quotation Item-custom_d2",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -746,25 +974,25 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Invoice Item",
----+  "dt": "Delivery Note Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d1_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "column_break_19",
----@@ -774,15 +1002,15 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.137033",
----+  "modified": "2026-01-11 20:55:06.217487",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice Item-custom_d1_",
----+  "name": "Delivery Note Item-custom_d1_",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": "",
----+  "precision": null,
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----@@ -803,37 +1031,37 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Delivery Note Item",
----+  "dt": "Sales Order Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d3_",
----+  "fieldname": "custom_d1_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "custom_d2_",
----+  "insert_after": "column_break_19",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D3",
----+  "label": "D1",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.393016",
----+  "modified": "2026-01-11 20:55:06.089754",
----   "module": "Business Needed Solutions",
-----  "name": "Delivery Note Item-custom_d3",
----+  "name": "Sales Order Item-custom_d1_",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -860,37 +1088,37 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Order Item",
----+  "dt": "Quotation Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_d1_",
----+  "fieldname": "custom_d3_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "column_break_19",
----+  "insert_after": "custom_d2_",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "D1",
----+  "label": "D3",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.261215",
----+  "modified": "2026-01-11 20:55:06.307551",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Order Item-custom_d1_",
----+  "name": "Quotation Item-custom_d3",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -917,25 +1145,25 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Invoice Item",
----+  "dt": "Delivery Note Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d2_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "custom_d1_",
----@@ -945,20 +1173,20 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.137413",
----+  "modified": "2026-01-11 20:55:06.217833",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice Item-custom_d2",
----+  "name": "Delivery Note Item-custom_d2",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": "",
----+  "precision": null,
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----   "read_only": 0,
-----  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0;",
----+  "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----@@ -974,7 +1202,7 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----@@ -985,14 +1213,14 @@
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d2_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "custom_d1_",
----@@ -1002,7 +1230,7 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.261576",
----+  "modified": "2026-01-11 20:55:06.090111",
----   "module": "Business Needed Solutions",
----   "name": "Sales Order Item-custom_d2",
----   "no_copy": 0,
----@@ -1031,25 +1259,25 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Invoice Item",
----+  "dt": "Delivery Note Item",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d3_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "custom_d2_",
----@@ -1059,20 +1287,20 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.137744",
----+  "modified": "2026-01-11 20:55:06.218165",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice Item-custom_d3",
----+  "name": "Delivery Note Item-custom_d3",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
----   "placeholder": null,
-----  "precision": "",
----+  "precision": null,
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
----   "read_only": 0,
-----  "read_only_depends_on": "eval:!doc.custom_d1_ || doc.custom_d1_ == 0 || !doc.custom_d2_ || doc.custom_d2_ == 0;",
----+  "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----@@ -1088,7 +1316,7 @@
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
-----  "columns": 0,
----+  "columns": 1,
----   "default": null,
----   "depends_on": null,
----   "description": null,
----@@ -1099,14 +1327,14 @@
----   "fetch_if_empty": 0,
----   "fieldname": "custom_d3_",
----   "fieldtype": "Percent",
-----  "hidden": 1,
----+  "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----   "hide_seconds": 0,
----   "ignore_user_permissions": 0,
----   "ignore_xss_filter": 0,
----   "in_global_search": 0,
-----  "in_list_view": 0,
----+  "in_list_view": 1,
----   "in_preview": 0,
----   "in_standard_filter": 0,
----   "insert_after": "custom_d2_",
----@@ -1116,7 +1344,7 @@
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-09-22 15:32:50.261916",
----+  "modified": "2026-01-11 20:55:06.090439",
----   "module": "Business Needed Solutions",
----   "name": "Sales Order Item-custom_d3",
----   "no_copy": 0,
----@@ -1709,63 +1937,6 @@
----   "unique": 0,
----   "width": null
----  },
----- {
-----  "allow_in_quick_entry": 0,
-----  "allow_on_submit": 1,
-----  "bold": 0,
-----  "collapsible": 0,
-----  "collapsible_depends_on": null,
-----  "columns": 0,
-----  "default": "0",
-----  "depends_on": null,
-----  "description": null,
-----  "docstatus": 0,
-----  "doctype": "Custom Field",
-----  "dt": "Sales Invoice",
-----  "fetch_from": null,
-----  "fetch_if_empty": 0,
-----  "fieldname": "bns_show_item_barcode",
-----  "fieldtype": "Check",
-----  "hidden": 0,
-----  "hide_border": 0,
-----  "hide_days": 0,
-----  "hide_seconds": 0,
-----  "ignore_user_permissions": 0,
-----  "ignore_xss_filter": 0,
-----  "in_global_search": 0,
-----  "in_list_view": 0,
-----  "in_preview": 0,
-----  "in_standard_filter": 0,
-----  "insert_after": "bns_show_item_code",
-----  "is_system_generated": 0,
-----  "is_virtual": 0,
-----  "label": "Show Item Barcode",
-----  "length": 0,
-----  "link_filters": null,
-----  "mandatory_depends_on": null,
-----  "modified": "2025-09-22 02:59:24.552417",
-----  "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_show_item_barcode",
-----  "no_copy": 0,
-----  "non_negative": 0,
-----  "options": null,
-----  "permlevel": 0,
-----  "placeholder": "",
-----  "precision": "",
-----  "print_hide": 0,
-----  "print_hide_if_no_value": 0,
-----  "print_width": null,
-----  "read_only": 0,
-----  "read_only_depends_on": null,
-----  "report_hide": 0,
-----  "reqd": 0,
-----  "search_index": 0,
-----  "show_dashboard": 0,
-----  "sort_options": 0,
-----  "translatable": 0,
-----  "unique": 0,
-----  "width": null
----- },
----  {
----   "allow_in_quick_entry": 0,
----   "allow_on_submit": 1,
----@@ -1882,12 +2053,12 @@
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 0,
----+  "allow_on_submit": 1,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----   "columns": 0,
-----  "default": null,
----+  "default": "0",
----   "depends_on": null,
----   "description": null,
----   "docstatus": 0,
----@@ -1895,8 +2066,8 @@
----   "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_builty_no",
-----  "fieldtype": "Data",
----+  "fieldname": "bns_show_item_barcode",
----+  "fieldtype": "Check",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -1907,21 +2078,21 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "distance",
----+  "insert_after": "bns_show_item_code",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Builty No",
----+  "label": "Show Item Barcode",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-03-09 03:12:51.185637",
----+  "modified": "2025-09-22 02:59:24.552417",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_builty_no",
----+  "name": "Sales Invoice-custom_show_item_barcode",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----   "permlevel": 0,
-----  "placeholder": null,
----+  "placeholder": "",
----   "precision": "",
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----@@ -1933,13 +2104,13 @@
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 1,
----+  "translatable": 0,
----   "unique": 0,
----   "width": null
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 1,
----+  "allow_on_submit": 0,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----@@ -1949,11 +2120,11 @@
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Invoice",
----+  "dt": "Purchase Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_destination",
-----  "fieldtype": "Data",
----+  "fieldname": "is_bns_internal_supplier",
----+  "fieldtype": "Check",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -1964,16 +2135,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "custom_builty_no",
----+  "insert_after": "is_internal_supplier",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Destination",
----+  "label": "Is BNS Internal Supplier",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-03-09 03:12:29.557539",
----+  "modified": "2025-11-24 12:00:00",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_destination",
----+  "name": "Purchase Invoice-is_bns_internal_supplier",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -1983,20 +2154,20 @@
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
-----  "read_only": 0,
----+  "read_only": 1,
----   "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 1,
----+  "translatable": 0,
----   "unique": 0,
----   "width": null
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 1,
----+  "allow_on_submit": 0,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----@@ -2009,7 +2180,7 @@
----   "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_doc_no",
----+  "fieldname": "custom_builty_no",
----   "fieldtype": "Data",
----   "hidden": 0,
----   "hide_border": 0,
----@@ -2021,16 +2192,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "custom_destination",
----+  "insert_after": "distance",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Doc No",
----+  "label": "Builty No",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-03-09 03:12:23.951908",
----+  "modified": "2025-03-09 03:12:51.185637",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_doc_no",
----+  "name": "Sales Invoice-custom_builty_no",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2053,7 +2224,7 @@
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 1,
----+  "allow_on_submit": 0,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----@@ -2063,11 +2234,11 @@
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Sales Invoice",
----+  "dt": "Purchase Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "custom_terms_of_delivery",
-----  "fieldtype": "Text Editor",
----+  "fieldname": "bns_inter_company_reference",
----+  "fieldtype": "Data",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -2078,16 +2249,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "transporter_col_break",
----+  "insert_after": "is_bns_internal_supplier",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Terms of Delivery",
----+  "label": "BNS Inter Company Reference",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-03-09 03:12:58.632863",
----+  "modified": "2025-11-24 12:00:00",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_terms_of_delivery",
----+  "name": "Purchase Invoice-bns_inter_company_reference",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2097,14 +2268,14 @@
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
-----  "read_only": 0,
----+  "read_only": 1,
----   "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 1,
----+  "translatable": 0,
----   "unique": 0,
----   "width": null
----  },
----@@ -2123,8 +2294,8 @@
----   "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "is_bns_internal_check",
-----  "fieldtype": "Check",
----+  "fieldname": "custom_destination",
----+  "fieldtype": "Data",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -2135,16 +2306,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "is_internal_customer",
----+  "insert_after": "custom_builty_no",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Is BNS Internal Check",
----+  "label": "Destination",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-04-27 17:36:28.324931",
----+  "modified": "2025-03-09 03:12:29.557539",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-custom_internal_check_done",
----+  "name": "Sales Invoice-custom_destination",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2161,13 +2332,13 @@
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 0,
----+  "translatable": 1,
----   "unique": 0,
----   "width": null
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 0,
----+  "allow_on_submit": 1,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----@@ -2178,10 +2349,10 @@
----   "docstatus": 0,
----   "doctype": "Custom Field",
----   "dt": "Sales Invoice",
-----  "fetch_from": "customer.is_bns_internal_customer",
----+  "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "is_bns_internal_customer",
-----  "fieldtype": "Check",
----+  "fieldname": "custom_doc_no",
----+  "fieldtype": "Data",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -2192,16 +2363,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "represents_company",
----+  "insert_after": "custom_destination",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Is BNS Internal Customer",
----+  "label": "Doc No",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-11-24 12:00:00",
----+  "modified": "2025-03-09 03:12:23.951908",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-is_bns_internal_customer",
----+  "name": "Sales Invoice-custom_doc_no",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2211,20 +2382,20 @@
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
-----  "read_only": 1,
----+  "read_only": 0,
----   "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 0,
----+  "translatable": 1,
----   "unique": 0,
----   "width": null
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 0,
----+  "allow_on_submit": 1,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----@@ -2237,8 +2408,8 @@
----   "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "bns_inter_company_reference",
-----  "fieldtype": "Data",
----+  "fieldname": "custom_terms_of_delivery",
----+  "fieldtype": "Text Editor",
----   "hidden": 0,
----   "hide_border": 0,
----   "hide_days": 0,
----@@ -2249,16 +2420,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "is_bns_internal_customer",
----+  "insert_after": "transporter_col_break",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "BNS Inter Company Reference",
----+  "label": "Terms of Delivery",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-11-24 12:00:00",
----+  "modified": "2025-03-09 03:12:58.632863",
----   "module": "Business Needed Solutions",
-----  "name": "Sales Invoice-bns_inter_company_reference",
----+  "name": "Sales Invoice-custom_terms_of_delivery",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2268,14 +2439,14 @@
----   "print_hide": 0,
----   "print_hide_if_no_value": 0,
----   "print_width": null,
-----  "read_only": 1,
----+  "read_only": 0,
----   "read_only_depends_on": null,
----   "report_hide": 0,
----   "reqd": 0,
----   "search_index": 0,
----   "show_dashboard": 0,
----   "sort_options": 0,
-----  "translatable": 0,
----+  "translatable": 1,
----   "unique": 0,
----   "width": null
----  },
----@@ -2291,10 +2462,10 @@
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Purchase Invoice",
-----  "fetch_from": null,
----+  "dt": "Sales Invoice",
----+  "fetch_from": "customer.is_bns_internal_customer",
----   "fetch_if_empty": 0,
-----  "fieldname": "is_bns_internal_supplier",
----+  "fieldname": "is_bns_internal_customer",
----   "fieldtype": "Check",
----   "hidden": 0,
----   "hide_border": 0,
----@@ -2306,16 +2477,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "is_internal_supplier",
----+  "insert_after": "represents_company",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Is BNS Internal Supplier",
----+  "label": "Is BNS Internal Customer",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
----   "modified": "2025-11-24 12:00:00",
----   "module": "Business Needed Solutions",
-----  "name": "Purchase Invoice-is_bns_internal_supplier",
----+  "name": "Sales Invoice-is_bns_internal_customer",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2348,7 +2519,7 @@
----   "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Purchase Invoice",
----+  "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
----   "fieldname": "bns_inter_company_reference",
----@@ -2363,7 +2534,7 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "is_bns_internal_supplier",
----+  "insert_after": "is_bns_internal_customer",
----   "is_system_generated": 0,
----   "is_virtual": 0,
----   "label": "BNS Inter Company Reference",
----@@ -2372,7 +2543,7 @@
----   "mandatory_depends_on": null,
----   "modified": "2025-11-24 12:00:00",
----   "module": "Business Needed Solutions",
-----  "name": "Purchase Invoice-bns_inter_company_reference",
----+  "name": "Sales Invoice-bns_inter_company_reference",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----@@ -2395,20 +2566,20 @@
----  },
----  {
----   "allow_in_quick_entry": 0,
-----  "allow_on_submit": 0,
----+  "allow_on_submit": 1,
----   "bold": 0,
----   "collapsible": 0,
----   "collapsible_depends_on": null,
----   "columns": 0,
-----  "default": "0",
-----  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock') && frappe.db.get_single_value('BNS Settings', 'enable_per_warehouse_negative_stock_disallow')",
-----  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings. This feature must be enabled in BNS Settings first.",
----+  "default": null,
----+  "depends_on": null,
----+  "description": null,
----   "docstatus": 0,
----   "doctype": "Custom Field",
-----  "dt": "Warehouse",
----+  "dt": "Sales Invoice",
----   "fetch_from": null,
----   "fetch_if_empty": 0,
-----  "fieldname": "bns_disallow_negative_stock",
----+  "fieldname": "is_bns_internal_check",
----   "fieldtype": "Check",
----   "hidden": 0,
----   "hide_border": 0,
----@@ -2420,16 +2591,16 @@
----   "in_list_view": 0,
----   "in_preview": 0,
----   "in_standard_filter": 0,
-----  "insert_after": "is_rejected_warehouse",
----+  "insert_after": "is_internal_customer",
----   "is_system_generated": 0,
----   "is_virtual": 0,
-----  "label": "Disallow Negative Stock",
----+  "label": "Is BNS Internal Check",
----   "length": 0,
----   "link_filters": null,
----   "mandatory_depends_on": null,
-----  "modified": "2025-01-27 10:00:00.000000",
----+  "modified": "2025-04-27 17:36:28.324931",
----   "module": "Business Needed Solutions",
-----  "name": "Warehouse-bns_disallow_negative_stock",
----+  "name": "Sales Invoice-custom_internal_check_done",
----   "no_copy": 0,
----   "non_negative": 0,
----   "options": null,
----diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
----index a3e12af..387c36c 100644
------- a/business_needed_solutions/hooks.py
----+++ b/business_needed_solutions/hooks.py
----@@ -247,7 +247,8 @@ doc_events = {
---- fixtures = [
----             # {"doctype": "Client Script", "filters": [["module" , "in" , ("Business Needed Solutions" )]]},
----             # {"doctype": "Print Format", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
-----            {"doctype": "Custom Field", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True}
----+            {"doctype": "Custom Field", "filters": [["module" , "in" , ("Business Needed Solutions" )]],"overwrite": True},
----+            {"doctype":"Terms and Conditions", "filters": [["name" , "in" , ("General" )]],"overwrite": True}
----         ]
---- # fixtures = [{"doctype": "Report", "filters": [["module" , "in" , ("Business Needed Solutions" )]]}]
---- 
----diff --git a/diff.txt b/diff.txt
----index 251f972..f1ac2ce 100644
------- a/diff.txt
----+++ b/diff.txt
----@@ -1,881 +0,0 @@
-----diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-----index bd3ebbf..8c8e98a 100644
-------- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-----+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
-----@@ -37,9 +37,30 @@ def execute(filters=None):
----- 	company = filters.get("company") or frappe.defaults.get_global_default("company")
----- 	from_date, to_date = get_fiscal_year_dates(report_date, company)
----- 
------	# 1. Get columns & data for Receivable (main) and Payable (secondary).
-----+	# Prepare filters for secondary (Receivable) run - map Supplier filters to Customer filters
-----+	secondary_filters = frappe._dict(filters.copy())
-----+	secondary_filters.party_type = "Customer"
-----+	secondary_filters.party = []
-----+
-----+	if filters.get("party_type") == "Supplier" and filters.get("party"):
-----+		party_links = frappe.get_all(
-----+			"Party Link",
-----+			fields=["primary_party", "primary_role", "secondary_party", "secondary_role"],
-----+		)
-----+		mapped_customers = set()
-----+		for pl in party_links:
-----+			# Supplier (primary) -> Customer (secondary)
-----+			if pl.secondary_role == "Customer" and pl.primary_party in filters["party"]:
-----+				mapped_customers.add(pl.secondary_party)
-----+			# Customer (primary) -> Supplier (secondary) where supplier is selected
-----+			if pl.primary_role == "Customer" and pl.secondary_party in filters["party"]:
-----+				mapped_customers.add(pl.primary_party)
-----+
-----+		secondary_filters.party = list(mapped_customers)
-----+
-----+	# 1. Get columns & data for Payable (main) and Receivable (secondary).
----- 	main_columns, main_data = AccountsReceivablePayableSummary(filters).run(args)
------	secondary_columns, secondary_data = AccountsReceivablePayableSummary(filters).run(secondary_args)
-----+	secondary_columns, secondary_data = AccountsReceivablePayableSummary(secondary_filters).run(secondary_args)
----- 
----- 	# Add city column if add_supplier_cities is checked
----- 	supplier_cities = {}
-----@@ -118,11 +139,30 @@ def execute(filters=None):
----- 
----- 		skip_set.add(secondary)
----- 
------	# 5. Get currency fields for adjustments
------	currency_fields = []
------	for col in main_columns:
------		if col.get("fieldtype") == "Currency":
------			currency_fields.append(col["fieldname"])
-----+	# 5. Define numeric fields to net (non-ageing)
-----+	numeric_fields = [
-----+		"invoiced",
-----+		"paid",
-----+		"credit_note",
-----+		"outstanding",
-----+		"total_due",
-----+		"future_amount",
-----+		"opening",
-----+	]
-----+
-----+	if filters.get("show_gl_balance"):
-----+		numeric_fields.extend(["gl_balance", "diff"])
-----+
-----+	if filters.get("show_future_payments"):
-----+		numeric_fields.append("remaining_balance")
-----+
-----+	# Ageing buckets (range1, range2, ...) taken directly from columns
-----+	ageing_bucket_fields = [
-----+		col.get("fieldname")
-----+		for col in main_columns
-----+		if col.get("fieldname", "").startswith("range")
-----+	]
-----+	ageing_bucket_fields = [f for f in ageing_bucket_fields if f]
----- 
----- 	# 5a. Build mapping of supplier parties to their linked customer parties
----- 	# and get customer invoice/paid amounts for those customers
-----@@ -198,13 +238,18 @@ def execute(filters=None):
----- 			# Make a copy so we don't overwrite main_dict
----- 			updated_row = row.copy()
----- 			
------			# Subtract AR amounts from AP amounts for all currency fields
----- 			sec_row = secondary_dict[party]
----- 			updated_row["secondary_party_type"] = sec_row["party_type"]
----- 			updated_row["secondary_party"] = sec_row["party"]
----- 			updated_row["is_common_party"] = True
----- 			
------			for fieldname in currency_fields:
-----+			for fieldname in numeric_fields:
-----+				updated_row[fieldname] = (
-----+					flt(updated_row.get(fieldname, 0.0)) 
-----+					- flt(sec_row.get(fieldname, 0.0))
-----+				)
-----+
-----+			for fieldname in ageing_bucket_fields:
----- 				updated_row[fieldname] = (
----- 					flt(updated_row.get(fieldname, 0.0)) 
----- 					- flt(sec_row.get(fieldname, 0.0))
-----@@ -241,8 +286,14 @@ def execute(filters=None):
----- 							primary_row = secondary_dict[primary_party_for_secondary]
----- 							updated_row["secondary_party_type"] = primary_row["party_type"]
----- 							updated_row["secondary_party"] = primary_party_for_secondary
------							# Net AP - AR for all currency fields
------							for fieldname in currency_fields:
-----+							# Net AP - AR for defined numeric fields
-----+							for fieldname in numeric_fields:
-----+								updated_row[fieldname] = (
-----+									flt(updated_row.get(fieldname, 0.0)) 
-----+									- flt(primary_row.get(fieldname, 0.0))
-----+								)
-----+
-----+							for fieldname in ageing_bucket_fields:
----- 								updated_row[fieldname] = (
----- 									flt(updated_row.get(fieldname, 0.0)) 
----- 									- flt(primary_row.get(fieldname, 0.0))
-----@@ -260,7 +311,13 @@ def execute(filters=None):
----- 						sec_row = secondary_dict[secondary_party]
----- 						updated_row["secondary_party_type"] = sec_row["party_type"]
----- 						updated_row["secondary_party"] = sec_row["party"]
------						for fieldname in currency_fields:
-----+						for fieldname in numeric_fields:
-----+							updated_row[fieldname] = (
-----+								flt(updated_row.get(fieldname, 0.0)) 
-----+								- flt(sec_row.get(fieldname, 0.0))
-----+							)
-----+
-----+						for fieldname in ageing_bucket_fields:
----- 							updated_row[fieldname] = (
----- 								flt(updated_row.get(fieldname, 0.0)) 
----- 								- flt(sec_row.get(fieldname, 0.0))
-----diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-----index 0e99ed2..c742383 100644
-------- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-----+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
-----@@ -181,9 +181,30 @@ def execute(filters=None):
----- 		if not customers:
----- 			return [], []
----- 
-----+	# Prepare filters for secondary (Payable) run - map Customer filters to Supplier filters
-----+	secondary_filters = frappe._dict(filters.copy())
-----+	secondary_filters.party_type = "Supplier"
-----+	secondary_filters.party = []
-----+
-----+	if filters.get("party_type") == "Customer" and filters.get("party"):
-----+		party_links = frappe.get_all(
-----+			"Party Link",
-----+			fields=["primary_party", "primary_role", "secondary_party", "secondary_role"],
-----+		)
-----+		mapped_suppliers = set()
-----+		for pl in party_links:
-----+			# Customer (primary) -> Supplier (secondary)
-----+			if pl.secondary_role == "Supplier" and pl.primary_party in filters["party"]:
-----+				mapped_suppliers.add(pl.secondary_party)
-----+			# Supplier (primary) -> Customer (secondary) where the customer is selected
-----+			if pl.primary_role == "Supplier" and pl.secondary_party in filters["party"]:
-----+				mapped_suppliers.add(pl.primary_party)
-----+
-----+		secondary_filters.party = list(mapped_suppliers)
-----+
----- 	# 1. Get columns & data for Receivable (main) and Payable (secondary).
----- 	main_columns, main_data = AccountsReceivablePayableSummary(filters).run(args)
------	secondary_columns, secondary_data = AccountsReceivablePayableSummary(filters).run(secondary_args)
-----+	secondary_columns, secondary_data = AccountsReceivablePayableSummary(secondary_filters).run(secondary_args)
----- 
----- 	# Filter main_data based on customers if sales person filter is applied
----- 	if customers:
-----@@ -263,11 +284,30 @@ def execute(filters=None):
----- 
----- 		skip_set.add(secondary)
----- 
------	# 5. Get currency fields for adjustments
------	currency_fields = []
------	for col in main_columns:
------		if col.get("fieldtype") == "Currency":
------			currency_fields.append(col["fieldname"])
-----+	# 5. Define numeric fields to net (non-ageing)
-----+	numeric_fields = [
-----+		"invoiced",
-----+		"paid",
-----+		"credit_note",
-----+		"outstanding",
-----+		"total_due",
-----+		"future_amount",
-----+		"opening",
-----+	]
-----+
-----+	if filters.get("show_gl_balance"):
-----+		numeric_fields.extend(["gl_balance", "diff"])
-----+
-----+	if filters.get("show_future_payments"):
-----+		numeric_fields.append("remaining_balance")
-----+
-----+	# Ageing buckets (range1, range2, ...) taken directly from columns
-----+	ageing_bucket_fields = [
-----+		col.get("fieldname")
-----+		for col in main_columns
-----+		if col.get("fieldname", "").startswith("range")
-----+	]
-----+	ageing_bucket_fields = [f for f in ageing_bucket_fields if f]
----- 
----- 	# 5a. Build mapping of customer parties to their linked supplier parties
----- 	# and get supplier invoice/received amounts for those suppliers
-----@@ -343,13 +383,18 @@ def execute(filters=None):
----- 			# Make a copy so we don't overwrite main_dict
----- 			updated_row = row.copy()
----- 			
------			# Subtract AP amounts from AR amounts for all currency fields
----- 			sec_row = secondary_dict[party]
----- 			updated_row["secondary_party_type"] = sec_row["party_type"]
----- 			updated_row["secondary_party"] = sec_row["party"]
----- 			updated_row["is_common_party"] = True
----- 			
------			for fieldname in currency_fields:
-----+			for fieldname in numeric_fields:
-----+				updated_row[fieldname] = (
-----+					flt(updated_row.get(fieldname, 0.0)) 
-----+					- flt(sec_row.get(fieldname, 0.0))
-----+				)
-----+
-----+			for fieldname in ageing_bucket_fields:
----- 				updated_row[fieldname] = (
----- 					flt(updated_row.get(fieldname, 0.0)) 
----- 					- flt(sec_row.get(fieldname, 0.0))
-----@@ -386,8 +431,14 @@ def execute(filters=None):
----- 							primary_row = secondary_dict[primary_party_for_secondary]
----- 							updated_row["secondary_party_type"] = primary_row["party_type"]
----- 							updated_row["secondary_party"] = primary_party_for_secondary
------							# Net AR - AP for all currency fields
------							for fieldname in currency_fields:
-----+							# Net AR - AP for defined numeric fields
-----+							for fieldname in numeric_fields:
-----+								updated_row[fieldname] = (
-----+									flt(updated_row.get(fieldname, 0.0)) 
-----+									- flt(primary_row.get(fieldname, 0.0))
-----+								)
-----+
-----+							for fieldname in ageing_bucket_fields:
----- 								updated_row[fieldname] = (
----- 									flt(updated_row.get(fieldname, 0.0)) 
----- 									- flt(primary_row.get(fieldname, 0.0))
-----@@ -405,7 +456,13 @@ def execute(filters=None):
----- 						sec_row = secondary_dict[secondary_party]
----- 						updated_row["secondary_party_type"] = sec_row["party_type"]
----- 						updated_row["secondary_party"] = sec_row["party"]
------						for fieldname in currency_fields:
-----+						for fieldname in numeric_fields:
-----+							updated_row[fieldname] = (
-----+								flt(updated_row.get(fieldname, 0.0)) 
-----+								- flt(sec_row.get(fieldname, 0.0))
-----+							)
-----+
-----+						for fieldname in ageing_bucket_fields:
----- 							updated_row[fieldname] = (
----- 								flt(updated_row.get(fieldname, 0.0)) 
----- 								- flt(sec_row.get(fieldname, 0.0))
-----diff --git a/diff.txt b/diff.txt
-----index 0a5da47..104aa99 100644
-------- a/diff.txt
-----+++ b/diff.txt
-----@@ -1,625 +0,0 @@
------diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
------index b406f96..bd3ebbf 100644
--------- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
------+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_payable_summary/pure_accounts_payable_summary.py
------@@ -6,7 +6,8 @@ from frappe import _, scrub
------ from urllib.parse import quote
------ from frappe.utils import cint, flt
------ from business_needed_solutions.business_needed_solutions.report.pure_accounts_receivable_summary.pure_accounts_receivable_summary import (
-------	AccountsReceivablePayableSummary,get_fiscal_year_dates
------+	AccountsReceivablePayableSummary, get_fiscal_year_dates, 
------+	get_supplier_invoice_and_received_amounts, get_customer_invoice_and_paid_amounts
------ )
------ 
------ 
------@@ -123,6 +124,55 @@ def execute(filters=None):
------ 		if col.get("fieldtype") == "Currency":
------ 			currency_fields.append(col["fieldname"])
------ 
------+	# 5a. Build mapping of supplier parties to their linked customer parties
------+	# and get customer invoice/paid amounts for those customers
------+	supplier_to_customer_map = {}
------+	customer_parties_to_query = set()
------+	
------+	for pl in party_links:
------+		# If secondary_role is Customer, then primary_party (Supplier) is linked to a customer
------+		if pl.secondary_role == "Customer":
------+			supplier_to_customer_map[pl.primary_party] = pl.secondary_party
------+			customer_parties_to_query.add(pl.secondary_party)
------+		# If primary_role is Customer, then secondary_party (Supplier) is linked to a customer
------+		if pl.primary_role == "Customer":
------+			supplier_to_customer_map[pl.secondary_party] = pl.primary_party
------+			customer_parties_to_query.add(pl.primary_party)
------+	
------+	# Also include common parties - they are both supplier and customer
------+	for party in common_parties:
------+		supplier_to_customer_map[party] = party
------+		customer_parties_to_query.add(party)
------+	
------+	# Get customer amounts keyed by customer party
------+	customer_amounts_by_customer = {}
------+	if customer_parties_to_query:
------+		customer_amounts_by_customer = get_customer_invoice_and_paid_amounts(
------+			list(customer_parties_to_query),
------+			company,
------+			report_date,
------+			filters.get("show_future_payments", 0),
------+			filters.get("from_date")
------+		)
------+	
------+	# Map customer amounts back to supplier parties
------+	customer_amounts = {}
------+	for supplier_party, customer_party in supplier_to_customer_map.items():
------+		if customer_party in customer_amounts_by_customer:
------+			customer_amounts[supplier_party] = customer_amounts_by_customer[customer_party]
------+	
------+	# 5b. Get supplier invoice and received amounts for all supplier parties
------+	supplier_parties_to_query = list(main_dict.keys())
------+	supplier_amounts = {}
------+	if supplier_parties_to_query:
------+		supplier_amounts = get_supplier_invoice_and_received_amounts(
------+			supplier_parties_to_query,
------+			company,
------+			report_date,
------+			filters.get("show_future_payments", 0),
------+			filters.get("from_date")
------+		)
------+
------ 	# 6. Build the final data with new logic:
------ 	#    - For common parties: categorize by net balance (debit -> Receivable, credit -> Payable)
------ 	#    - For Party Links: still apply netting but respect net balance categorization
------@@ -223,10 +273,27 @@ def execute(filters=None):
------ 				updated_row["city"] = supplier_cities.get(party, updated_row.get("city", ""))
------ 			
------ 			party_name = updated_row.get("party_name") or party
-------			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account=undefined&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
------+			
------+			# Get Payable accounts to filter Party GL by account_type
------+			payable_accounts = frappe.get_all(
------+				"Account",
------+				filters={"account_type": "Payable", "company": company},
------+				pluck="name"
------+			)
------+			account_filter = quote(",".join(payable_accounts)) if payable_accounts else "undefined"
------+			
------+			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account={account_filter}&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
------ 			button_html = f'<a href="{gl_url}" target="_blank" class="btn btn-xs btn-default">GL: {party_name}</a>'
------ 
------ 			updated_row["party_gl_link"] = button_html
------+			
------+			# Add the 2 new columns:
------+			# 1. Received Invoice Amount (Supplier's received invoice including debit note)
------+			updated_row["received_invoice_amount"] = flt(supplier_amounts.get(party, {}).get("received_invoice_amount", 0.0))
------+			
------+			# 2. Invoiced Amount (if party linked to customer, then customer's invoiced amount incl credit note)
------+			updated_row["invoiced_amount"] = flt(customer_amounts.get(party, {}).get("invoiced_amount", 0.0))
------+			
------ 			final_data.append(updated_row)
------ 
------ 	main_columns.append(
------@@ -254,6 +321,43 @@ def execute(filters=None):
------ 			"width": 120,
------ 		}
------ 	)
------+	
------+	# Find the index of "Opening Balance" column and insert the 2 new columns after it
------+	opening_balance_index = None
------+	for i, col in enumerate(main_columns):
------+		if col.get("fieldname") == "opening":
------+			opening_balance_index = i
------+			break
------+	
------+	# Add the 2 new columns right after Opening Balance
------+	if opening_balance_index is not None:
------+		insert_index = opening_balance_index + 1
------+		main_columns.insert(insert_index, {
------+			"label": _("Received Invoice Amount"),
------+			"fieldname": "received_invoice_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+		main_columns.insert(insert_index + 1, {
------+			"label": _("Invoiced Amount"),
------+			"fieldname": "invoiced_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+	else:
------+		# Fallback: add at the end if opening balance not found
------+		main_columns.append({
------+			"label": _("Received Invoice Amount"),
------+			"fieldname": "received_invoice_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+		main_columns.append({
------+			"label": _("Invoiced Amount"),
------+			"fieldname": "invoiced_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------ 
------ 	# 6. You can return the same columns from the main dataset
------ 	#    (they now reflect the differences).
------diff --git a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
------index 5e8f3a3..0e99ed2 100644
--------- a/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
------+++ b/business_needed_solutions/business_needed_solutions/report/pure_accounts_receivable_summary/pure_accounts_receivable_summary.py
------@@ -44,6 +44,118 @@ def get_fiscal_year_dates(report_date, company):
------ 	return "2023-04-01", "2024-03-31"
------ 
------ 
------+def get_supplier_invoice_and_received_amounts(parties, company, report_date, show_future_payments=0, from_date=None):
------+	"""
------+	Get supplier invoice amounts (including debit notes) for parties that are linked to suppliers.
------+	Uses Purchase Invoice directly like Purchase Register does.
------+	Returns dict: {party: {"received_invoice_amount": x}}
------+	"""
------+	from frappe.query_builder.functions import Sum, Abs
------+	
------+	result = {}
------+	if not parties:
------+		return result
------+	
------+	# Get payable account types
------+	payable_accounts = frappe.get_all(
------+		"Account",
------+		filters={"account_type": "Payable", "company": company},
------+		pluck="name"
------+	)
------+	
------+	if not payable_accounts:
------+		return result
------+	
------+	# Query Purchase Invoices directly (like Purchase Register does)
------+	pi = frappe.qb.DocType("Purchase Invoice")
------+	
------+	# Build query for supplier invoices (Purchase Invoices) including debit notes
------+	# Sum absolute values of base_grand_total to get total invoice amount including debit notes
------+	supplier_invoices_query = (
------+		frappe.qb.from_(pi)
------+		.select(pi.supplier, Sum(Abs(pi.base_grand_total)).as_("amount"))
------+		.where(
------+			(pi.supplier.isin(parties))
------+			& (pi.docstatus == 1)
------+			& (pi.credit_to.isin(payable_accounts))
------+			& (pi.posting_date <= report_date)
------+		)
------+	)
------+	
------+	# Add from_date filter if provided
------+	if from_date:
------+		supplier_invoices_query = supplier_invoices_query.where(pi.posting_date >= from_date)
------+	
------+	supplier_invoices_query = supplier_invoices_query.groupby(pi.supplier)
------+	
------+	invoice_data = supplier_invoices_query.run(as_dict=True)
------+	
------+	# Combine invoice amounts
------+	for row in invoice_data:
------+		party = row["supplier"]
------+		if party not in result:
------+			result[party] = {"received_invoice_amount": 0.0}
------+		result[party]["received_invoice_amount"] = flt(row["amount"])
------+	
------+	return result
------+
------+
------+def get_customer_invoice_and_paid_amounts(parties, company, report_date, show_future_payments=0, from_date=None):
------+	"""
------+	Get customer invoice amounts (Sales Invoices including Credit Notes) for customer parties.
------+	Uses Sales Invoice directly like Sales Register does.
------+	Returns dict: {party: {"invoiced_amount": x}}
------+	"""
------+	from frappe.query_builder.functions import Sum, Abs
------+	
------+	result = {}
------+	if not parties:
------+		return result
------+	
------+	# Get receivable account types
------+	receivable_accounts = frappe.get_all(
------+		"Account",
------+		filters={"account_type": "Receivable", "company": company},
------+		pluck="name"
------+	)
------+	
------+	if not receivable_accounts:
------+		return result
------+	
------+	# Query Sales Invoices directly (like Sales Register does)
------+	si = frappe.qb.DocType("Sales Invoice")
------+	
------+	# Build query for customer invoices (Sales Invoices) including credit notes
------+	# Sum absolute values of base_grand_total to get total invoice amount including credit notes
------+	customer_invoices_query = (
------+		frappe.qb.from_(si)
------+		.select(si.customer, Sum(Abs(si.base_grand_total)).as_("amount"))
------+		.where(
------+			(si.customer.isin(parties))
------+			& (si.docstatus == 1)
------+			& (si.debit_to.isin(receivable_accounts))
------+			& (si.posting_date <= report_date)
------+		)
------+	)
------+	
------+	# Add from_date filter if provided
------+	if from_date:
------+		customer_invoices_query = customer_invoices_query.where(si.posting_date >= from_date)
------+	
------+	customer_invoices_query = customer_invoices_query.groupby(si.customer)
------+	
------+	invoice_data = customer_invoices_query.run(as_dict=True)
------+	
------+	# Combine invoice amounts
------+	for row in invoice_data:
------+		party = row["customer"]
------+		if party not in result:
------+			result[party] = {"invoiced_amount": 0.0}
------+		result[party]["invoiced_amount"] = flt(row["amount"])
------+	
------+	return result
------+
------+
------ 
------ 
------ 
------@@ -157,6 +269,55 @@ def execute(filters=None):
------ 		if col.get("fieldtype") == "Currency":
------ 			currency_fields.append(col["fieldname"])
------ 
------+	# 5a. Build mapping of customer parties to their linked supplier parties
------+	# and get supplier invoice/received amounts for those suppliers
------+	customer_to_supplier_map = {}
------+	supplier_parties_to_query = set()
------+	
------+	for pl in party_links:
------+		# If secondary_role is Supplier, then primary_party (Customer) is linked to a supplier
------+		if pl.secondary_role == "Supplier":
------+			customer_to_supplier_map[pl.primary_party] = pl.secondary_party
------+			supplier_parties_to_query.add(pl.secondary_party)
------+		# If primary_role is Supplier, then secondary_party (Customer) is linked to a supplier
------+		if pl.primary_role == "Supplier":
------+			customer_to_supplier_map[pl.secondary_party] = pl.primary_party
------+			supplier_parties_to_query.add(pl.primary_party)
------+	
------+	# Also include common parties - they are both customer and supplier
------+	for party in common_parties:
------+		customer_to_supplier_map[party] = party
------+		supplier_parties_to_query.add(party)
------+	
------+	# Get supplier amounts keyed by supplier party
------+	supplier_amounts_by_supplier = {}
------+	if supplier_parties_to_query:
------+		supplier_amounts_by_supplier = get_supplier_invoice_and_received_amounts(
------+			list(supplier_parties_to_query),
------+			company,
------+			report_date,
------+			filters.get("show_future_payments", 0),
------+			filters.get("from_date")
------+		)
------+	
------+	# Map supplier amounts back to customer parties
------+	supplier_amounts = {}
------+	for customer_party, supplier_party in customer_to_supplier_map.items():
------+		if supplier_party in supplier_amounts_by_supplier:
------+			supplier_amounts[customer_party] = supplier_amounts_by_supplier[supplier_party]
------+	
------+	# 5b. Get customer invoice and paid amounts for all customer parties
------+	customer_parties_to_query = list(main_dict.keys())
------+	customer_amounts = {}
------+	if customer_parties_to_query:
------+		customer_amounts = get_customer_invoice_and_paid_amounts(
------+			customer_parties_to_query,
------+			company,
------+			report_date,
------+			filters.get("show_future_payments", 0),
------+			filters.get("from_date")
------+		)
------+
------ 	# 6. Build the final data with new logic:
------ 	#    - For common parties: categorize by net balance (debit -> Receivable, credit -> Payable)
------ 	#    - For Party Links: still apply netting but respect net balance categorization
------@@ -253,10 +414,27 @@ def execute(filters=None):
------ 		# Only add if outstanding is positive after adjustments
------ 		if flt(updated_row.get("outstanding", 0.0)) > 0:
------ 			party_name = updated_row.get("party_name") or party
-------			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account=undefined&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
------+			
------+			# Get Receivable accounts to filter Party GL by account_type
------+			receivable_accounts = frappe.get_all(
------+				"Account",
------+				filters={"account_type": "Receivable", "company": company},
------+				pluck="name"
------+			)
------+			account_filter = quote(",".join(receivable_accounts)) if receivable_accounts else "undefined"
------+			
------+			gl_url = f"/app/query-report/Party%20GL?company={quote(company)}&from_date={quote(str(from_date))}&to_date={quote(str(to_date))}&account={account_filter}&party=%5B%22{quote(party)}%22%5D&party_name={quote(party_name)}&group_by=Group+by+Voucher+%28Consolidated%29&project=undefined&include_dimensions=1&include_default_book_entries=1"
------ 			button_html = f'<a href="{gl_url}" target="_blank" class="btn btn-xs btn-default">GL: {party_name}</a>'
------ 
------ 			updated_row["party_gl_link"] = button_html
------+			
------+			# Add the 2 new columns:
------+			# 1. Received Invoice Amount (if party linked to supplier, then supplier's received invoice including debit note)
------+			updated_row["received_invoice_amount"] = flt(supplier_amounts.get(party, {}).get("received_invoice_amount", 0.0))
------+			
------+			# 2. Invoiced Amount (Invoices we sent to customer incl credit note)
------+			updated_row["invoiced_amount"] = flt(customer_amounts.get(party, {}).get("invoiced_amount", 0.0))
------+			
------ 			final_data.append(updated_row)
------ 
------ 	main_columns.append(
------@@ -285,6 +463,44 @@ def execute(filters=None):
------ 			"width": 120,
------ 		}
------ 	)
------+	
------+	# Find the index of "Opening Balance" column and insert the 2 new columns after it
------+	opening_balance_index = None
------+	for i, col in enumerate(main_columns):
------+		if col.get("fieldname") == "opening":
------+			opening_balance_index = i
------+			break
------+	
------+	# Add the 2 new columns right after Opening Balance
------+	if opening_balance_index is not None:
------+		insert_index = opening_balance_index + 1
------+		main_columns.insert(insert_index, {
------+			"label": _("Received Invoice Amount"),
------+			"fieldname": "received_invoice_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+		main_columns.insert(insert_index + 1, {
------+			"label": _("Invoiced Amount"),
------+			"fieldname": "invoiced_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+	else:
------+		# Fallback: add at the end if opening balance not found
------+		main_columns.append({
------+			"label": _("Received Invoice Amount"),
------+			"fieldname": "received_invoice_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+		main_columns.append({
------+			"label": _("Invoiced Amount"),
------+			"fieldname": "invoiced_amount",
------+			"fieldtype": "Currency",
------+			"width": 150,
------+		})
------+	
------ 	# 6. You can return the same columns from the main dataset
------ 	#    (they now reflect the differences).
------ 	#    No extra "r_minus_p" column is needed since you replaced
------@@ -308,26 +524,12 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
------ 
------ 		self.get_party_total(args)
------ 
-------		party = None
-------		for party_type in self.party_type:
-------			if self.filters.get(scrub(party_type)):
-------				party = self.filters.get(scrub(party_type))
-------
-------		party_advance_amount = (
-------			get_partywise_advanced_payment_amount(
-------				self.party_type,
-------				self.filters.report_date,
-------				self.filters.show_future_payments,
-------				self.filters.company,
-------				party=party,
-------			)
-------			or {}
-------		)
-------
------ 		if self.filters.show_gl_balance:
-------			gl_balance_map = get_gl_balance(self.filters.report_date, self.filters.company)
------+			gl_balance_map = get_gl_balance(self.filters.report_date, self.filters.company, self.account_type)
------ 
------ 		# Calculate opening balances
------+		# For Receivable (Asset): debit - credit (positive = customer owes us)
------+		# For Payable (Liability): credit - debit (positive = we owe supplier)
------ 		opening_balances = {}
------ 		if self.filters.get("from_date"):
------ 			for party_type in self.party_type:
------@@ -339,8 +541,16 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
------ 				if not accounts:
------ 					continue
------ 
-------				opening_entries = frappe.db.sql("""
-------					SELECT party, SUM(debit) - SUM(credit) as balance
------+				# Use different formula based on account type
------+				if self.account_type == "Payable":
------+					# For Payable: credit - debit (positive means we owe)
------+					balance_formula = "SUM(credit) - SUM(debit)"
------+				else:
------+					# For Receivable: debit - credit (positive means customer owes)
------+					balance_formula = "SUM(debit) - SUM(credit)"
------+
------+				opening_entries = frappe.db.sql(f"""
------+					SELECT party, {balance_formula} as balance
------ 					FROM `tabGL Entry`
------ 					WHERE posting_date < %s
------ 					AND party_type = %s
------@@ -384,13 +594,6 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
------ 			# Add opening balance
------ 			row.opening = opening_balances.get(party, 0.0)
------ 
-------			# Advance against party
-------			row.advance = party_advance_amount.get(party, 0)
-------			row.purepaid = row.paid
-------			# In AR/AP, advance shown in paid columns,
-------			# but in summary report advance shown in separate column
-------			row.paid -= row.advance
-------
------ 			if self.filters.show_gl_balance:
------ 				row.gl_balance = gl_balance_map.get(party)
------ 				row.diff = flt(row.outstanding) - flt(row.gl_balance)
------@@ -469,8 +672,6 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
------ 				fieldtype="Data",
------ 			)
------ 			self.add_column(_("Opening Balance"), fieldname="opening")
-------			self.add_column(_("Invoiced Amount"), fieldname="invoiced")
-------			self.add_column(_("Paid Amount"), fieldname="purepaid")
------ 			self.add_column(_("Outstanding Amount"), fieldname="outstanding")
------ 
------ 		if self.filters.show_gl_balance:
------@@ -507,13 +708,38 @@ class AccountsReceivablePayableSummary(ReceivablePayableReport):
------ 			)
------ 
------ 
-------def get_gl_balance(report_date, company):
-------	return frappe._dict(
-------		frappe.db.get_all(
-------			"GL Entry",
-------			fields=["party", "sum(debit -  credit)"],
-------			filters={"posting_date": ("<=", report_date), "is_cancelled": 0, "company": company},
-------			group_by="party",
-------			as_list=1,
-------		)
-------	)
------\ No newline at end of file
------+def get_gl_balance(report_date, company, account_type):
------+	"""
------+	Get GL balance for parties filtered by account_type.
------+	For Receivable (Asset): debit - credit (positive = customer owes us)
------+	For Payable (Liability): credit - debit (positive = we owe supplier)
------+	"""
------+	# Get accounts of the specified account_type
------+	accounts = frappe.get_all(
------+		"Account",
------+		filters={"account_type": account_type, "company": company},
------+		pluck="name"
------+	)
------+	
------+	if not accounts:
------+		return frappe._dict()
------+	
------+	# Use different formula based on account type
------+	if account_type == "Payable":
------+		# For Payable: credit - debit (positive means we owe)
------+		balance_formula = "SUM(credit) - SUM(debit)"
------+	else:
------+		# For Receivable: debit - credit (positive means customer owes)
------+		balance_formula = "SUM(debit) - SUM(credit)"
------+	
------+	balance_data = frappe.db.sql(f"""
------+		SELECT party, {balance_formula} as balance
------+		FROM `tabGL Entry`
------+		WHERE posting_date <= %s
------+		AND account IN %s
------+		AND company = %s
------+		AND is_cancelled = 0
------+		GROUP BY party
------+	""", (report_date, tuple(accounts), company), as_dict=1)
------+	
------+	return frappe._dict([(d.party, d.balance) for d in balance_data if d.party])
------\ No newline at end of file
------diff --git a/diff.txt b/diff.txt
------index 075d3d6..3ddfe0d 100644
--------- a/diff.txt
------+++ b/diff.txt
------@@ -1,101 +0,0 @@
-------diff --git a/business_needed_solutions/fixtures/custom_field.json b/business_needed_solutions/fixtures/custom_field.json
-------index 9534667..8ca7ab3 100644
---------- a/business_needed_solutions/fixtures/custom_field.json
-------+++ b/business_needed_solutions/fixtures/custom_field.json
-------@@ -2392,5 +2392,62 @@
-------   "translatable": 0,
-------   "unique": 0,
-------   "width": null
-------+ },
-------+ {
-------+  "allow_in_quick_entry": 0,
-------+  "allow_on_submit": 0,
-------+  "bold": 0,
-------+  "collapsible": 0,
-------+  "collapsible_depends_on": null,
-------+  "columns": 0,
-------+  "default": "0",
-------+  "depends_on": "eval:frappe.db.get_single_value('Stock Settings', 'allow_negative_stock')",
-------+  "description": "When enabled, negative stock will not be allowed for this warehouse even if 'Allow Negative Stock' is enabled in Stock Settings.",
-------+  "docstatus": 0,
-------+  "doctype": "Custom Field",
-------+  "dt": "Warehouse",
-------+  "fetch_from": null,
-------+  "fetch_if_empty": 0,
-------+  "fieldname": "bns_disallow_negative_stock",
-------+  "fieldtype": "Check",
-------+  "hidden": 0,
-------+  "hide_border": 0,
-------+  "hide_days": 0,
-------+  "hide_seconds": 0,
-------+  "ignore_user_permissions": 0,
-------+  "ignore_xss_filter": 0,
-------+  "in_global_search": 0,
-------+  "in_list_view": 0,
-------+  "in_preview": 0,
-------+  "in_standard_filter": 0,
-------+  "insert_after": "is_rejected_warehouse",
-------+  "is_system_generated": 0,
-------+  "is_virtual": 0,
-------+  "label": "Disallow Negative Stock",
-------+  "length": 0,
-------+  "link_filters": null,
-------+  "mandatory_depends_on": null,
-------+  "modified": "2025-01-27 10:00:00.000000",
-------+  "module": "Business Needed Solutions",
-------+  "name": "Warehouse-bns_disallow_negative_stock",
-------+  "no_copy": 0,
-------+  "non_negative": 0,
-------+  "options": null,
-------+  "permlevel": 0,
-------+  "placeholder": null,
-------+  "precision": "",
-------+  "print_hide": 0,
-------+  "print_hide_if_no_value": 0,
-------+  "print_width": null,
-------+  "read_only": 0,
-------+  "read_only_depends_on": null,
-------+  "report_hide": 0,
-------+  "reqd": 0,
-------+  "search_index": 0,
-------+  "show_dashboard": 0,
-------+  "sort_options": 0,
-------+  "translatable": 0,
-------+  "unique": 0,
-------+  "width": null
-------  }
------- ]
-------\ No newline at end of file
-------diff --git a/business_needed_solutions/hooks.py b/business_needed_solutions/hooks.py
-------index 3827d72..a3e12af 100644
---------- a/business_needed_solutions/hooks.py
-------+++ b/business_needed_solutions/hooks.py
-------@@ -63,7 +63,10 @@ doctype_js = {
-------               # Purchase Documents
-------               "Purchase Invoice" : "public/js/doctype_item_grid_controls.js",
-------               "Purchase Order" : "public/js/doctype_item_grid_controls.js",
--------              "Purchase Receipt" : ["public/js/purchase_receipt_form.js", "public/js/doctype_item_grid_controls.js"]
-------+              "Purchase Receipt" : ["public/js/purchase_receipt_form.js", "public/js/doctype_item_grid_controls.js"],
-------+              
-------+              # Warehouse
-------+              "Warehouse" : "public/js/warehouse.js"
------- }
------- 
------- 
-------@@ -184,6 +187,9 @@ doc_events = {
-------     "Item": {
-------         "validate": "business_needed_solutions.business_needed_solutions.overrides.item_validation.validate_expense_account_for_non_stock_items"
-------     },
-------+    "Stock Ledger Entry": {
-------+        "validate": "business_needed_solutions.business_needed_solutions.overrides.warehouse_negative_stock.validate_sle_warehouse_negative_stock"
-------+    },
-------     "Stock Entry": {
-------         "on_submit": "business_needed_solutions.business_needed_solutions.overrides.submission_restriction.validate_submission_permission"
-------     },
-------@@ -346,3 +352,6 @@ fixtures = [
------- # Migration hook to ensure BNS settings are applied after migrations
------- after_migrate = "business_needed_solutions.business_needed_solutions.migration.after_migrate"
------- 
-------+# Apply warehouse negative stock restriction patches on app initialization
-------+after_app_init = "business_needed_solutions.business_needed_solutions.overrides.warehouse_negative_stock.apply_patches"
-------+
